{% extends 'base.html' %}

{% block title %}
{%- if view == 'recents' -%}Chats - MV Internal
{%- elif view == 'conversation' -%}Chat - MV Internal
{%- else -%}Chat - MV Internal
{%- endif -%}
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
<!-- Styles moved to chat.css for single source of truth -->
{% endblock %}

{% block content %}
<!-- Chat header bar with project breadcrumb, title dropdown, and share -->
<div class="chat-header-bar" id="chatHeaderBar">
    <div class="chat-header-left">
        <!-- Project link (shown when chat is in a project) -->
        <a href="#" class="chat-project-link" id="chatProjectLink" style="display: none;" onclick="goToProject(event)">
            <span class="project-dot" id="chatProjectDot"></span>
            <span id="chatProjectName">Project</span>
        </a>
        <span class="chat-breadcrumb-separator" id="chatBreadcrumb" style="display: none;">/</span>
        <!-- Chat title with dropdown -->
        <button class="chat-title-dropdown" id="chatTitleDropdown" onclick="openChatMenu(event, currentConversationId, document.getElementById('chatTitleText')?.textContent || 'Chat', true)">
            <span class="chat-title-text" id="chatTitleText">Chat</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </button>
    </div>
    <button class="share-btn" onclick="shareChat()">Share</button>
</div>

<!-- Chats List View - shown only on /chat/recents route -->
{% if view == 'recents' %}
<div class="chats-list-view active" id="chatsListView">
    <div class="chats-list-header">
        <h1 class="chats-list-title">Chats</h1>
        <button class="btn" onclick="createNewConversationFromList()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
            New chat
        </button>
    </div>
    <div class="chats-search-wrapper">
        <input type="text" class="chats-search" id="chatsSearch" placeholder="Search your chats..." oninput="filterChatsList()">
    </div>
    <div class="chats-count-row">
        <span id="chatsCount">0 chats with MV Internal</span>
        <button class="chats-select-btn" onclick="toggleSelectMode()">Select</button>
    </div>
    <div class="chats-select-actions">
        <span class="select-count" id="selectCount">0 selected</span>
        <button class="select-action-btn" onclick="toggleSelectMode()">Cancel</button>
        <button class="select-action-btn danger" onclick="deleteSelectedChats()">Delete</button>
    </div>
    <div class="chats-list" id="chatsList">
        <!-- Chat items loaded dynamically -->
    </div>
</div>
{% endif %}

<!-- New Claude.ai-style chat interface - shown for both new chat and conversation views -->
{% if view == 'new' or view == 'conversation' %}
<main class="claude-main">
    <!-- Welcome Section (shown when no messages) -->
    <div class="claude-welcome" id="chatWelcome">
        <div class="claude-welcome-content">
            <!-- Animated Claude Logo -->
            <div class="claude-logo-section">
                <div class="claude-greeting-text">
                    <div>‚òòÔ∏è Coffee and Maurin?</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Container (hidden initially) -->
    <div class="chat-messages" id="chatMessages"></div>

    <!-- Input Section (always visible) -->
    <div class="claude-input-section">
        <div class="claude-input-wrapper">
            <!-- Main input container -->
            <div class="claude-input-container">
                <div class="claude-input-box" id="chatInputBox">
                    <div class="claude-textarea-wrapper">
                        <textarea
                            id="chatInput"
                            class="claude-textarea"
                            placeholder="How can I help you today?"
                            rows="1"
                        ></textarea>
                    </div>

                    <div class="claude-input-controls">
                        <div class="controls-left">
                            <button type="button" id="attachBtn" class="claude-control-btn" title="Add content">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 3C10.2761 3 10.5 3.22386 10.5 3.5V9.5H16.5L16.6006 9.50977C16.8286 9.55629 17 9.75829 17 10C17 10.2417 16.8286 10.4437 16.6006 10.4902L16.5 10.5H10.5V16.5C10.5 16.7761 10.2761 17 10 17C9.72386 17 9.5 16.7761 9.5 16.5V10.5H3.5C3.22386 10.5 3 10.2761 3 10C3 9.72386 3.22386 9.5 3.5 9.5H9.5V3.5C9.5 3.22386 9.72386 3 10 3Z"></path>
                                </svg>
                            </button>

                            <!-- Attach Dropdown Menu -->
                            <div id="attachDropdown" class="attach-menu-dropdown">
                                <button class="attach-option" data-action="add-to-project" title="Add to project">
                                    <span class="menu-icon">üìÅ</span>
                                    <span>Add to project</span>
                                    <span class="submenu-arrow">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                            <path d="M6 4l4 4-4 4v-8z"/>
                                        </svg>
                                    </span>
                                </button>
                            </div>

                            <!-- Project Submenu -->
                            <div id="projectSubmenu" class="project-submenu">
                                <div id="projectList" class="project-list">
                                    <!-- Projects will be loaded dynamically -->
                                </div>
                                <div class="project-submenu-divider"></div>
                                <button class="project-option create-new" data-action="create-project">
                                    <span class="project-icon">‚ûï</span>
                                    <span>Start a new project</span>
                                </button>
                            </div>
                        </div>

                        <div class="controls-right">
                            <!-- Model Selector -->
                            <div class="claude-model-selector" id="modelSelector">
                                <button type="button" class="claude-model-btn" id="modelSelectorBtn">
                                    <span class="model-name" id="currentModelName">Haiku 4.5</span>
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M14.128 7.16482C14.3126 6.95983 14.6298 6.94336 14.835 7.12771C15.0402 7.31242 15.0567 7.62952 14.8721 7.83477L10.372 12.835L10.2939 12.9053C10.2093 12.9667 10.1063 13 9.99995 13C9.85833 12.9999 9.72264 12.9402 9.62788 12.835L5.12778 7.83477L5.0682 7.75273C4.95072 7.55225 4.98544 7.28926 5.16489 7.12771C5.34445 6.96617 5.60969 6.95939 5.79674 7.09744L5.87193 7.16482L9.99995 11.7519L14.128 7.16482Z"></path>
                                    </svg>
                                </button>

                                <!-- Model Dropdown -->
                                <div class="claude-model-dropdown" id="modelDropdown">
                                    <div class="claude-model-option" data-model="opus-4.5">
                                        <div class="model-info">
                                            <span class="model-option-name">Opus 4.5</span>
                                            <span class="model-option-desc">Most capable for complex work</span>
                                        </div>
                                    </div>
                                    <div class="claude-model-option" data-model="sonnet-4.5">
                                        <div class="model-info">
                                            <span class="model-option-name">Sonnet 4.5</span>
                                            <span class="model-option-desc">Best for everyday tasks</span>
                                        </div>
                                    </div>
                                    <div class="claude-model-option selected" data-model="haiku-4.5">
                                        <div class="model-info">
                                            <span class="model-option-name">Haiku 4.5</span>
                                            <span class="model-option-desc">Fastest for quick answers</span>
                                        </div>
                                        <svg class="model-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="claude-model-option more-models" id="moreModelsBtn">
                                        <span>More models</span>
                                        <svg class="submenu-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                    </div>

                                    <!-- More Models Submenu -->
                                    <div class="claude-more-models-submenu" id="moreModelsSubmenu">
                                        <div class="claude-model-option" data-model="opus-4.1">
                                            <span class="model-option-name">Opus 4.1</span>
                                        </div>
                                        <div class="claude-model-option" data-model="opus-4">
                                            <span class="model-option-name">Opus 4</span>
                                        </div>
                                        <div class="claude-model-option" data-model="sonnet-4">
                                            <span class="model-option-name">Sonnet 4</span>
                                        </div>
                                        <div class="claude-model-option" data-model="opus-3">
                                            <span class="model-option-name">Opus 3</span>
                                        </div>
                                        <div class="claude-model-option" data-model="haiku-3.5">
                                            <span class="model-option-name">Haiku 3.5</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Send Button -->
                            <button type="button" id="sendBtn" class="claude-send-btn" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                                    <path d="M208.49,120.49a12,12,0,0,1-17,0L140,69V216a12,12,0,0,1-24,0V69L64.49,120.49a12,12,0,0,1-17-17l72-72a12,12,0,0,1,17,0l72,72A12,12,0,0,1,208.49,120.49Z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category tabs -->
            <div class="claude-categories">
                <div class="category-buttons">
                    <button class="category-btn" data-category="write">
                        <svg width="16" height="16" viewBox="0 0 256 256" fill="currentColor">
                            <path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.31,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.68,147.31,64l24-24L216,84.68Z"></path>
                        </svg>
                        Write
                    </button>
                    <button class="category-btn" data-category="learn">
                        <svg width="16" height="16" viewBox="0 0 256 256" fill="currentColor">
                            <path d="M251.76,88.94l-120-64a8,8,0,0,0-7.52,0l-120,64a8,8,0,0,0,0,14.12L32,117.87v48.42a15.91,15.91,0,0,0,4.06,10.65C49.16,191.53,78.51,216,128,216a130,130,0,0,0,48-8.76V240a8,8,0,0,0,16,0V199.51a115.63,115.63,0,0,0,27.94-22.57A15.91,15.91,0,0,0,224,166.29V117.87l27.76-14.81a8,8,0,0,0,0-14.12ZM128,200c-43.27,0-68.72-21.14-80-33.71V126.4l76.24,40.66a8,8,0,0,0,7.52,0L176,143.47v46.34C163.4,195.69,147.52,200,128,200Zm80-33.75a97.83,97.83,0,0,1-16,14.25V134.93l16-8.53ZM188,118.94l-.22-.13-56-29.87a8,8,0,0,0-7.52,14.12L171,128l-43,22.93L25,96,128,41.07,231,96Z"></path>
                        </svg>
                        Learn
                    </button>
                    <button class="category-btn" data-category="code">
                        <svg width="16" height="16" viewBox="0 0 256 256" fill="currentColor">
                            <path d="M69.12,94.15,28.5,128l40.62,33.85a8,8,0,1,1-10.24,12.29l-48-40a8,8,0,0,1,0-12.29l48-40a8,8,0,0,1,10.24,12.3Zm176,27.7-48-40a8,8,0,1,0-10.24,12.3L227.5,128l-40.62,33.85a8,8,0,1,0,10.24,12.29l48-40a8,8,0,0,0,0-12.29ZM162.73,32.48a8,8,0,0,0-10.25,4.79l-64,176a8,8,0,0,0,4.79,10.26A8.14,8.14,0,0,0,96,224a8,8,0,0,0,7.52-5.27l64-176A8,8,0,0,0,162.73,32.48Z"></path>
                        </svg>
                        Code
                    </button>
                    <button class="category-btn" data-category="life-stuff">
                        <svg width="16" height="16" viewBox="0 0 256 256" fill="currentColor">
                            <path d="M80,56V24a8,8,0,0,1,16,0V56a8,8,0,0,1-16,0Zm40,8a8,8,0,0,0,8-8V24a8,8,0,0,0-16,0V56A8,8,0,0,0,120,64Zm32,0a8,8,0,0,0,8-8V24a8,8,0,0,0-16,0V56A8,8,0,0,0,152,64Zm96,56v8a40,40,0,0,1-37.51,39.91,96.59,96.59,0,0,1-27,40.09H208a8,8,0,0,1,0,16H32a8,8,0,0,1,0-16H56.54A96.3,96.3,0,0,1,24,136V88a8,8,0,0,1,8-8H208A40,40,0,0,1,248,120ZM200,96H40v40a80.27,80.27,0,0,0,45.12,72h69.76A80.27,80.27,0,0,0,200,136Zm32,24a24,24,0,0,0-16-22.62V136a95.78,95.78,0,0,1-1.2,15A24,24,0,0,0,232,128Z"></path>
                        </svg>
                        Life stuff
                    </button>
                    <button class="category-btn" data-category="claude-choice">
                        <svg width="16" height="16" viewBox="0 0 256 256" fill="currentColor">
                            <path d="M176,232a8,8,0,0,1-8,8H88a8,8,0,0,1,0-16h80A8,8,0,0,1,176,232Zm40-128a87.55,87.55,0,0,1-33.64,69.21A16.24,16.24,0,0,0,176,186v6a16,16,0,0,1-16,16H96a16,16,0,0,1-16-16v-6a16,16,0,0,0-6.23-12.66A87.59,87.59,0,0,1,40,104.49C39.74,56.83,78.26,17.14,125.88,16A88,88,0,0,1,216,104Zm-16,0a72,72,0,0,0-73.74-72c-39,.92-70.47,33.39-70.26,72.39a71.65,71.65,0,0,0,27.64,56.3A32,32,0,0,1,96,186v6h64v-6a32.15,32.15,0,0,1,12.47-25.35A71.65,71.65,0,0,0,200,104Zm-16.11-9.34a57.6,57.6,0,0,0-46.56-46.55,8,8,0,0,0-2.66,15.78c16.57,2.79,30.63,16.85,33.44,33.45A8,8,0,0,0,176,104a9,9,0,0,0,1.35-.11A8,8,0,0,0,183.89,94.66Z"></path>
                        </svg>
                        Claude's choice
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>
{% endif %}


<!-- Video Preview Modal -->
<div class="video-modal" id="videoModal" onclick="closeModal(event)">
    <div class="video-container" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="closePreview()">&times;</button>
        <div class="video-header">
            <span class="video-title" id="previewTitle">Video Preview</span>
            <span class="video-time" id="previewTime"></span>
        </div>
        <video id="previewVideo" controls></video>
    </div>
</div>

<!-- Share Modal -->
<div class="share-modal" id="shareModal" onclick="closeShareModal(event)">
    <div class="share-modal-content" onclick="event.stopPropagation()">
        <h3>
            Share Conversation
            <button class="close-btn" onclick="closeShareModal()">&times;</button>
        </h3>
        <input type="text" class="user-search" id="userSearch" placeholder="Search team members by name or email..." oninput="searchUsers(this.value)">
        <div class="search-results" id="searchResults"></div>
        <div class="participants-list" id="participantsList">
            <h4>Participants</h4>
            <div id="participantsContent">Loading...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Route-based view (set by server)
const CURRENT_VIEW = '{{ view }}';
const CONVERSATION_ID = '{{ conversation_id or "" }}';
const PROJECT_ID = '{{ project_id or "" }}';

const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const conversationsList = document.getElementById('conversationsList');

let history = [];
let clips = [];
let audioClips = [];
let currentAudioPlayer = null;
let lastQuery = '';
let lastScript = '';
let lastModel = '';
let currentConversationId = CONVERSATION_ID || null;
let currentProjectId = null;
let currentProject = null;  // Full project info {id, name, color}
let conversations = {% if conversations is defined %}{{ conversations | tojson | safe }}{% else %}[]{% endif %};

// Select mode state (for list views)
let isSelectMode = false;
let selectedChats = new Set();

// Chat menu state - explicitly on window for guaranteed global access
window.menuChatId = null;
window.menuChatTitle = null;

// Initialize based on route
document.addEventListener('DOMContentLoaded', async () => {
    // Sidebar data is now server-rendered by Jinja - no initial JS load needed

    // Initialize based on current route/view
    if (CURRENT_VIEW === 'recents') {
        // Chats list view - render list
        renderChatsList();
    } else if (CURRENT_VIEW === 'conversation' && CONVERSATION_ID) {
        // Conversation view - load the specific conversation
        await loadConversationData(CONVERSATION_ID);

        // Check for pending message from welcome screen
        const pendingMessage = sessionStorage.getItem('pendingMessage');
        const pendingModel = sessionStorage.getItem('pendingModel');
        if (pendingMessage) {
            sessionStorage.removeItem('pendingMessage');
            sessionStorage.removeItem('pendingModel');

            // Set the model if specified
            if (pendingModel) {
                const modelSelect = document.getElementById('modelSelect');
                if (modelSelect) {
                    modelSelect.value = pendingModel;
                }
            }

            // Auto-send the message
            chatInput.value = pendingMessage;
            setTimeout(() => sendMessage(), 100);
        }
    } else if (CURRENT_VIEW === 'new') {
        // New chat view - set up welcome screen with project context
        setupWelcomeScreen();
    }

    // Initialize project context if specified in URL
    if (PROJECT_ID) {
        await setupProjectContext(PROJECT_ID);
    }
});

// CRITICAL CHAT LIST FUNCTIONS
function renderChatsList() {
    const chatsList = document.getElementById('chatsList');
    const chatsSearch = document.getElementById('chatsSearch');
    const chatsCount = document.getElementById('chatsCount');

    // Only render if elements exist (recents view)
    if (!chatsList) return;

    const searchTerm = chatsSearch ? chatsSearch.value.toLowerCase() : '';

    // Filter out empty chats (message_count === 0) and apply search
    const filteredChats = conversations.filter(conv =>
        conv.message_count > 0 && conv.title.toLowerCase().includes(searchTerm)
    );

    if (chatsCount) {
        chatsCount.textContent = `${filteredChats.length} chat${filteredChats.length !== 1 ? 's' : ''} with MV Internal`;
    }

    chatsList.innerHTML = filteredChats.map(conv => `
        <div class="chat-list-item" data-id="${conv.id}" onclick="openChatFromList('${conv.id}')">
            <input type="checkbox" class="chat-list-checkbox"
                   ${selectedChats.has(conv.id) ? 'checked' : ''}
                   onclick="event.stopPropagation(); toggleChatSelection('${conv.id}')">
            <div class="chat-list-content">
                <div class="chat-list-title">
                    ${conv.starred ? '<span class="chat-star-icon">‚òÖ</span>' : ''}${escapeHtml(conv.title)}
                </div>
                <div class="chat-list-meta">Last message ${timeAgo(conv.updated_at)}</div>
            </div>
            <div class="chat-list-actions">
                <button class="chat-list-action-btn" onclick="event.stopPropagation(); openChatMenu(event, '${conv.id}', '${escapeHtml(conv.title)}')" title="Options">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

function filterChatsList() {
    renderChatsList();
}

function openChatFromList(chatId) {
    window.location.href = `/chat/${chatId}`;
}

function createNewConversationFromList() {
    window.location.href = '/chat';
}

function timeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);

    const intervals = [
        { label: 'year', seconds: 31536000 },
        { label: 'month', seconds: 2592000 },
        { label: 'week', seconds: 604800 },
        { label: 'day', seconds: 86400 },
        { label: 'hour', seconds: 3600 },
        { label: 'minute', seconds: 60 }
    ];

    for (const interval of intervals) {
        const count = Math.floor(seconds / interval.seconds);
        if (count >= 1) {
            return `${count} ${interval.label}${count !== 1 ? 's' : ''} ago`;
        }
    }
    return 'just now';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function toggleSelectMode() {
    isSelectMode = !isSelectMode;
    const chatsListView = document.getElementById('chatsListView');
    if (chatsListView) {
        chatsListView.classList.toggle('select-mode', isSelectMode);
    }
    selectedChats.clear();
    updateSelectCount();
}

function toggleChatSelection(chatId) {
    if (selectedChats.has(chatId)) {
        selectedChats.delete(chatId);
    } else {
        selectedChats.add(chatId);
    }
    updateSelectCount();
}

function updateSelectCount() {
    const selectCount = document.getElementById('selectCount');
    if (selectCount) {
        selectCount.textContent = `${selectedChats.size} selected`;
    }
}

function deleteSelectedChats() {
    if (selectedChats.size === 0) return;

    if (confirm(`Are you sure you want to delete ${selectedChats.size} chat${selectedChats.size !== 1 ? 's' : ''}?`)) {
        // Implementation for bulk delete would go here
        console.log('Deleting chats:', Array.from(selectedChats));
    }
}

// ==========================================
// CHAT MENU FUNCTIONS
// ==========================================

function openChatMenu(event, chatId, chatTitle, fromHeader = false) {
    event.preventDefault();
    event.stopPropagation();

    const menu = document.getElementById('chatMenu');
    if (!menu) return;

    // Toggle off if same chat
    if (menu.classList.contains('open') && window.menuChatId === chatId) {
        closeChatMenu();
        return;
    }

    window.menuChatId = chatId;
    window.menuChatTitle = chatTitle;

    // Update star button based on current state
    const conv = (typeof conversations !== 'undefined' && conversations) ?
        conversations.find(c => c.id === chatId) : null;
    const isStarred = conv ? conv.starred : false;
    const starIcon = document.getElementById('starIcon');
    const starText = document.getElementById('starText');
    if (starIcon && starText) {
        starIcon.textContent = isStarred ? '‚òÖ' : '‚òÜ';
        starText.textContent = isStarred ? 'Unstar' : 'Star';
    }

    // Position the menu
    const rect = event.currentTarget.getBoundingClientRect();

    if (fromHeader) {
        // Below the title button
        menu.style.top = (rect.bottom + 6) + 'px';
        menu.style.left = rect.left + 'px';
    } else {
        // Next to the ‚Ä¢‚Ä¢‚Ä¢ button in chat list
        menu.style.top = rect.top + 'px';
        menu.style.left = (rect.right + 6) + 'px';
    }

    menu.classList.add('open');

    // Adjust if off-screen
    setTimeout(() => {
        const menuRect = menu.getBoundingClientRect();
        if (menuRect.right > window.innerWidth) {
            menu.style.left = (rect.left - menuRect.width - 6) + 'px';
        }
        if (menuRect.bottom > window.innerHeight) {
            menu.style.top = (window.innerHeight - menuRect.height - 10) + 'px';
        }
    }, 0);
}

function closeChatMenu() {
    const menu = document.getElementById('chatMenu');
    if (menu) menu.classList.remove('open');
    window.menuChatId = null;
    window.menuChatTitle = null;
}

function chatMenuAction(action) {
    if (!window.menuChatId) return;

    switch (action) {
        case 'star':
            // Find the conversation to get current starred state
            const conv = (typeof conversations !== 'undefined' && conversations) ?
                conversations.find(c => c.id === window.menuChatId) : null;
            const currentStarred = conv ? conv.starred : false;
            const newStarred = !currentStarred;

            fetch(`/api/conversations/${window.menuChatId}/star`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ starred: newStarred })
            })
            .then(r => {
                if (r.ok) {
                    // Update the conversation in the array if it exists
                    if (conv) {
                        conv.starred = newStarred;
                    }

                    // Re-render the list only if we're on the recents page
                    if (typeof renderChatsList === 'function') {
                        renderChatsList();
                    }

                    showToast(newStarred ? 'Chat starred' : 'Chat unstarred', 'success');
                } else {
                    showToast('Failed to update star', 'error');
                }
            })
            .catch(() => showToast('Failed to update star', 'error'));
            break;

        case 'rename':
            const newName = prompt('Enter new name:', window.menuChatTitle);
            if (newName && newName.trim() && newName !== window.menuChatTitle) {
                fetch(`/api/conversations/${window.menuChatId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newName.trim() })
                })
                .then(r => {
                    if (r.ok) {
                        // Update the chat list item
                        const listItem = document.querySelector(`[data-id="${window.menuChatId}"]`);
                        if (listItem) {
                            const titleEl = listItem.querySelector('.chat-list-title');
                            if (titleEl) titleEl.textContent = newName.trim();
                        }

                        // Update conversations array if it exists
                        if (typeof conversations !== 'undefined' && conversations) {
                            const conv = conversations.find(c => c.id === window.menuChatId);
                            if (conv) {
                                conv.title = newName.trim();
                            }
                        }

                        // Re-render the list only if we're on the recents page
                        if (typeof renderChatsList === 'function') {
                            renderChatsList();
                        }

                        showToast('Chat renamed', 'success');
                    } else {
                        showToast('Failed to rename', 'error');
                    }
                })
                .catch(() => showToast('Failed to rename', 'error'));
            }
            break;

        case 'addToProject':
            showToast('Project picker coming soon', 'info');
            break;

        case 'delete':
            if (confirm(`Delete "${window.menuChatTitle}"?`)) {
                fetch(`/api/conversations/${window.menuChatId}`, { method: 'DELETE' })
                .then(r => {
                    if (r.ok) {
                        // Remove from conversations array if it exists
                        if (typeof conversations !== 'undefined' && conversations) {
                            conversations = conversations.filter(c => c.id !== window.menuChatId);
                        }

                        // Re-render the chat list only if we're on the recents page
                        if (typeof renderChatsList === 'function') {
                            renderChatsList();
                        }

                        showToast('Chat deleted', 'success');
                    } else {
                        showToast('Failed to delete', 'error');
                    }
                })
                .catch(() => showToast('Failed to delete', 'error'));
            }
            break;
    }

    closeChatMenu();
}

// Close menu when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('#chatMenu') && !e.target.closest('.chat-list-action-btn')) {
        closeChatMenu();
    }
});

// Initialize Chat object for Claude.ai interface
if (typeof Chat !== 'undefined') {
    document.addEventListener('DOMContentLoaded', function() {
        Chat.init();
    });
}

// showToast() function available via shared.js

// ==========================================
// CHAT INPUT FUNCTIONALITY
// ==========================================

let currentModel = 'haiku-4.5';

// Initialize chat input functionality
function initializeChatInput() {
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const attachBtn = document.getElementById('attachBtn');
    const modelSelectorBtn = document.getElementById('modelSelectorBtn');
    const modelDropdown = document.getElementById('modelDropdown');
    const moreModelsBtn = document.getElementById('moreModelsBtn');
    const moreModelsSubmenu = document.getElementById('moreModelsSubmenu');

    if (!chatInput || !sendBtn) return;

    // Auto-resize textarea
    function autoResize() {
        chatInput.style.height = '3rem';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 160) + 'px'; // max 10rem
    }

    // Update send button state
    function updateSendButton() {
        const hasText = chatInput.value.trim().length > 0;
        sendBtn.disabled = !hasText;
    }

    // Textarea input handling
    chatInput.addEventListener('input', function() {
        autoResize();
        updateSendButton();
    });

    chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) {
                sendMessage();
            }
        }
    });

    // Send button functionality
    sendBtn.addEventListener('click', sendMessage);

    // Attach button functionality
    if (attachBtn) {
        const attachDropdown = document.getElementById('attachDropdown');

        attachBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const isOpen = attachDropdown.classList.contains('open');
            closeAllDropdowns();
            if (!isOpen) {
                attachDropdown.classList.add('open');
            }
        });
    }


    // Model selector functionality
    if (modelSelectorBtn && modelDropdown) {
        modelSelectorBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const isOpen = modelDropdown.classList.contains('open');
            closeAllDropdowns();
            if (!isOpen) {
                modelDropdown.classList.add('open');
            }
        });

        // Model selection
        modelDropdown.addEventListener('click', function(e) {
            const option = e.target.closest('.claude-model-option');
            if (option && option.dataset.model && !option.classList.contains('more-models')) {
                selectModel(option.dataset.model, option.querySelector('.model-option-name').textContent);
                closeAllDropdowns();
            }
        });

        // More models submenu
        if (moreModelsBtn && moreModelsSubmenu) {
            moreModelsBtn.addEventListener('mouseenter', function() {
                moreModelsSubmenu.classList.add('open');
            });

            moreModelsBtn.addEventListener('mouseleave', function() {
                setTimeout(() => {
                    if (!moreModelsSubmenu.matches(':hover')) {
                        moreModelsSubmenu.classList.remove('open');
                    }
                }, 100);
            });

            moreModelsSubmenu.addEventListener('mouseleave', function() {
                moreModelsSubmenu.classList.remove('open');
            });

            moreModelsSubmenu.addEventListener('click', function(e) {
                const option = e.target.closest('.claude-model-option');
                if (option && option.dataset.model) {
                    selectModel(option.dataset.model, option.querySelector('.model-option-name').textContent);
                    closeAllDropdowns();
                }
            });
        }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', closeAllDropdowns);

    // Initialize send button state
    updateSendButton();
}

function closeAllDropdowns() {
    const modelDropdown = document.getElementById('modelDropdown');
    const moreModelsSubmenu = document.getElementById('moreModelsSubmenu');
    const attachDropdown = document.getElementById('attachDropdown');

    if (modelDropdown) modelDropdown.classList.remove('open');
    if (moreModelsSubmenu) moreModelsSubmenu.classList.remove('open');
    if (attachDropdown) attachDropdown.classList.remove('open');
}

function selectModel(modelId, modelName) {
    currentModel = modelId;
    const currentModelName = document.getElementById('currentModelName');
    if (currentModelName) {
        currentModelName.textContent = modelName;
    }

    // Update selected state
    const allOptions = document.querySelectorAll('.claude-model-option[data-model]');
    allOptions.forEach(option => {
        option.classList.remove('selected');
        const check = option.querySelector('.model-check');
        if (check) check.style.opacity = '0';
    });

    const selectedOption = document.querySelector(`[data-model="${modelId}"]`);
    if (selectedOption) {
        selectedOption.classList.add('selected');
        const check = selectedOption.querySelector('.model-check');
        if (check) check.style.opacity = '1';
    }

    showToast(`Switched to ${modelName}`, 'success');
}

function sendMessage() {
    const chatInput = document.getElementById('chatInput');
    const message = chatInput.value.trim();

    if (!message) return;

    showToast(`Sending message with ${currentModel}...`, 'info');

    // Here you would integrate with your existing chat functionality
    // For now, just clear the input
    chatInput.value = '';
    chatInput.style.height = '3rem';

    const sendBtn = document.getElementById('sendBtn');
    if (sendBtn) sendBtn.disabled = true;
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    initializeChatInput();
    Chat.init(); // Initialize chat functionality including attach button
});
</script>
{% endblock %}