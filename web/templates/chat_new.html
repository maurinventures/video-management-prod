{% extends 'base_new.html' %}

{% block title %}
{%- if view == 'recents' -%}Chats - MV Internal
{%- elif view == 'conversation' -%}Chat - MV Internal
{%- else -%}Chat - MV Internal
{%- endif -%}
{% endblock %}

{% block head %}
<style>
/* Chat-specific styles that aren't shared */
.welcome-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    flex: 1;
    padding: 2rem;
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
}

.welcome-greeting {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 2rem;
}

.welcome-greeting-main {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.welcome-icon {
    width: 32px;
    height: 32px;
    color: var(--color-accent);
}

.welcome-text {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-text);
}

.welcome-project-badge {
    display: none;
    align-items: center;
    gap: 0.5rem;
    background: var(--color-bg-secondary);
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
    border: 1px solid var(--color-border);
    font-size: 0.875rem;
}

.welcome-project-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-accent);
}

.welcome-input-container {
    width: 100%;
    max-width: 500px;
    margin-bottom: 2rem;
}

.welcome-input {
    width: 100%;
    min-height: 60px;
    padding: 1rem;
    border: 2px solid var(--color-border);
    border-radius: 12px;
    font-size: 1rem;
    font-family: inherit;
    resize: none;
    outline: none;
    transition: border-color 0.15s;
}

.welcome-input:focus {
    border-color: var(--color-accent);
}

.welcome-input-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    padding: 0 0.5rem;
}

.welcome-input-actions {
    display: flex;
    gap: 0.5rem;
}

.welcome-action-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    color: var(--color-text-secondary);
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.welcome-action-btn:hover {
    background: var(--color-hover);
    color: var(--color-text);
}

.welcome-model-select {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.welcome-model-select select {
    padding: 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-size: 0.875rem;
    background: white;
}

.welcome-send-btn {
    width: 40px;
    height: 40px;
    background: var(--color-accent);
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.welcome-send-btn:hover {
    background: #c46a4a;
}

.welcome-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: center;
}

.welcome-chip {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    font-size: 0.875rem;
    color: var(--color-text);
    cursor: pointer;
    transition: all 0.15s;
}

.welcome-chip:hover {
    background: var(--color-hover);
    border-color: var(--color-accent);
}

.welcome-chip svg {
    width: 16px;
    height: 16px;
}

/* Chat messages area */
.chat-messages {
    flex: 1;
    padding: 1.5rem;
    padding-bottom: 140px;
    max-width: 768px;
    width: 100%;
    margin: 0 auto;
    box-sizing: border-box;
}

/* Input area */
.input-area {
    position: fixed;
    bottom: 0;
    left: 280px;
    right: 0;
    background: var(--color-bg);
    border-top: 1px solid var(--color-border);
    padding: 1rem;
    z-index: 10;
}

.input-wrap {
    max-width: 768px;
    margin: 0 auto;
}

.model-selector {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
    color: var(--color-text-secondary);
}

.model-select {
    padding: 0.375rem 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-size: 0.8125rem;
    background: white;
}

.input-box {
    display: flex;
    align-items: end;
    gap: 0.75rem;
    background: white;
    border: 2px solid var(--color-border);
    border-radius: 12px;
    padding: 0.75rem;
    transition: border-color 0.15s;
}

.input-box:focus-within {
    border-color: var(--color-accent);
}

.chat-input {
    flex: 1;
    border: none;
    outline: none;
    font-size: 0.9375rem;
    font-family: inherit;
    resize: none;
    min-height: 24px;
    max-height: 120px;
}

.send-btn {
    width: 36px;
    height: 36px;
    background: var(--color-accent);
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
}

.send-btn:hover {
    background: #c46a4a;
}

/* Chat list styles now in components.css - removed to avoid conflicts */

/* Modal styles */
.video-modal, .share-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.video-container, .share-modal-content {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    max-width: 90vw;
    max-height: 90vh;
    overflow: auto;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .input-area {
        left: 0;
    }

    .welcome-chips {
        flex-direction: column;
        align-items: center;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Chat header bar with project breadcrumb, title dropdown, and share -->
<div class="chat-header-bar" id="chatHeaderBar">
    <div class="chat-header-left">
        <!-- Project link (shown when chat is in a project) -->
        <a href="#" class="chat-project-link" id="chatProjectLink" style="display: none;" onclick="goToProject(event)">
            <span class="project-dot" id="chatProjectDot"></span>
            <span id="chatProjectName">Project</span>
        </a>
        <span class="chat-breadcrumb-separator" id="chatBreadcrumb" style="display: none;">/</span>
        <!-- Chat title with dropdown -->
        <button class="chat-title-dropdown" id="chatTitleDropdown" onclick="openChatMenu(event, currentConversationId, document.getElementById('chatTitleText')?.textContent || 'Chat', true)">
            <span class="chat-title-text" id="chatTitleText">Chat</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </button>
    </div>
    <button class="share-btn" onclick="shareChat()">Share</button>
</div>

<!-- Chats List View - shown only on /chat/recents route -->
{% if view == 'recents' %}
<div class="chats-list-view active" id="chatsListView">
    <div class="chats-list-header">
        <h1 class="chats-list-title">Chats</h1>
        <button class="btn" onclick="createNewConversationFromList()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
            New chat
        </button>
    </div>
    <div class="chats-search-wrapper">
        <input type="text" class="chats-search" id="chatsSearch" placeholder="Search your chats..." oninput="filterChatsList()">
    </div>
    <div class="chats-count-row">
        <span id="chatsCount">0 chats with MV Internal</span>
        <button class="chats-select-btn" onclick="toggleSelectMode()">Select</button>
    </div>
    <div class="chats-select-actions">
        <span class="select-count" id="selectCount">0 selected</span>
        <button class="select-action-btn" onclick="toggleSelectMode()">Cancel</button>
        <button class="select-action-btn danger" onclick="deleteSelectedChats()">Delete</button>
    </div>
    <div class="chats-list" id="chatsList">
        <!-- Chat items loaded dynamically -->
    </div>
</div>
{% endif %}

<!-- Chat messages - shown for conversation view -->
{% if view == 'conversation' %}
<div class="chat-messages" id="chatMessages"></div>
{% endif %}

<!-- Welcome screen for new chats - shown for new chat view -->
{% if view == 'new' %}
<div class="welcome-screen" id="welcomeScreen" style="display: flex;">
    <div class="welcome-greeting">
        <div class="welcome-greeting-main">
            <svg class="welcome-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            <span class="welcome-text" id="welcomeText">Good afternoon, {{ user.name or 'User' }}</span>
        </div>
        <div class="welcome-project-badge" id="welcomeProjectBadge">
            <span class="welcome-project-dot" id="welcomeProjectDot"></span>
            <span id="welcomeProjectName">Project Name</span>
        </div>
    </div>

    <div class="welcome-input-container">
        <textarea class="welcome-input" id="welcomeInput" placeholder="What do you want to create?" rows="2" onkeydown="handleWelcomeKeyDown(event)" oninput="autoResizeWelcome(this)"></textarea>
        <div class="welcome-input-footer">
            <div class="welcome-input-actions">
                <button class="welcome-action-btn" title="Attach file">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
                    </svg>
                </button>
            </div>
            <div class="welcome-model-select">
                <select id="welcomeModelSelect">
                    <option value="claude-sonnet" selected>Claude 3.5 Sonnet</option>
                    <option value="claude-opus">Claude 3 Opus</option>
                    <option value="claude-haiku">Claude 3 Haiku</option>
                    <option value="gpt-4o">GPT-4o</option>
                </select>
                <button class="welcome-send-btn" onclick="sendWelcomeMessage()" id="welcomeSendBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="welcome-chips">
        <button class="welcome-chip" onclick="fillWelcomePrompt('Create a 60-second script about leadership')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
            </svg>
            Create a script
        </button>
        <button class="welcome-chip" onclick="fillWelcomePrompt('Find powerful clips about innovation and technology')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
            </svg>
            Find clips
        </button>
        <button class="welcome-chip" onclick="fillWelcomePrompt('What are the most inspiring moments in my video library?')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
            Discover highlights
        </button>
    </div>
</div>
{% endif %}

<!-- Input area - shown for conversation view -->
{% if view == 'conversation' %}
<div class="input-area">
    <div class="input-wrap">
        <div class="model-selector">
            <label>Model:</label>
            <select class="model-select" id="modelSelect">
                <optgroup label="Anthropic (Claude)">
                    <option value="claude-sonnet" selected>Claude 3.5 Sonnet (Recommended)</option>
                    <option value="claude-opus">Claude 3 Opus</option>
                    <option value="claude-haiku">Claude 3 Haiku (Fast)</option>
                </optgroup>
                <optgroup label="OpenAI">
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fast)</option>
                </optgroup>
            </select>
        </div>
        <div class="input-box">
            <textarea class="chat-input" id="chatInput" placeholder="How can I help you?" rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Video Preview Modal -->
<div class="video-modal" id="videoModal" onclick="closeModal(event)">
    <div class="video-container" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="closePreview()">&times;</button>
        <div class="video-header">
            <span class="video-title" id="previewTitle">Video Preview</span>
            <span class="video-time" id="previewTime"></span>
        </div>
        <video id="previewVideo" controls></video>
    </div>
</div>

<!-- Share Modal -->
<div class="share-modal" id="shareModal" onclick="closeShareModal(event)">
    <div class="share-modal-content" onclick="event.stopPropagation()">
        <h3>
            Share Conversation
            <button class="close-btn" onclick="closeShareModal()">&times;</button>
        </h3>
        <input type="text" class="user-search" id="userSearch" placeholder="Search team members by name or email..." oninput="searchUsers(this.value)">
        <div class="search-results" id="searchResults"></div>
        <div class="participants-list" id="participantsList">
            <h4>Participants</h4>
            <div id="participantsContent">Loading...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Route-based view (set by server)
const CURRENT_VIEW = '{{ view }}';
const CONVERSATION_ID = '{{ conversation_id or "" }}';
const PROJECT_ID = '{{ project_id or "" }}';

const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const conversationsList = document.getElementById('conversationsList');

let history = [];
let clips = [];
let audioClips = [];
let currentAudioPlayer = null;
let lastQuery = '';
let lastScript = '';
let lastModel = '';
let currentConversationId = CONVERSATION_ID || null;
let currentProjectId = null;
let currentProject = null;  // Full project info {id, name, color}
let conversations = {% if conversations is defined %}{{ conversations | tojson | safe }}{% else %}[]{% endif %};

// Select mode state (for list views)
let isSelectMode = false;
let selectedChats = new Set();

// Chat menu state - explicitly on window for guaranteed global access
window.menuChatId = null;
window.menuChatTitle = null;

// Initialize based on route
document.addEventListener('DOMContentLoaded', async () => {
    // Sidebar data is now server-rendered by Jinja - no initial JS load needed

    // Initialize based on current route/view
    if (CURRENT_VIEW === 'recents') {
        // Chats list view - render list
        renderChatsList();
    } else if (CURRENT_VIEW === 'conversation' && CONVERSATION_ID) {
        // Conversation view - load the specific conversation
        await loadConversationData(CONVERSATION_ID);

        // Check for pending message from welcome screen
        const pendingMessage = sessionStorage.getItem('pendingMessage');
        const pendingModel = sessionStorage.getItem('pendingModel');
        if (pendingMessage) {
            sessionStorage.removeItem('pendingMessage');
            sessionStorage.removeItem('pendingModel');

            // Set the model if specified
            if (pendingModel) {
                const modelSelect = document.getElementById('modelSelect');
                if (modelSelect) {
                    modelSelect.value = pendingModel;
                }
            }

            // Auto-send the message
            chatInput.value = pendingMessage;
            setTimeout(() => sendMessage(), 100);
        }
    } else if (CURRENT_VIEW === 'new') {
        // New chat view - set up welcome screen with project context
        setupWelcomeScreen();
    }

    // Initialize project context if specified in URL
    if (PROJECT_ID) {
        await setupProjectContext(PROJECT_ID);
    }
});

// CRITICAL CHAT LIST FUNCTIONS
function renderChatsList() {
    const chatsList = document.getElementById('chatsList');
    const chatsSearch = document.getElementById('chatsSearch');
    const chatsCount = document.getElementById('chatsCount');

    // Only render if elements exist (recents view)
    if (!chatsList) return;

    const searchTerm = chatsSearch ? chatsSearch.value.toLowerCase() : '';

    // Filter out empty chats (message_count === 0) and apply search
    const filteredChats = conversations.filter(conv =>
        conv.message_count > 0 && conv.title.toLowerCase().includes(searchTerm)
    );

    if (chatsCount) {
        chatsCount.textContent = `${filteredChats.length} chat${filteredChats.length !== 1 ? 's' : ''} with MV Internal`;
    }

    chatsList.innerHTML = filteredChats.map(conv => `
        <div class="chat-list-item" data-id="${conv.id}" onclick="openChatFromList('${conv.id}')">
            <input type="checkbox" class="chat-list-checkbox"
                   ${selectedChats.has(conv.id) ? 'checked' : ''}
                   onclick="event.stopPropagation(); toggleChatSelection('${conv.id}')">
            <div class="chat-list-content">
                <div class="chat-list-title">
                    ${conv.starred ? '<span class="chat-star-icon">★</span>' : ''}${escapeHtml(conv.title)}
                </div>
                <div class="chat-list-meta">Last message ${timeAgo(conv.updated_at)}</div>
            </div>
            <div class="chat-list-actions">
                <button class="chat-list-action-btn" onclick="event.stopPropagation(); openChatMenu(event, '${conv.id}', '${escapeHtml(conv.title)}')" title="Options">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

function filterChatsList() {
    renderChatsList();
}

function openChatFromList(chatId) {
    window.location.href = `/chat/${chatId}`;
}

function createNewConversationFromList() {
    window.location.href = '/chat';
}

function timeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);

    const intervals = [
        { label: 'year', seconds: 31536000 },
        { label: 'month', seconds: 2592000 },
        { label: 'week', seconds: 604800 },
        { label: 'day', seconds: 86400 },
        { label: 'hour', seconds: 3600 },
        { label: 'minute', seconds: 60 }
    ];

    for (const interval of intervals) {
        const count = Math.floor(seconds / interval.seconds);
        if (count >= 1) {
            return `${count} ${interval.label}${count !== 1 ? 's' : ''} ago`;
        }
    }
    return 'just now';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function toggleSelectMode() {
    isSelectMode = !isSelectMode;
    const chatsListView = document.getElementById('chatsListView');
    if (chatsListView) {
        chatsListView.classList.toggle('select-mode', isSelectMode);
    }
    selectedChats.clear();
    updateSelectCount();
}

function toggleChatSelection(chatId) {
    if (selectedChats.has(chatId)) {
        selectedChats.delete(chatId);
    } else {
        selectedChats.add(chatId);
    }
    updateSelectCount();
}

function updateSelectCount() {
    const selectCount = document.getElementById('selectCount');
    if (selectCount) {
        selectCount.textContent = `${selectedChats.size} selected`;
    }
}

function deleteSelectedChats() {
    if (selectedChats.size === 0) return;

    if (confirm(`Are you sure you want to delete ${selectedChats.size} chat${selectedChats.size !== 1 ? 's' : ''}?`)) {
        // Implementation for bulk delete would go here
        console.log('Deleting chats:', Array.from(selectedChats));
    }
}

// ==========================================
// CHAT MENU FUNCTIONS
// ==========================================

function openChatMenu(event, chatId, chatTitle, fromHeader = false) {
    event.preventDefault();
    event.stopPropagation();

    const menu = document.getElementById('chatMenu');
    if (!menu) return;

    // Toggle off if same chat
    if (menu.classList.contains('open') && window.menuChatId === chatId) {
        closeChatMenu();
        return;
    }

    window.menuChatId = chatId;
    window.menuChatTitle = chatTitle;

    // Update star button based on current state
    const conv = (typeof conversations !== 'undefined' && conversations) ?
        conversations.find(c => c.id === chatId) : null;
    const isStarred = conv ? conv.starred : false;
    const starIcon = document.getElementById('starIcon');
    const starText = document.getElementById('starText');
    if (starIcon && starText) {
        starIcon.textContent = isStarred ? '★' : '☆';
        starText.textContent = isStarred ? 'Unstar' : 'Star';
    }

    // Position the menu
    const rect = event.currentTarget.getBoundingClientRect();

    if (fromHeader) {
        // Below the title button
        menu.style.top = (rect.bottom + 6) + 'px';
        menu.style.left = rect.left + 'px';
    } else {
        // Next to the ••• button in chat list
        menu.style.top = rect.top + 'px';
        menu.style.left = (rect.right + 6) + 'px';
    }

    menu.classList.add('open');

    // Adjust if off-screen
    setTimeout(() => {
        const menuRect = menu.getBoundingClientRect();
        if (menuRect.right > window.innerWidth) {
            menu.style.left = (rect.left - menuRect.width - 6) + 'px';
        }
        if (menuRect.bottom > window.innerHeight) {
            menu.style.top = (window.innerHeight - menuRect.height - 10) + 'px';
        }
    }, 0);
}

function closeChatMenu() {
    const menu = document.getElementById('chatMenu');
    if (menu) menu.classList.remove('open');
    window.menuChatId = null;
    window.menuChatTitle = null;
}

function chatMenuAction(action) {
    if (!window.menuChatId) return;

    switch (action) {
        case 'star':
            // Find the conversation to get current starred state
            const conv = (typeof conversations !== 'undefined' && conversations) ?
                conversations.find(c => c.id === window.menuChatId) : null;
            const currentStarred = conv ? conv.starred : false;
            const newStarred = !currentStarred;

            fetch(`/api/conversations/${window.menuChatId}/star`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ starred: newStarred })
            })
            .then(r => {
                if (r.ok) {
                    // Update the conversation in the array if it exists
                    if (conv) {
                        conv.starred = newStarred;
                    }

                    // Re-render the list only if we're on the recents page
                    if (typeof renderChatsList === 'function') {
                        renderChatsList();
                    }

                    showToast(newStarred ? 'Chat starred' : 'Chat unstarred', 'success');
                } else {
                    showToast('Failed to update star', 'error');
                }
            })
            .catch(() => showToast('Failed to update star', 'error'));
            break;

        case 'rename':
            const newName = prompt('Enter new name:', window.menuChatTitle);
            if (newName && newName.trim() && newName !== window.menuChatTitle) {
                fetch(`/api/conversations/${window.menuChatId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newName.trim() })
                })
                .then(r => {
                    if (r.ok) {
                        // Update the chat list item
                        const listItem = document.querySelector(`[data-id="${window.menuChatId}"]`);
                        if (listItem) {
                            const titleEl = listItem.querySelector('.chat-list-title');
                            if (titleEl) titleEl.textContent = newName.trim();
                        }

                        // Update conversations array if it exists
                        if (typeof conversations !== 'undefined' && conversations) {
                            const conv = conversations.find(c => c.id === window.menuChatId);
                            if (conv) {
                                conv.title = newName.trim();
                            }
                        }

                        // Re-render the list only if we're on the recents page
                        if (typeof renderChatsList === 'function') {
                            renderChatsList();
                        }

                        showToast('Chat renamed', 'success');
                    } else {
                        showToast('Failed to rename', 'error');
                    }
                })
                .catch(() => showToast('Failed to rename', 'error'));
            }
            break;

        case 'addToProject':
            showToast('Project picker coming soon', 'info');
            break;

        case 'delete':
            if (confirm(`Delete "${window.menuChatTitle}"?`)) {
                fetch(`/api/conversations/${window.menuChatId}`, { method: 'DELETE' })
                .then(r => {
                    if (r.ok) {
                        // Remove from conversations array if it exists
                        if (typeof conversations !== 'undefined' && conversations) {
                            conversations = conversations.filter(c => c.id !== window.menuChatId);
                        }

                        // Re-render the chat list only if we're on the recents page
                        if (typeof renderChatsList === 'function') {
                            renderChatsList();
                        }

                        showToast('Chat deleted', 'success');
                    } else {
                        showToast('Failed to delete', 'error');
                    }
                })
                .catch(() => showToast('Failed to delete', 'error'));
            }
            break;
    }

    closeChatMenu();
}

// Close menu when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('#chatMenu') && !e.target.closest('.chat-list-action-btn')) {
        closeChatMenu();
    }
});

// showToast() function available via shared.js
</script>
{% endblock %}