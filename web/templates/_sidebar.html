<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <a href="/chat" class="sidebar-logo">MV Internal</a>
        <button class="sidebar-toggle group" data-action="toggle-sidebar" title="Close sidebar">
            <div class="sidebar-toggle-icon">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M16.5 4C17.3284 4 18 4.67157 18 5.5V14.5C18 15.3284 17.3284 16 16.5 16H3.5C2.67157 16 2 15.3284 2 14.5V5.5C2 4.67157 2.67157 4 3.5 4H16.5ZM7 15H16.5C16.7761 15 17 14.7761 17 14.5V5.5C17 5.22386 16.7761 5 16.5 5H7V15ZM3.5 5C3.22386 5 3 5.22386 3 5.5V14.5C3 14.7761 3.22386 15 3.5 15H6V5H3.5Z"></path>
                </svg>
            </div>
        </button>
    </div>

    <a href="/chat" class="new-chat-btn{% if active_page == 'new_chat' %} active{% endif %}" id="newChatBtn">
        <div class="new-chat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
        </div>
        New chat
    </a>

    <nav class="sidebar-nav">
        <a href="/chat/recents" class="sidebar-nav-item{% if active_page == 'chats' %} active{% endif %}" id="chatsNavItem">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M18 5.5A2.5 2.5 0 0 0 15.5 3h-11A2.5 2.5 0 0 0 2 5.5v7A2.5 2.5 0 0 0 4.5 15H6v2.5a1 1 0 0 0 1.707.707L10.414 15H15.5a2.5 2.5 0 0 0 2.5-2.5v-7Z"/>
            </svg>
            Chats
        </a>
        <a href="/projects" class="sidebar-nav-item{% if active_page == 'projects' %} active{% endif %}">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M2 6a2 2 0 0 1 2-2h5.293a1 1 0 0 1 .707.293L12.414 6H16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Z"/>
            </svg>
            Projects
        </a>
        <div class="sidebar-section-header expanded" id="libraryHeader" data-action="toggle-library">
            <div class="sidebar-section-header-left">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M4 2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H4Zm0 2h12v12H4V4Z"/>
                    <path d="M6 6h8v1H6V6ZM6 8h8v1H6V8ZM6 10h6v1H6v-1Z"/>
                </svg>
                Library
            </div>
            <svg class="sidebar-section-toggle" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M5.293 7.293a1 1 0 0 1 1.414 0L10 10.586l3.293-3.293a1 1 0 1 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 0-1.414Z"/>
            </svg>
        </div>
        <div class="sidebar-section-items expanded" id="librarySection">
            <a href="/videos" class="sidebar-nav-item{% if active_page == 'videos' %} active{% endif %}">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M2 6a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Z"/>
                    <path d="m15 8.69 2.706-1.804A1 1 0 0 1 19 7.694v4.612a1 1 0 0 1-1.294.708L15 11.31V8.69Z"/>
                </svg>
                Videos
            </a>
            <a href="/audio" class="sidebar-nav-item{% if active_page == 'audio' %} active{% endif %}">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M18 3a1 1 0 0 1 1 1v9a4 4 0 1 1-2-3.465V6.234l-10 1.67V16a4 4 0 1 1-2-3.465V5a1 1 0 0 1 .8-0.98l12-2A1 1 0 0 1 18 3Z"/>
                </svg>
                Audio
            </a>
            <a href="/transcripts" class="sidebar-nav-item{% if active_page == 'transcripts' %} active{% endif %}">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M4 2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H4Zm2 4h8v1H6V6Zm0 2h8v1H6V8Zm0 2h6v1H6v-1Zm0 2h4v1H6v-1Z"/>
                </svg>
                Transcripts
            </a>
            <a href="/personas" class="sidebar-nav-item{% if active_page == 'personas' %} active{% endif %}">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.23 1.23 0 0 1 .41-1.412A9.957 9.957 0 0 1 10 10c2.31 0 4.438.784 6.131 2.093.43.333.69.804.468 1.412A8.934 8.934 0 0 1 10 18a8.934 8.934 0 0 1-6.535-3.507Z"/>
                </svg>
                Personas
            </a>
        </div>
    </nav>

    <div class="sidebar-divider"></div>

    <div class="sidebar-section">
        <div class="sidebar-section-title">Recents</div>
    </div>

    <div class="conversations-list" id="conversationsList">
        {% for group in recent_projects %}
        <div class="recents-project-group">
            <div class="recents-project-header expanded" data-action="toggle-recents-project" data-project-id="{{ group.project.id }}">
                <span class="recents-project-dot" style="background: {{ group.project.color }}"></span>
                <span class="recents-project-name">{{ group.project.name }}</span>
                <svg class="recents-project-chevron" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M5.293 7.293a1 1 0 0 1 1.414 0L10 10.586l3.293-3.293a1 1 0 1 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 0-1.414Z"/>
                </svg>
            </div>
            <div class="recents-project-items expanded" id="recents-project-{{ group.project.id }}">
                {% for conv in group.conversations %}
                <div class="conversation-item nested{% if conv.id == conversation_id %} active{% endif %}"
                     data-action="load-conversation"
                     data-conversation-id="{{ conv.id }}"
                     data-id="{{ conv.id }}"
                     data-title="{{ conv.title }}">
                    <div class="conversation-title">
                        {% if conv.starred %}<span class="sidebar-star-icon">★</span>{% endif %}{{ conv.title }}
                    </div>
                    <button class="chat-item-menu" data-action="open-chat-menu" data-conversation-id="{{ conv.id }}" data-title="{{ conv.title|e }}">•••</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% for conv in standalone_chats %}
        <div class="conversation-item{% if conv.id == conversation_id %} active{% endif %}"
             data-action="load-conversation"
             data-conversation-id="{{ conv.id }}"
             data-id="{{ conv.id }}"
             data-title="{{ conv.title }}">
            <div class="conversation-title">
                {% if conv.starred %}<span class="sidebar-star-icon">★</span>{% endif %}{{ conv.title }}
            </div>
            <button class="chat-item-menu" data-action="open-chat-menu" data-conversation-id="{{ conv.id }}" data-title="{{ conv.title|e }}">•••</button>
        </div>
        {% endfor %}
    </div>

    <div class="sidebar-footer" style="position: relative;">
        <div class="user-info">
            <div class="user-avatar">{{ user.name[0].upper() if user and user.name else 'U' }}</div>
            <div class="user-details">
                <span class="user-name">{{ user.name if user and user.name else 'User' }}</span>
            </div>
        </div>
        <button class="user-menu-btn" data-action="toggle-user-menu" title="Menu">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M5.293 7.293a1 1 0 0 1 1.414 0L10 10.586l3.293-3.293a1 1 0 1 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 0-1.414Z"/>
            </svg>
        </button>
        <div class="user-menu-dropdown" id="userMenuDropdown">
            <div class="user-menu-header">
                <div class="user-menu-email">{{ user.email if user and user.email else '' }}</div>
                {% if user and user.is_admin %}
                <span class="user-menu-role">Admin</span>
                {% endif %}
            </div>
            <div class="user-menu-section">
                <a href="/ai-logs" class="user-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    AI Logs
                </a>
            </div>
            {% if user and user.is_admin %}
            <div class="user-menu-section">
                <a href="/admin/invite" class="user-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="8.5" cy="7" r="4"/>
                        <line x1="20" y1="8" x2="20" y2="14"/>
                        <line x1="23" y1="11" x2="17" y2="11"/>
                    </svg>
                    Invite User
                </a>
            </div>
            {% endif %}
            <div class="user-menu-section">
                <a href="/logout" class="user-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Log out
                </a>
            </div>
        </div>
    </div>
</div>