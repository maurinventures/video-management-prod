<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - MV Internal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f5f4ef;
        min-height: 100vh;
        display: flex;
    }

    /* Sidebar styles */
    .sidebar {
        width: 260px;
        background: #faf9f7;
        border-right: 1px solid #e5e4df;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        height: 100vh;
        transition: width 0.2s ease, transform 0.2s ease;
    }

    .sidebar.collapsed {
        width: 0;
        transform: translateX(-260px);
    }

    .sidebar-header {
        padding: 1rem 1rem 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .sidebar-logo {
        font-family: 'EB Garamond', Georgia, serif;
        font-size: 1.25rem;
        font-weight: 500;
        color: #1a1a1a;
        letter-spacing: -0.01em;
    }

    .sidebar-toggle {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        transition: all 0.15s;
    }

    .sidebar-toggle:hover {
        background: #e5e4df;
        color: #1a1a1a;
    }

    .sidebar-toggle svg {
        width: 18px;
        height: 18px;
    }

    /* Floating toggle when collapsed */
    .sidebar-toggle-floating {
        position: fixed;
        top: 1rem;
        left: 1rem;
        width: 36px;
        height: 36px;
        border: 1px solid #e5e4df;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        color: #666;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        z-index: 100;
        transition: all 0.15s;
    }

    .sidebar-toggle-floating:hover {
        background: #f5f4ef;
        color: #1a1a1a;
    }

    .sidebar-toggle-floating svg {
        width: 18px;
        height: 18px;
    }

    .sidebar.collapsed + .chat-main .sidebar-toggle-floating {
        display: flex;
    }

    /* New chat button */
    .new-chat-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        margin: 0 0 0.5rem;
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        border-radius: 6px;
        font-size: 0.875rem;
        color: #444;
        cursor: pointer;
        font-family: inherit;
        transition: background 0.15s;
    }

    .new-chat-btn:hover {
        background: #f5f4ef;
    }

    .new-chat-icon {
        width: 24px;
        height: 24px;
        border: 1.5px solid #888;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .new-chat-icon svg {
        width: 14px;
        height: 14px;
        color: #888;
    }

    .new-chat-btn:hover .new-chat-icon {
        border-color: #1a1a1a;
    }

    .new-chat-btn:hover .new-chat-icon svg {
        color: #1a1a1a;
    }

    /* Sidebar navigation */
    .sidebar-nav {
        padding: 0;
        margin-bottom: 0.5rem;
    }

    .sidebar-nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        border-radius: 0;
        font-size: 0.875rem;
        color: #444;
        cursor: pointer;
        font-family: inherit;
        text-decoration: none;
        transition: all 0.15s;
    }

    .sidebar-nav-item:hover {
        background: #f0efea;
        color: #1a1a1a;
    }

    .sidebar-nav-item.active {
        background: #e5e4df;
        color: #1a1a1a;
    }

    .sidebar-nav-item svg {
        width: 18px;
        height: 18px;
        color: #666;
    }

    .sidebar-nav-item.active svg {
        color: #1a1a1a;
    }

    /* Collapsible section */
    .sidebar-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 1rem;
        margin: 0;
        border-radius: 0;
        cursor: pointer;
        transition: background 0.15s;
    }

    .sidebar-section-header:hover {
        background: #f0efea;
    }

    .sidebar-section-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
        color: #444;
    }

    .sidebar-section-header-left svg {
        width: 18px;
        height: 18px;
        color: #666;
    }

    .sidebar-section-toggle {
        width: 18px;
        height: 18px;
        color: #888;
        transition: transform 0.2s;
    }

    .sidebar-section-header.expanded .sidebar-section-toggle {
        transform: rotate(180deg);
    }

    .sidebar-section-items {
        display: none;
        padding-left: 0;
    }

    .sidebar-section-items.expanded {
        display: block;
    }

    .sidebar-section-items .sidebar-nav-item {
        padding-left: 2.75rem;
        font-size: 0.8125rem;
    }

    .projects-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .project-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem 0.5rem 2.75rem;
        font-size: 0.8125rem;
        color: #444;
        text-decoration: none;
        border-radius: 0;
        cursor: pointer;
        transition: background 0.15s;
    }

    .project-item:hover {
        background: #f0efea;
    }

    .project-color-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .project-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .project-count {
        font-size: 0.75rem;
        color: #888;
    }

    .create-project-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: calc(100% - 3.75rem);
        margin: 0.25rem 1rem 0.25rem 2.75rem;
        padding: 0.5rem 0.75rem;
        background: transparent;
        border: 1px dashed #ccc;
        border-radius: 6px;
        color: #666;
        font-size: 0.8125rem;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.15s;
    }

    .create-project-btn:hover {
        background: #f5f4ef;
        border-color: #d97757;
        color: #d97757;
    }

    .create-project-btn svg {
        width: 14px;
        height: 14px;
    }

    .sidebar-divider {
        height: 1px;
        background: #e5e4df;
        margin: 0.5rem 1rem;
    }

    /* Recents section */
    .sidebar-section {
        padding: 0 1rem;
        margin-bottom: 0.5rem;
    }

    .sidebar-section-title {
        font-size: 0.6875rem;
        font-weight: 600;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .conversations-list {
        flex: 1;
        overflow-y: auto;
        padding: 0 0.5rem;
    }

    .conversation-item {
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 0.125rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.15s;
    }

    .conversation-item:hover {
        background: #f0efea;
    }

    .conversation-item.active {
        background: #e5e4df;
    }

    .conversation-title {
        font-size: 0.8125rem;
        color: #1a1a1a;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }

    .conversation-date {
        display: none;
    }

    .conversation-actions {
        display: none;
        gap: 0.25rem;
    }

    .conversation-item:hover .conversation-actions {
        display: flex;
    }

    .conv-action-btn {
        padding: 0.25rem;
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        border-radius: 4px;
    }

    .conv-action-btn:hover {
        background: #e5e4df;
        color: #1a1a1a;
    }

    .conv-action-btn svg {
        width: 14px;
        height: 14px;
    }

    .sidebar-footer {
        padding: 0.75rem 1rem;
        border-top: 1px solid #e5e4df;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        flex: 1;
        min-width: 0;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #1a1a1a;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8125rem;
        font-weight: 600;
        flex-shrink: 0;
    }

    .user-details {
        min-width: 0;
        flex: 1;
    }

    .user-name {
        font-size: 0.8125rem;
        color: #1a1a1a;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .user-menu-btn {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        transition: all 0.15s;
    }

    .user-menu-btn:hover {
        background: #e5e4df;
        color: #1a1a1a;
    }

    .user-menu-btn svg {
        width: 16px;
        height: 16px;
    }

    /* User dropdown menu - Claude style */
    .user-menu-dropdown {
        position: absolute;
        bottom: 100%;
        left: 0.5rem;
        right: 0.5rem;
        margin-bottom: 0.5rem;
        background: white;
        border: 1px solid #e5e4df;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.12);
        display: none;
        overflow: hidden;
        z-index: 100;
    }

    .user-menu-dropdown.active {
        display: block;
    }

    .user-menu-header {
        padding: 1rem 1rem 0.75rem;
        border-bottom: 1px solid #e5e4df;
    }

    .user-menu-email {
        font-size: 0.875rem;
        color: #666;
        margin-bottom: 0.5rem;
    }

    .user-menu-role {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
        color: #666;
        background: #f5f4ef;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }

    .user-menu-section {
        padding: 0.5rem 0;
    }

    .user-menu-section + .user-menu-section {
        border-top: 1px solid #e5e4df;
    }

    .user-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.625rem 1rem;
        border: none;
        background: none;
        font-size: 0.875rem;
        color: #374151;
        cursor: pointer;
        text-decoration: none;
        font-family: inherit;
        transition: background 0.15s;
    }

    .user-menu-item:hover {
        background: #f5f4ef;
    }

    .user-menu-item svg {
        width: 18px;
        height: 18px;
        color: #666;
    }

    /* Main chat area - full width with scrollbar on window edge */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        position: relative;
        height: 100vh;
    }

    /* Chat header with menu */
    .chat-header {
        position: sticky;
        top: 0;
        right: 0;
        display: flex;
        justify-content: flex-end;
        padding: 0.75rem 1rem;
        background: transparent;
        z-index: 10;
    }

    .chat-menu-container {
        position: relative;
    }

    .chat-menu-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        transition: all 0.15s;
    }

    .chat-menu-btn:hover {
        background: #f0efea;
        color: #1a1a1a;
    }

    .chat-menu-btn svg {
        width: 20px;
        height: 20px;
    }

    .chat-menu-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.25rem;
        background: white;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        min-width: 160px;
        z-index: 100;
        display: none;
        overflow: hidden;
    }

    .chat-menu-dropdown.active {
        display: block;
    }

    .chat-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.75rem 1rem;
        border: none;
        background: none;
        font-size: 0.875rem;
        color: #374151;
        cursor: pointer;
        text-align: left;
        font-family: inherit;
        transition: background 0.15s;
    }

    .chat-menu-item:hover {
        background: #f5f4ef;
    }

    .chat-menu-item svg {
        width: 16px;
        height: 16px;
        color: #666;
    }

    .chat-menu-item.danger {
        color: #dc2626;
    }

    .chat-menu-item.danger svg {
        color: #dc2626;
    }

    .chat-menu-item.danger:hover {
        background: #fef2f2;
    }

    .chat-messages {
        flex: 1;
        padding: 1.5rem;
        padding-bottom: 140px;
        max-width: 768px;
        width: 100%;
        margin: 0 auto;
        box-sizing: border-box;
    }

    .message {
        margin-bottom: 1.5rem;
    }

    /* User messages - right aligned, bubble style */
    .message-user {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1rem;
    }

    .message-user .message-bubble {
        max-width: 70%;
        background: #1a1a1a;
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 18px 18px 4px 18px;
        font-size: 0.9375rem;
        line-height: 1.5;
    }

    .message-user .message-bubble p {
        margin: 0;
    }

    /* Assistant messages - left aligned, full width */
    .message-assistant {
        margin-bottom: 1.5rem;
    }

    .message-assistant .message-body {
        color: #374151;
        line-height: 1.7;
        font-size: 0.9375rem;
    }

    /* Message actions - Claude style */
    .message-actions {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        margin-top: 0.75rem;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .message-assistant:hover .message-actions {
        opacity: 1;
    }

    .message-action-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: none;
        background: transparent;
        color: #888;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
    }

    .message-action-btn:hover {
        background: #f0efea;
        color: #1a1a1a;
    }

    .message-action-btn:active {
        transform: scale(0.95);
    }

    .message-action-btn svg {
        width: 18px;
        height: 18px;
    }

    .message-action-btn.active-good {
        color: #22c55e;
    }

    .message-action-btn.active-bad {
        color: #ef4444;
    }

    .message-action-btn.copied {
        color: #22c55e;
    }

    /* Feedback popup */
    .feedback-popup {
        position: absolute;
        bottom: 100%;
        left: 0;
        margin-bottom: 0.5rem;
        background: white;
        border: 1px solid #e5e4df;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        padding: 1rem;
        width: 400px;
        max-width: calc(100vw - 2rem);
        z-index: 100;
        display: none;
    }

    .feedback-popup.active {
        display: block;
    }

    .feedback-popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .feedback-popup-title {
        font-weight: 600;
        font-size: 0.875rem;
        color: #1a1a1a;
    }

    .feedback-popup-close {
        width: 24px;
        height: 24px;
        border: none;
        background: none;
        color: #888;
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .feedback-popup-close:hover {
        background: #f0efea;
        color: #1a1a1a;
    }

    .feedback-textarea {
        width: 100%;
        min-height: 80px;
        max-height: 300px;
        padding: 0.75rem;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.875rem;
        resize: vertical;
        margin-bottom: 0.75rem;
    }

    .feedback-textarea:focus {
        outline: none;
        border-color: #d97757;
    }

    .feedback-popup-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .feedback-btn-cancel {
        padding: 0.5rem 1rem;
        border: 1px solid #e5e4df;
        background: white;
        border-radius: 6px;
        font-size: 0.8125rem;
        cursor: pointer;
        font-family: inherit;
    }

    .feedback-btn-cancel:hover {
        background: #f0efea;
    }

    .feedback-btn-submit {
        padding: 0.5rem 1rem;
        border: none;
        background: #1a1a1a;
        color: white;
        border-radius: 6px;
        font-size: 0.8125rem;
        cursor: pointer;
        font-family: inherit;
    }

    .feedback-btn-submit:hover {
        background: #333;
    }

    /* Legacy styles - keeping for compatibility */
    .message-header {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        margin-bottom: 0.625rem;
    }

    .avatar {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .avatar-user {
        background: #e5e4df;
        color: #666;
    }

    .avatar-assistant {
        background: #d97757;
        color: white;
    }

    .message-name {
        font-weight: 600;
        font-size: 0.875rem;
        color: #1a1a1a;
    }

    .message-body {
        color: #374151;
        line-height: 1.7;
        font-size: 0.9375rem;
    }

    .message-body p {
        margin-bottom: 0.875rem;
    }

    .message-body p:last-child {
        margin-bottom: 0;
    }

    .message-body ul {
        margin: 0.75rem 0;
        padding-left: 1.25rem;
    }

    .message-body li {
        margin-bottom: 0.375rem;
        color: #555;
    }

    .message-body strong {
        font-weight: 600;
        color: #1a1a1a;
    }

    /* Script output */
    .script-title {
        font-weight: 600;
        font-size: 1.125rem;
        color: #1a1a1a;
        margin: 1rem 0 0.75rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e5e4df;
    }

    /* RECORD sections - narration to record */
    .record-section {
        margin: 1rem 0;
        padding: 0.875rem 1rem;
        padding-right: 3rem;
        background: linear-gradient(135deg, #f8f7f4 0%, #f0efea 100%);
        border: 1px dashed #ccc;
        border-radius: 8px;
        position: relative;
    }

    .record-section::before {
        content: "üé§ RECORD THIS";
        position: absolute;
        top: -10px;
        left: 12px;
        background: #666;
        color: white;
        font-size: 0.625rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .record-section p {
        color: #555;
        font-style: italic;
        font-size: 0.9375rem;
        line-height: 1.6;
        margin: 0;
    }

    .record-section:hover {
        border-color: #999;
    }

    /* Record section hover actions */
    .record-section-actions {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .record-section:hover .record-section-actions {
        opacity: 1;
    }

    .record-section-action {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        background: #e8e7e2;
        color: #666;
    }

    .record-section-action:hover {
        background: #666;
        color: white;
    }

    .record-section-action svg {
        width: 14px;
        height: 14px;
    }

    /* VIDEO sections - actual clips (interactive) */
    .video-clip {
        margin: 1rem 0;
        padding: 0.875rem 1rem;
        padding-right: 3rem;
        background: #fff;
        border-left: 4px solid #d97757;
        border-radius: 0 8px 8px 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        position: relative;
        transition: box-shadow 0.15s;
    }

    .video-clip:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    .video-clip::before {
        content: "üé¨ VIDEO CLIP";
        position: absolute;
        top: -10px;
        left: 12px;
        background: #d97757;
        color: white;
        font-size: 0.625rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .video-clip p {
        color: #1a1a1a;
        font-size: 1rem;
        line-height: 1.6;
        margin: 0;
    }

    .video-clip .speaker {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: #888;
        font-style: normal;
    }

    /* Video clip hover actions */
    .video-clip-actions {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .video-clip:hover .video-clip-actions {
        opacity: 1;
    }

    .video-clip-action {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        background: #f5f4ef;
        color: #666;
    }

    .video-clip-action:hover {
        background: #d97757;
        color: white;
    }

    .video-clip-action svg {
        width: 14px;
        height: 14px;
    }

    .video-clip-action.playing {
        background: #d97757;
        color: white;
    }

    /* AUDIO sections - audio clips from Otter AI */
    .audio-clip {
        margin: 1rem 0;
        padding: 0.875rem 1rem;
        padding-right: 3rem;
        background: #fff;
        border-left: 4px solid #3b82f6;
        border-radius: 0 8px 8px 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        position: relative;
        transition: box-shadow 0.15s;
    }

    .audio-clip:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    .audio-clip::before {
        content: "üéôÔ∏è AUDIO CLIP";
        position: absolute;
        top: -10px;
        left: 12px;
        background: #3b82f6;
        color: white;
        font-size: 0.625rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .audio-clip p {
        color: #1a1a1a;
        font-size: 1rem;
        line-height: 1.6;
        margin: 0;
    }

    .audio-clip .speaker {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: #888;
        font-style: normal;
    }

    .audio-clip .audio-meta {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.5rem;
        font-size: 0.6875rem;
        color: #999;
    }

    .audio-clip .audio-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* Audio clip hover actions */
    .audio-clip-actions {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .audio-clip:hover .audio-clip-actions {
        opacity: 1;
    }

    .audio-clip-action {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        background: #f5f4ef;
        color: #666;
    }

    .audio-clip-action:hover {
        background: #3b82f6;
        color: white;
    }

    .audio-clip-action svg {
        width: 14px;
        height: 14px;
    }

    .audio-clip-action.playing {
        background: #3b82f6;
        color: white;
    }

    /* Audio clips section in response */
    .audio-clips-section {
        margin-top: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e5e4df;
    }

    .audio-clips-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .audio-clips-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
        color: #666;
    }

    .audio-clips-meta strong {
        color: #1a1a1a;
    }

    .audio-clips-list {
        display: none;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 0.5rem;
    }

    .audio-clips-list.open {
        display: flex;
    }

    .audio-item {
        display: flex;
        gap: 0.75rem;
        padding: 0.75rem;
        background: #faf9f7;
        border-radius: 8px;
        border: 1px solid #e5e4df;
        transition: all 0.15s;
    }

    .audio-item:hover {
        border-color: #3b82f6;
        background: #f8fafc;
    }

    .audio-item-play {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #3b82f6;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.15s;
    }

    .audio-item-play:hover {
        background: #2563eb;
        transform: scale(1.05);
    }

    .audio-item-play.playing {
        background: #1d4ed8;
    }

    .audio-item-play svg {
        width: 16px;
        height: 16px;
    }

    .audio-item-content {
        flex: 1;
        min-width: 0;
    }

    .audio-item-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .audio-item-text {
        font-size: 0.8125rem;
        color: #444;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .audio-item-meta {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.375rem;
        font-size: 0.6875rem;
        color: #888;
    }

    /* Legacy support */
    .clip-line {
        background: #faf9f7;
        border-left: 3px solid #d97757;
        padding: 0.75rem 1rem;
        margin: 0.5rem 0;
        border-radius: 0 6px 6px 0;
        font-size: 1rem;
        line-height: 1.6;
        color: #1a1a1a;
    }

    /* Clips section - Compact horizontal layout */
    .clips-section {
        margin-top: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e5e4df;
    }

    .clips-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .clips-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
        color: #666;
    }

    .clips-meta strong {
        color: #1a1a1a;
    }

    .toggle-clips {
        background: none;
        border: 1px solid #e5e4df;
        color: #666;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.6875rem;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.15s;
    }

    .toggle-clips:hover {
        background: #faf9f7;
        color: #1a1a1a;
    }

    .clips-list {
        display: none;
    }

    .clips-list.show {
        display: flex;
        flex-direction: column;
        gap: 1px;
        background: #e5e4df;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 0.5rem;
    }

    /* Compact clip row */
    .clip {
        display: flex;
        align-items: stretch;
        background: #fff;
        min-height: 64px;
    }

    .clip.verified .clip-thumb {
        border-left: 3px solid #22c55e;
    }

    /* Thumbnail container */
    .clip-thumb {
        position: relative;
        width: 100px;
        min-width: 100px;
        background: #1a1a1a;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border-left: 3px solid transparent;
    }

    .clip-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .clip-thumb-placeholder {
        color: #888;
        font-size: 0.625rem;
        text-align: center;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 0.25rem;
    }

    .clip-thumb-placeholder svg {
        width: 20px;
        height: 20px;
        opacity: 0.5;
    }

    .clip-thumb-loading {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .clip-thumb-loading svg {
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        color: #888;
    }

    .clip-thumb-play {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.4);
        opacity: 0;
        transition: opacity 0.15s;
    }

    .clip-thumb:hover .clip-thumb-play {
        opacity: 1;
    }

    .clip-thumb-play svg {
        width: 28px;
        height: 28px;
        color: white;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));
    }

    .clip-thumb-duration {
        position: absolute;
        bottom: 2px;
        right: 2px;
        background: rgba(0,0,0,0.8);
        color: white;
        font-size: 0.5625rem;
        padding: 1px 4px;
        border-radius: 2px;
        font-weight: 500;
        font-family: ui-monospace, monospace;
    }

    /* Clip content */
    .clip-content {
        flex: 1;
        padding: 0.5rem 0.75rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-width: 0;
        gap: 0.25rem;
    }

    .clip-top {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.6875rem;
    }

    .clip-num {
        font-weight: 700;
        color: #d97757;
        flex-shrink: 0;
    }

    .clip-title {
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .clip-verified {
        font-size: 0.5625rem;
        padding: 1px 4px;
        background: #dcfce7;
        color: #15803d;
        border-radius: 2px;
        font-weight: 600;
        text-transform: uppercase;
        flex-shrink: 0;
    }

    .clip-quote {
        font-size: 0.8125rem;
        color: #1a1a1a;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin: 0;
    }

    .clip-quote-full {
        display: none;
        position: absolute;
        left: 100px;
        right: 0;
        top: 100%;
        background: #fff;
        border: 1px solid #e5e4df;
        border-radius: 6px;
        padding: 0.75rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10;
        font-size: 0.8125rem;
        line-height: 1.5;
        color: #1a1a1a;
    }

    .clip:hover .clip-quote-full {
        display: block;
    }

    /* Compact action buttons */
    .clip-actions {
        display: flex;
        align-items: center;
        gap: 2px;
        padding: 0.5rem;
        flex-shrink: 0;
    }

    .clip-action {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s;
        position: relative;
    }

    .clip-action svg {
        width: 14px;
        height: 14px;
    }

    .clip-action-primary {
        background: #d97757;
        color: white;
    }

    .clip-action-primary:hover {
        background: #c56646;
    }

    .clip-action-secondary {
        background: #f5f4ef;
        color: #666;
    }

    .clip-action-secondary:hover {
        background: #e5e4df;
        color: #1a1a1a;
    }

    .clip-action:disabled {
        opacity: 0.5;
        cursor: wait;
    }

    .clip-action-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1a1a1a;
        color: white;
        font-size: 0.625rem;
        padding: 2px 6px;
        border-radius: 3px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s;
        margin-bottom: 4px;
    }

    .clip-action:hover .clip-action-tooltip {
        opacity: 1;
    }

    /* Loading spinner for actions */
    .clip-action svg.spin {
        animation: spin 1s linear infinite;
    }

    /* Edit button for transcript */
    .clip-edit-btn {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        padding: 2px;
        border-radius: 3px;
        display: inline-flex;
        align-items: center;
        margin-left: auto;
        opacity: 0;
        transition: opacity 0.15s, color 0.15s;
    }

    .clip:hover .clip-edit-btn {
        opacity: 1;
    }

    .clip-edit-btn:hover {
        color: #d97757;
        background: #f5f4ef;
    }

    /* Editable quote styles */
    .clip-quote-editing {
        background: white;
        border: 2px solid #d97757;
        border-radius: 4px;
        padding: 0.5rem;
        font-size: 0.8125rem;
        line-height: 1.4;
        width: 100%;
        min-height: 60px;
        resize: vertical;
        font-family: inherit;
    }

    .clip-quote-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .clip-quote-save, .clip-quote-cancel {
        padding: 0.25rem 0.5rem;
        font-size: 0.6875rem;
        border-radius: 4px;
        cursor: pointer;
        font-family: inherit;
        border: none;
    }

    .clip-quote-save {
        background: #d97757;
        color: white;
    }

    .clip-quote-save:hover {
        background: #c56646;
    }

    .clip-quote-cancel {
        background: #e5e4df;
        color: #666;
    }

    .clip-quote-cancel:hover {
        background: #d5d4cf;
    }

    .export-btn {
        margin-top: 0.75rem;
        width: 100%;
        padding: 0.625rem;
        background: #1a1a1a;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.8125rem;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
    }

    .export-btn:hover {
        background: #333;
    }

    .preview-btn {
        padding: 0.375rem 0.75rem;
        background: #d97757;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .preview-btn:hover {
        background: #c56646;
    }

    .preview-btn svg {
        width: 12px;
        height: 12px;
    }

    .download-btn {
        padding: 0.375rem 0.75rem;
        background: #1a1a1a;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .download-btn:hover {
        background: #333;
    }

    .download-btn:disabled {
        background: #999;
        cursor: wait;
    }

    .download-btn svg {
        width: 12px;
        height: 12px;
    }

    .download-btn svg.spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Video modal */
    .video-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .video-modal.show {
        display: flex;
    }

    .video-container {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
    }

    .video-container video {
        max-width: 100%;
        max-height: 80vh;
        border-radius: 8px;
    }

    .video-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        color: white;
    }

    .video-title {
        font-weight: 600;
        font-size: 0.875rem;
    }

    .video-time {
        font-size: 0.75rem;
        color: #999;
    }

    .close-modal {
        position: absolute;
        top: -2.5rem;
        right: 0;
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
    }

    .close-modal:hover {
        color: #d97757;
    }

    /* Input area */
    .input-area {
        position: fixed;
        bottom: 0;
        left: 280px;  /* Align with sidebar width */
        right: 0;
        background: #f5f4ef;
        border-top: 1px solid #e5e4df;
        padding: 1rem;
    }

    .input-wrap {
        max-width: 768px;
        width: 100%;
        margin: 0 auto;
        padding: 0 1.5rem;
        box-sizing: border-box;
    }

    .input-box {
        display: flex;
        align-items: center;
        background: #fff;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        overflow: hidden;
    }

    .input-box:focus-within {
        border-color: #d97757;
    }

    .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: none;
        font-size: 0.9375rem;
        color: #1a1a1a;
        background: transparent;
        outline: none;
        font-family: inherit;
        resize: none;
        min-height: 24px;
        max-height: 200px;
        line-height: 1.5;
        overflow-y: auto;
    }

    .chat-input::placeholder {
        color: #999;
    }

    .input-box {
        align-items: flex-end;
    }

    .send-btn {
        padding: 0.5rem;
        margin: 0.25rem;
        background: #1a1a1a;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
    }

    .send-btn:hover {
        background: #333;
    }

    .send-btn:disabled {
        background: #e5e4df;
        cursor: not-allowed;
    }

    .send-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Model selector */
    .model-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .model-selector label {
        font-size: 0.75rem;
        color: #888;
        font-weight: 500;
    }

    .model-select {
        padding: 0.375rem 0.75rem;
        border: 1px solid #e5e4df;
        border-radius: 6px;
        background: #fff;
        font-size: 0.75rem;
        color: #444;
        cursor: pointer;
        font-family: inherit;
    }

    .model-select:focus {
        outline: none;
        border-color: #d97757;
    }

    .model-badge {
        font-size: 0.625rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .model-badge.claude {
        background: #d4a574;
        color: white;
    }

    .model-badge.openai {
        background: #10a37f;
        color: white;
    }

    /* Typing */
    .typing {
        display: flex;
        gap: 3px;
    }

    .typing span {
        width: 5px;
        height: 5px;
        background: #999;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing span:nth-child(1) { animation-delay: -0.32s; }
    .typing span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    .context-note {
        font-size: 0.75rem;
        color: #999;
        margin-top: 0.5rem;
    }

    /* Feedback buttons */
    .feedback-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e5e4df;
    }

    .feedback-btn {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.375rem 0.625rem;
        background: none;
        border: 1px solid #e5e4df;
        border-radius: 6px;
        color: #666;
        font-size: 0.75rem;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.15s;
    }

    .feedback-btn:hover {
        background: #faf9f7;
        color: #1a1a1a;
    }

    .feedback-btn.active-good {
        background: #dcfce7;
        border-color: #22c55e;
        color: #15803d;
    }

    .feedback-btn.active-bad {
        background: #fee2e2;
        border-color: #ef4444;
        color: #b91c1c;
    }

    .feedback-btn svg {
        width: 14px;
        height: 14px;
    }

    .feedback-thanks {
        font-size: 0.75rem;
        color: #22c55e;
        margin-left: 0.5rem;
    }

    /* Share modal */
    .share-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .share-modal.show {
        display: flex;
    }

    .share-modal-content {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        width: 100%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .share-modal h3 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .share-modal .close-btn {
        background: none;
        border: none;
        font-size: 1.25rem;
        cursor: pointer;
        color: #666;
    }

    .user-search {
        width: 100%;
        padding: 0.625rem;
        border: 1px solid #e5e4df;
        border-radius: 6px;
        font-size: 0.875rem;
        margin-bottom: 0.75rem;
    }

    .user-search:focus {
        outline: none;
        border-color: #d97757;
    }

    .search-results {
        max-height: 150px;
        overflow-y: auto;
        margin-bottom: 1rem;
    }

    .search-result {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
    }

    .search-result:hover {
        background: #f5f4ef;
    }

    .search-result-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #d97757;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .search-result-info {
        flex: 1;
    }

    .search-result-name {
        font-size: 0.875rem;
        font-weight: 500;
    }

    .search-result-email {
        font-size: 0.75rem;
        color: #666;
    }

    .participants-list {
        border-top: 1px solid #e5e4df;
        padding-top: 1rem;
    }

    .participants-list h4 {
        font-size: 0.75rem;
        color: #666;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
    }

    .participant-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0;
    }

    .participant-role {
        font-size: 0.625rem;
        background: #e5e4df;
        padding: 1px 6px;
        border-radius: 4px;
        color: #666;
    }

    .participant-role.owner {
        background: #d97757;
        color: white;
    }

    /* Clip comment button */
    .clip-comment-btn {
        position: relative;
    }

    .clip-comment-count {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #d97757;
        color: white;
        font-size: 0.5rem;
        min-width: 14px;
        height: 14px;
        border-radius: 7px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    /* Comment panel */
    .comment-panel {
        position: absolute;
        right: 100%;
        top: 0;
        width: 280px;
        background: white;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 20;
        margin-right: 0.5rem;
        display: none;
    }

    .comment-panel.show {
        display: block;
    }

    .comment-panel-header {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e4df;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .comment-panel-header h4 {
        font-size: 0.8125rem;
        font-weight: 600;
    }

    .comment-panel-close {
        background: none;
        border: none;
        cursor: pointer;
        color: #666;
    }

    .comments-list {
        max-height: 200px;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .comment-item {
        padding: 0.5rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        background: #f5f4ef;
    }

    .comment-author {
        font-size: 0.6875rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .comment-text {
        font-size: 0.75rem;
        color: #444;
        margin-top: 0.25rem;
    }

    .comment-time {
        font-size: 0.625rem;
        color: #888;
        margin-top: 0.25rem;
    }

    .comment-input-area {
        padding: 0.5rem;
        border-top: 1px solid #e5e4df;
    }

    .comment-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #e5e4df;
        border-radius: 6px;
        font-size: 0.75rem;
        resize: none;
        font-family: inherit;
    }

    .comment-input:focus {
        outline: none;
        border-color: #d97757;
    }

    .comment-hint {
        font-size: 0.625rem;
        color: #888;
        margin-top: 0.25rem;
    }

    /* Regenerate button */
    .clip-action.regenerate {
        background: #f0efea;
        color: #666;
    }

    .clip-action.regenerate:hover {
        background: #d97757;
        color: white;
    }

    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e5e4df;
    }

    .modal-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .modal-close {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        border-radius: 6px;
        color: #666;
        cursor: pointer;
        transition: all 0.15s;
    }

    .modal-close:hover {
        background: #f5f4ef;
        color: #1a1a1a;
    }

    .modal-close svg {
        width: 20px;
        height: 20px;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #444;
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-family: inherit;
        transition: border-color 0.15s;
    }

    .form-input:focus {
        outline: none;
        border-color: #d97757;
    }

    .form-textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-family: inherit;
        resize: vertical;
        min-height: 80px;
        transition: border-color 0.15s;
    }

    .form-textarea:focus {
        outline: none;
        border-color: #d97757;
    }

    .form-hint {
        font-size: 0.75rem;
        color: #888;
        margin-top: 0.375rem;
    }

    .color-picker {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.15s;
    }

    .color-option:hover {
        transform: scale(1.1);
    }

    .color-option.selected {
        border-color: #1a1a1a;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        border-top: 1px solid #e5e4df;
    }

    .btn {
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.15s;
    }

    .btn-secondary {
        background: #f5f4ef;
        border: 1px solid #e5e4df;
        color: #444;
    }

    .btn-secondary:hover {
        background: #e5e4df;
    }

    .btn-primary {
        background: #d97757;
        border: none;
        color: white;
    }

    .btn-primary:hover {
        background: #c56647;
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
</style>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span class="sidebar-logo">MV Internal</span>
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="Close sidebar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <path d="M9 3v18"/>
            </svg>
        </button>
    </div>

    <button class="new-chat-btn" onclick="createNewConversation()">
        <div class="new-chat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
        </div>
        New chat
    </button>

    <nav class="sidebar-nav">
        <a href="/chat" class="sidebar-nav-item active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            Chats
        </a>
        <div class="sidebar-section-header expanded" onclick="toggleProjectsSection()">
            <div class="sidebar-section-header-left">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
                Projects
            </div>
            <svg class="sidebar-section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="sidebar-section-items expanded" id="projectsSection">
            <div id="projectsList" class="projects-list">
                <!-- Projects loaded dynamically -->
            </div>
            <button class="create-project-btn" onclick="showCreateProjectModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Create project
            </button>
        </div>
        <div class="sidebar-section-header expanded" onclick="toggleLibrarySection()">
            <div class="sidebar-section-header-left">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                Library
            </div>
            <svg class="sidebar-section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="sidebar-section-items expanded" id="librarySection">
            <a href="/videos" class="sidebar-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="23 7 16 12 23 17 23 7"/>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                </svg>
                Videos
            </a>
            <a href="/transcripts" class="sidebar-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                </svg>
                Transcripts
            </a>
            <a href="/personas" class="sidebar-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                Personas
            </a>
        </div>
    </nav>

    <div class="sidebar-divider"></div>

    <div class="sidebar-section">
        <div class="sidebar-section-title">Recents</div>
    </div>

    <div class="conversations-list" id="conversationsList">
        <!-- Conversations loaded dynamically -->
    </div>

    <div class="sidebar-footer" style="position: relative;">
        <div class="user-info">
            <div class="user-avatar">{{ session.get('user_name', 'U')[0].upper() }}</div>
            <div class="user-details">
                <span class="user-name">{{ session.get('user_name', 'User') }}</span>
            </div>
        </div>
        <button class="user-menu-btn" onclick="toggleUserMenu(event)" title="Menu">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </button>
        <div class="user-menu-dropdown" id="userMenuDropdown">
            <div class="user-menu-header">
                <div class="user-menu-email">{{ session.get('user_email', '') }}</div>
                {% if session.get('user_email') in ['joy@maurinventures.com'] %}
                <span class="user-menu-role">Admin</span>
                {% endif %}
            </div>
            <div class="user-menu-section">
                <a href="/ai-logs" class="user-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    AI Logs
                </a>
            </div>
            {% if session.get('user_email') in ['joy@maurinventures.com'] %}
            <div class="user-menu-section">
                <a href="/admin/invite" class="user-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="8.5" cy="7" r="4"/>
                        <line x1="20" y1="8" x2="20" y2="14"/>
                        <line x1="23" y1="11" x2="17" y2="11"/>
                    </svg>
                    Invite User
                </a>
            </div>
            {% endif %}
            <div class="user-menu-section">
                <a href="/logout" class="user-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Log out
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Create Project Modal -->
<div class="modal-overlay" id="createProjectModal" onclick="closeCreateProjectModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 class="modal-title">Create project</h2>
            <button class="modal-close" onclick="closeCreateProjectModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label" for="projectName">Name</label>
                <input type="text" class="form-input" id="projectName" placeholder="e.g., Marketing Campaign Q1">
            </div>
            <div class="form-group">
                <label class="form-label" for="projectDescription">Description (optional)</label>
                <textarea class="form-textarea" id="projectDescription" placeholder="What is this project about?"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="projectInstructions">Custom instructions (optional)</label>
                <textarea class="form-textarea" id="projectInstructions" placeholder="Instructions for the AI when working in this project..."></textarea>
                <div class="form-hint">The AI will follow these instructions for all conversations in this project.</div>
            </div>
            <div class="form-group">
                <label class="form-label">Color</label>
                <div class="color-picker" id="colorPicker">
                    <div class="color-option selected" style="background: #d97757;" data-color="#d97757" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #6366f1;" data-color="#6366f1" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #14b8a6;" data-color="#14b8a6" onclick="selectProjectColor(this)"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateProjectModal()">Cancel</button>
            <button class="btn btn-primary" id="createProjectBtn" onclick="createProject()">Create project</button>
        </div>
    </div>
</div>

<!-- Main Chat Area -->
<div class="chat-main">
    <!-- Floating sidebar toggle (appears when sidebar is collapsed) -->
    <button class="sidebar-toggle-floating" onclick="toggleSidebar()" title="Open sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M9 3v18"/>
        </svg>
    </button>

    <!-- Chat header with menu -->
    <div class="chat-header">
        <div class="chat-menu-container">
            <button class="chat-menu-btn" onclick="toggleChatMenu(event)" title="Chat options">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="5" r="2"/>
                    <circle cx="12" cy="12" r="2"/>
                    <circle cx="12" cy="19" r="2"/>
                </svg>
            </button>
            <div class="chat-menu-dropdown" id="chatMenuDropdown">
                <button class="chat-menu-item" onclick="openShareModal(); closeChatMenu();">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                        <path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"/>
                    </svg>
                    Share
                </button>
                <button class="chat-menu-item" onclick="archiveConversation(); closeChatMenu();">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 8v13H3V8M1 3h22v5H1zM10 12h4"/>
                    </svg>
                    Archive
                </button>
                <button class="chat-menu-item danger" onclick="deleteCurrentConversation(); closeChatMenu();">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                    Delete
                </button>
            </div>
        </div>
    </div>

    <div class="chat-messages" id="chatMessages">
        <div class="message-assistant">
            <div class="message-body">
                <p>I can help you create video scripts from your library of <strong>177 transcribed videos</strong>.</p>
                <p>Tell me what you're looking for:</p>
                <ul>
                    <li>"Create a 60-second script about leadership"</li>
                    <li>"Find powerful clips about space exploration"</li>
                    <li>"What are the most inspiring moments about innovation?"</li>
                </ul>
            </div>
        </div>
    </div>

<div class="input-area">
    <div class="input-wrap">
        <div class="model-selector">
            <label>Model:</label>
            <select class="model-select" id="modelSelect">
                <optgroup label="Anthropic (Claude)">
                    <option value="claude-sonnet" selected>Claude 3.5 Sonnet (Recommended)</option>
                    <option value="claude-opus">Claude 3 Opus</option>
                    <option value="claude-haiku">Claude 3 Haiku (Fast)</option>
                </optgroup>
                <optgroup label="OpenAI">
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fast)</option>
                </optgroup>
            </select>
        </div>
        <div class="input-box">
            <textarea class="chat-input" id="chatInput" placeholder="What kind of script do you want to create?" rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
            </button>
        </div>
    </div>
</div>
</div> <!-- Close chat-main -->

<!-- Video Preview Modal -->
<div class="video-modal" id="videoModal" onclick="closeModal(event)">
    <div class="video-container" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="closePreview()">&times;</button>
        <div class="video-header">
            <span class="video-title" id="previewTitle">Video Preview</span>
            <span class="video-time" id="previewTime"></span>
        </div>
        <video id="previewVideo" controls></video>
    </div>
</div>

<!-- Share Modal -->
<div class="share-modal" id="shareModal" onclick="closeShareModal(event)">
    <div class="share-modal-content" onclick="event.stopPropagation()">
        <h3>
            Share Conversation
            <button class="close-btn" onclick="closeShareModal()">&times;</button>
        </h3>
        <input type="text" class="user-search" id="userSearch" placeholder="Search team members by name or email..." oninput="searchUsers(this.value)">
        <div class="search-results" id="searchResults"></div>
        <div class="participants-list" id="participantsList">
            <h4>Participants</h4>
            <div id="participantsContent">Loading...</div>
        </div>
    </div>
</div>

<script>
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const conversationsList = document.getElementById('conversationsList');

let history = [];
let clips = [];
let audioClips = [];
let currentAudioPlayer = null;
let lastQuery = '';
let lastScript = '';
let lastModel = '';
let currentConversationId = null;
let currentProjectId = null;
let conversations = [];

// Load conversations and projects on page load
document.addEventListener('DOMContentLoaded', () => {
    loadConversations();
    loadProjects();
});

async function loadConversations() {
    try {
        const res = await fetch('/api/conversations');
        const data = await res.json();
        conversations = data.conversations || [];
        renderConversations();

        // Check for URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const projectParam = urlParams.get('project');
        const conversationParam = urlParams.get('conversation');

        if (conversationParam) {
            // Load specific conversation
            await loadConversation(conversationParam);
        } else if (projectParam) {
            // Create new conversation in project
            await createNewConversation(projectParam);
        } else if (conversations.length === 0) {
            // Auto-create a new conversation if none exist
            await createNewConversation();
        } else {
            // Load the most recent conversation
            await loadConversation(conversations[0].id);
        }
    } catch (e) {
        console.error('Failed to load conversations:', e);
    }
}

function renderConversations() {
    conversationsList.innerHTML = conversations.map(conv => `
        <div class="conversation-item ${conv.id === currentConversationId ? 'active' : ''}"
             onclick="loadConversation('${conv.id}')"
             data-id="${conv.id}">
            <div style="flex: 1; min-width: 0;">
                <div class="conversation-title">${escapeHtml(conv.title)}</div>
                <div class="conversation-date">${formatDate(conv.updated_at)}</div>
            </div>
            <div class="conversation-actions">
                <button class="conv-action-btn" onclick="event.stopPropagation(); renameConversation('${conv.id}')" title="Rename">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
                <button class="conv-action-btn" onclick="event.stopPropagation(); deleteConversation('${conv.id}')" title="Delete">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
            </div>
        </div>
    `).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;

    if (diff < 60000) return 'Just now';
    if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
    if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
    return date.toLocaleDateString();
}

async function createNewConversation(projectId = null) {
    try {
        const body = { title: 'New Chat' };
        if (projectId) {
            body.project_id = projectId;
        }

        const res = await fetch('/api/conversations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await res.json();

        // Add to list and select
        conversations.unshift({
            id: data.id,
            title: data.title,
            updated_at: data.created_at,
            message_count: 0,
            project_id: data.project_id
        });

        currentConversationId = data.id;
        currentProjectId = data.project_id || null;
        history = [];
        clips = [];
        renderConversations();
        clearChat();

        // Clear project param from URL
        if (window.location.search.includes('project=')) {
            window.history.replaceState({}, '', '/chat');
        }
    } catch (e) {
        console.error('Failed to create conversation:', e);
    }
}

async function loadConversation(conversationId) {
    try {
        const res = await fetch(`/api/conversations/${conversationId}`);
        const data = await res.json();

        currentConversationId = conversationId;
        history = [];
        clips = [];
        renderConversations();
        clearChat();

        // Load messages
        for (const msg of data.messages) {
            if (msg.role === 'user') {
                addMsg(msg.content, true);
                history.push({ role: 'user', content: msg.content });
            } else {
                addMsg(msg.content, false, msg.clips || [], 0);
                history.push({ role: 'assistant', content: msg.content });
                if (msg.clips && msg.clips.length > 0) {
                    clips = msg.clips;
                }
            }
        }
    } catch (e) {
        console.error('Failed to load conversation:', e);
    }
}

async function renameConversation(conversationId) {
    const conv = conversations.find(c => c.id === conversationId);
    const newTitle = prompt('Rename conversation:', conv?.title || 'New Chat');
    if (!newTitle) return;

    try {
        await fetch(`/api/conversations/${conversationId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle })
        });

        // Update local state
        const idx = conversations.findIndex(c => c.id === conversationId);
        if (idx >= 0) {
            conversations[idx].title = newTitle;
            renderConversations();
        }
    } catch (e) {
        console.error('Failed to rename:', e);
    }
}

async function deleteConversation(conversationId) {
    if (!confirm('Delete this conversation?')) return;

    try {
        await fetch(`/api/conversations/${conversationId}`, {
            method: 'DELETE'
        });

        // Remove from list
        conversations = conversations.filter(c => c.id !== conversationId);
        renderConversations();

        // If deleted current, load another or create new
        if (currentConversationId === conversationId) {
            if (conversations.length > 0) {
                await loadConversation(conversations[0].id);
            } else {
                await createNewConversation();
            }
        }
    } catch (e) {
        console.error('Failed to delete:', e);
    }
}

function clearChat() {
    chatMessages.innerHTML = `
        <div class="message-assistant">
            <div class="message-body">
                <p>I can help you create video scripts from your library of <strong>177 transcribed videos</strong>.</p>
                <p>Tell me what you're looking for:</p>
                <ul>
                    <li>"Create a 60-second script about leadership"</li>
                    <li>"Find powerful clips about space exploration"</li>
                    <li>"What are the most inspiring moments about innovation?"</li>
                </ul>
            </div>
        </div>
    `;
}

function format(text) {
    // Remove JSON blocks and cleanup
    text = text.replace(/```json[\s\S]*?```/g, '');
    text = text.replace(/---/g, '');
    text = text.replace(/Why this works:[\s\S]*?(?=\n\n|$)/gi, '');
    text = text.replace(/Then provide JSON[\s\S]*?(?=\n\n|$)/gi, '');

    // Format script with title
    text = text.replace(/\*\*\[(.*?)\]\*\*/g, '<div class="script-title">$1</div>');

    // Format RECORD sections (narration to record) with interactive buttons
    // Track record index for actions
    let recordIdx = 0;

    text = text.replace(/\[RECORD:\s*(.*?)\]/g, (match, content) => {
        const idx = recordIdx++;
        return `<div class="record-section" data-record-idx="${idx}">
            <p>${content}</p>
            <div class="record-section-actions">
                <button class="record-section-action" onclick="regenerateRecord(${idx})" title="Regenerate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                </button>
                <button class="record-section-action" onclick="commentRecord(${idx})" title="Comment">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>
        </div>`;
    });
    text = text.replace(/\[VOICEOVER:\s*(.*?)\]/g, (match, content) => {
        const idx = recordIdx++;
        return `<div class="record-section" data-record-idx="${idx}">
            <p>${content}</p>
            <div class="record-section-actions">
                <button class="record-section-action" onclick="regenerateRecord(${idx})" title="Regenerate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                </button>
                <button class="record-section-action" onclick="commentRecord(${idx})" title="Comment">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>
        </div>`;
    });
    text = text.replace(/\[NARRATE:\s*(.*?)\]/g, (match, content) => {
        const idx = recordIdx++;
        return `<div class="record-section" data-record-idx="${idx}">
            <p>${content}</p>
            <div class="record-section-actions">
                <button class="record-section-action" onclick="regenerateRecord(${idx})" title="Regenerate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                </button>
                <button class="record-section-action" onclick="commentRecord(${idx})" title="Comment">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>
        </div>`;
    });

    // Format VIDEO sections with interactive buttons
    // Track clip index for matching with clips array
    let clipIdx = 0;

    // With speaker
    text = text.replace(/\[VIDEO:\s*"(.*?)"\s*‚Äî\s*(.*?)\]/gs, (match, quote, speaker) => {
        const idx = clipIdx++;
        return `<div class="video-clip" data-clip-idx="${idx}">
            <p>"${quote}"</p>
            <span class="speaker">‚Äî ${speaker}</span>
            <div class="video-clip-actions">
                <button class="video-clip-action" onclick="playScriptClip(${idx})" title="Preview">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button class="video-clip-action" onclick="regenerateScriptClip(${idx})" title="Find alternative">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                </button>
                <button class="video-clip-action" onclick="commentScriptClip(${idx})" title="Comment">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>
        </div>`;
    });

    // Without speaker
    text = text.replace(/\[VIDEO:\s*"(.*?)"\]/gs, (match, quote) => {
        const idx = clipIdx++;
        return `<div class="video-clip" data-clip-idx="${idx}">
            <p>"${quote}"</p>
            <div class="video-clip-actions">
                <button class="video-clip-action" onclick="playScriptClip(${idx})" title="Preview">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button class="video-clip-action" onclick="regenerateScriptClip(${idx})" title="Find alternative">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                </button>
                <button class="video-clip-action" onclick="commentScriptClip(${idx})" title="Comment">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>
        </div>`;
    });

    // Legacy CLIP format
    text = text.replace(/\[CLIP\s*\d*:\s*"(.*?)"\]/gs, (match, quote) => {
        const idx = clipIdx++;
        return `<div class="video-clip" data-clip-idx="${idx}">
            <p>"${quote}"</p>
            <div class="video-clip-actions">
                <button class="video-clip-action" onclick="playScriptClip(${idx})" title="Preview">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button class="video-clip-action" onclick="regenerateScriptClip(${idx})" title="Find alternative">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                </button>
                <button class="video-clip-action" onclick="commentScriptClip(${idx})" title="Comment">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>
        </div>`;
    });

    // Bold and italic
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

    // Clean up extra whitespace
    text = text.replace(/\n{3,}/g, '\n\n');

    const paras = text.split('\n\n').filter(p => p.trim());
    return paras.map(p => {
        if (p.includes('script-title') || p.includes('narration') || p.includes('clip-line') || p.includes('video-clip')) return p;
        return `<p>${p.replace(/\n/g, '<br>')}</p>`;
    }).join('');
}

function addMsg(content, isUser, clipData = [], ctx = 0, audioClipData = []) {
    const div = document.createElement('div');
    const msgId = 'msg-' + Date.now();

    if (isUser) {
        // User message - right aligned bubble
        div.className = 'message-user';
        div.innerHTML = `<div class="message-bubble">${format(content)}</div>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return;
    }

    // Assistant message - left aligned, full width
    div.className = 'message-assistant';
    div.id = msgId;

    let html = `<div class="message-body">${format(content)}`;

    if (!isUser && clipData.length > 0) {
        clips = clipData;
        const dur = clipData.reduce((s, c) => s + (c.duration || c.end_time - c.start_time), 0);
        const verified = clipData.filter(c => c.verified).length;
        const id = 'clips-' + Date.now();

        html += `<div class="clips-section">
            <div class="clips-header">
                <div class="clips-meta">
                    <span><strong>${clipData.length}</strong> clips</span>
                    <span><strong>${dur.toFixed(0)}s</strong> total</span>
                    <span><strong>${verified}/${clipData.length}</strong> verified</span>
                </div>
                <button class="toggle-clips" onclick="toggle('${id}', this)">Show clips</button>
            </div>
            <div id="${id}" class="clips-list">`;

        clipData.forEach((c, i) => {
            const d = c.duration || c.end_time - c.start_time;
            const displayText = (c.text || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const displayTitle = (c.video_title || 'Unknown').replace(/"/g, '&quot;');
            const shortTitle = displayTitle.length > 35 ? displayTitle.substring(0, 35) + '...' : displayTitle;
            const thumbUrl = `/api/video-thumbnail/${c.video_id}?time=${c.start_time || 0}`;

            html += `
                <div class="clip ${c.verified ? 'verified' : ''}" style="position:relative;">
                    <div class="clip-thumb" onclick="previewClipByIndex(${i})" title="Preview clip">
                        <div class="clip-thumb-loading" id="thumb-loading-${i}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/></svg>
                        </div>
                        <img src="${thumbUrl}" alt="" style="display:none;" onload="this.style.display='block';document.getElementById('thumb-loading-${i}').style.display='none';" onerror="this.style.display='none';document.getElementById('thumb-loading-${i}').innerHTML='<svg viewBox=\\'0 0 24 24\\' fill=\\'currentColor\\' style=\\'opacity:0.3\\'><path d=\\'M4 4h16v16H4z\\'/><path d=\\'M10 9l5 3-5 3z\\' fill=\\'#1a1a1a\\'/></svg>';">
                        <div class="clip-thumb-play">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        </div>
                        <span class="clip-thumb-duration">${d.toFixed(1)}s</span>
                    </div>
                    <div class="clip-content">
                        <div class="clip-top">
                            <span class="clip-num">#${i + 1}</span>
                            <span class="clip-title">${shortTitle}</span>
                            ${c.verified ? '<span class="clip-verified">Verified</span>' : ''}
                            <button class="clip-edit-btn" onclick="editClipText(${i}, this)" title="Edit transcript">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                        </div>
                        <p class="clip-quote" data-clip-index="${i}">"${displayText}"</p>
                    </div>
                    <div class="clip-actions">
                        <button class="clip-action clip-action-primary" onclick="previewClipByIndex(${i})" title="Preview">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                            <span class="clip-action-tooltip">Preview</span>
                        </button>
                        <button class="clip-action clip-action-secondary" onclick="downloadClipByIndex(${i}, this)" title="Download clip">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                            <span class="clip-action-tooltip">Download</span>
                        </button>
                        <button class="clip-action clip-action-secondary" onclick="downloadFullVideo('${c.video_id}', this)" title="Download full source video">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M10 9l5 3-5 3z"/></svg>
                            <span class="clip-action-tooltip">Full Video</span>
                        </button>
                    </div>
                </div>`;
        });

        html += `</div><button class="export-btn" onclick="exportScript()">Export Script</button></div>`;
    }

    // Add audio clips section
    if (!isUser && audioClipData && audioClipData.length > 0) {
        audioClips = audioClipData;
        const totalDur = audioClipData.reduce((s, c) => s + (c.duration || 0), 0);
        const audioId = 'audio-clips-' + Date.now();

        html += `<div class="audio-clips-section">
            <div class="audio-clips-header">
                <div class="audio-clips-meta">
                    <span><strong>${audioClipData.length}</strong> audio clips</span>
                    <span><strong>${totalDur.toFixed(0)}s</strong> total</span>
                </div>
                <button class="toggle-clips" onclick="toggleAudioClips('${audioId}', this)">Show audio</button>
            </div>
            <div id="${audioId}" class="audio-clips-list">`;

        audioClipData.forEach((a, i) => {
            const displayText = (a.text || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const displayTitle = (a.audio_title || a.title || 'Unknown Recording').replace(/"/g, '&quot;');
            const shortTitle = displayTitle.length > 40 ? displayTitle.substring(0, 40) + '...' : displayTitle;
            const duration = a.duration ? a.duration.toFixed(1) + 's' : '';
            const speaker = a.speaker || '';

            html += `
                <div class="audio-item" data-audio-idx="${i}">
                    <button class="audio-item-play" onclick="playAudioClip(${i})" title="Play audio">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <div class="audio-item-content">
                        <div class="audio-item-title">${shortTitle}</div>
                        <p class="audio-item-text">"${displayText}"</p>
                        <div class="audio-item-meta">
                            ${speaker ? `<span>üéôÔ∏è ${speaker}</span>` : ''}
                            ${duration ? `<span>‚è±Ô∏è ${duration}</span>` : ''}
                            ${a.score ? `<span>üìä ${(a.score * 100).toFixed(0)}% match</span>` : ''}
                        </div>
                    </div>
                </div>`;
        });

        html += `</div></div>`;
    }

    if (!isUser && ctx > 0) {
        html += `<div class="context-note">Searched ${ctx.toLocaleString()} segments</div>`;
    }

    // Add message action buttons for all assistant messages
    const feedbackId = 'feedback-' + Date.now();
    const hasClips = clipData.length > 0;
    html += `</div>
        <div class="message-actions" style="position: relative;">
            <button class="message-action-btn" onclick="copyMessageContent('${msgId}')" title="Copy">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M12.5 3C13.3284 3 14 3.67157 14 4.5V6H15.5C16.3284 6 17 6.67157 17 7.5V15.5C17 16.3284 16.3284 17 15.5 17H7.5C6.67157 17 6 16.3284 6 15.5V14H4.5C3.67157 14 3 13.3284 3 12.5V4.5C3 3.67157 3.67157 3 4.5 3H12.5ZM14 12.5C14 13.3284 13.3284 14 12.5 14H7V15.5C7 15.7761 7.22386 16 7.5 16H15.5C15.7761 16 16 15.7761 16 15.5V7.5C16 7.22386 15.7761 7 15.5 7H14V12.5ZM4.5 4C4.22386 4 4 4.22386 4 4.5V12.5C4 12.7761 4.22386 13 4.5 13H12.5C12.7761 13 13 12.7761 13 12.5V4.5C13 4.22386 12.7761 4 12.5 4H4.5Z"/>
                </svg>
            </button>
            <button class="message-action-btn" onclick="handleGoodFeedback('${feedbackId}', this)" title="Good response">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9.56055 2C11.1381 2.00009 12.3211 3.44332 12.0117 4.99023L11.6094 7H13.8438C15.5431 7 16.836 8.52594 16.5566 10.2021L15.876 14.2842C15.6148 15.8513 14.2586 17 12.6699 17H4.5C3.67157 17 3 16.3284 3 15.5V9.23828C3.00013 8.57996 3.4294 7.99838 4.05859 7.80469L5.19824 7.4541L5.33789 7.40723C6.02983 7.15302 6.59327 6.63008 6.89746 5.9541L8.41113 2.58984L8.48047 2.46094C8.66235 2.17643 8.97898 2.00002 9.32324 2H9.56055ZM7.80957 6.36523C7.39486 7.2867 6.62674 7.99897 5.68359 8.3457L5.49219 8.41016L4.35254 8.76074C4.14305 8.82539 4.00013 9.01904 4 9.23828V15.5C4 15.7761 4.22386 16 4.5 16H12.6699C13.7697 16 14.7087 15.2049 14.8896 14.1201L15.5703 10.0381C15.7481 8.97141 14.9251 8 13.8438 8H11C10.8503 8 10.7083 7.9331 10.6133 7.81738C10.5184 7.70164 10.4805 7.54912 10.5098 7.40234L11.0312 4.79395C11.2167 3.86589 10.507 3.00009 9.56055 3H9.32324L7.80957 6.36523Z"/>
                </svg>
            </button>
            <button class="message-action-btn" onclick="openBadFeedback('${msgId}')" title="Bad response">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M12.6699 3C14.2586 3 15.6148 4.14871 15.876 5.71582L16.5566 9.79785C16.836 11.4741 15.5431 13 13.8438 13H11.6094L12.0117 15.0098C12.3211 16.5567 11.1381 17.9999 9.56055 18H9.32324C8.97898 18 8.66235 17.8236 8.48047 17.5391L8.41113 17.4102L6.89746 14.0459C6.59327 13.3699 6.02983 12.847 5.33789 12.5928L5.19824 12.5459L4.05859 12.1953C3.4294 12.0016 3.00013 11.42 3 10.7617V4.5C3 3.67157 3.67157 3 4.5 3H12.6699ZM4.5 4C4.22386 4 4 4.22386 4 4.5V10.7617C4.00013 10.981 4.14305 11.1746 4.35254 11.2393L5.49219 11.5898L5.68359 11.6543C6.62674 12.001 7.39486 12.7133 7.80957 13.6348L9.32324 17H9.56055C10.507 16.9999 11.2167 16.1341 11.0312 15.2061L10.5098 12.5977C10.4805 12.4509 10.5184 12.2984 10.6133 12.1826C10.7083 12.0669 10.8503 12 11 12H13.8438C14.9251 12 15.7481 11.0286 15.5703 9.96191L14.8896 5.87988C14.7087 4.79508 13.7697 4 12.6699 4H4.5Z"/>
                </svg>
            </button>
            <button class="message-action-btn" onclick="openRetryPopup('${msgId}')" title="Retry">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.3857 2.50977C14.3486 2.71054 17.5 5.98724 17.5 10C17.5 14.1421 14.1421 17.5 10 17.5C5.85786 17.5 2.5 14.1421 2.5 10C2.5 7.54619 3.67878 5.3677 5.49902 4H3C2.72386 4 2.5 3.77614 2.5 3.5C2.5 3.22386 2.72386 3 3 3H6.5C6.63261 3 6.75975 3.05272 6.85352 3.14648C6.92392 3.21689 6.97106 3.30611 6.99023 3.40234L7 3.5V7C7 7.27614 6.77614 7.5 6.5 7.5C6.22386 7.5 6 7.27614 6 7V4.87891C4.4782 6.06926 3.5 7.91979 3.5 10C3.5 13.5899 6.41015 16.5 10 16.5C13.5899 16.5 16.5 13.5899 16.5 10C16.5 6.5225 13.7691 3.68312 10.335 3.50879L10 3.5L9.89941 3.49023C9.67145 3.44371 9.5 3.24171 9.5 3C9.5 2.72386 9.72386 2.5 10 2.5L10.3857 2.50977Z"/>
                </svg>
            </button>

            <!-- Bad feedback popup -->
            <div class="feedback-popup" id="bad-feedback-${msgId}">
                <div class="feedback-popup-header">
                    <span class="feedback-popup-title">What could be improved?</span>
                    <button class="feedback-popup-close" onclick="closeFeedbackPopup('bad-feedback-${msgId}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    </button>
                </div>
                <textarea class="feedback-textarea" id="bad-feedback-text-${msgId}" placeholder="Tell us what was wrong with this response..." oninput="autoResizeFeedback(this)"></textarea>
                <div class="feedback-popup-actions">
                    <button class="feedback-btn-cancel" onclick="closeFeedbackPopup('bad-feedback-${msgId}')">Cancel</button>
                    <button class="feedback-btn-submit" onclick="submitBadFeedback('${msgId}')">Submit Feedback</button>
                </div>
            </div>

            <!-- Retry popup -->
            <div class="feedback-popup" id="retry-popup-${msgId}">
                <div class="feedback-popup-header">
                    <span class="feedback-popup-title">Edit and retry</span>
                    <button class="feedback-popup-close" onclick="closeFeedbackPopup('retry-popup-${msgId}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    </button>
                </div>
                <textarea class="feedback-textarea" id="retry-text-${msgId}" placeholder="Edit your message..." oninput="autoResizeFeedback(this)">${lastUserMessage.replace(/"/g, '&quot;')}</textarea>
                <div class="feedback-popup-actions">
                    <button class="feedback-btn-cancel" onclick="closeFeedbackPopup('retry-popup-${msgId}')">Cancel</button>
                    <button class="feedback-btn-submit" onclick="submitRetry('${msgId}')">Retry</button>
                </div>
            </div>
        </div>`;

    div.innerHTML = html;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addCopyMsg(content, persona, platform) {
    const div = document.createElement('div');
    div.className = 'message';

    const platformLabel = {
        'linkedin': 'LinkedIn',
        'x': 'X (Twitter)',
        'email': 'Email',
        'blog': 'Blog Post'
    }[platform] || platform;

    const platformIcon = {
        'linkedin': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19a.66.66 0 000 .14V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z"/></svg>',
        'x': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>',
        'email': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
        'blog': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>'
    }[platform] || '';

    const copyId = 'copy-' + Date.now();

    let html = `
        <div class="message-header">
            <div class="avatar avatar-assistant">M</div>
            <span class="message-name">MV Copy</span>
            <span class="copy-badge" style="margin-left: 0.5rem; display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.125rem 0.5rem; background: var(--accent-light); color: var(--accent); border-radius: 1rem; font-size: 0.75rem;">
                ${platformIcon} ${platformLabel}
            </span>
            <span class="persona-badge" style="margin-left: 0.25rem; padding: 0.125rem 0.5rem; background: var(--border-light); color: var(--text-secondary); border-radius: 1rem; font-size: 0.75rem;">
                ${persona || 'Unknown'}'s voice
            </span>
        </div>
        <div class="message-body copy-content" id="${copyId}">
            <div class="copy-text" style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--accent); margin-bottom: 1rem; white-space: pre-wrap;">
${content}
            </div>
            <div class="copy-actions" style="display: flex; gap: 0.5rem;">
                <button class="btn btn-accent btn-sm" onclick="copyToClipboard('${copyId}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    Copy to clipboard
                </button>
            </div>
        </div>`;

    div.innerHTML = html;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function copyToClipboard(id) {
    const el = document.getElementById(id);
    const copyText = el.querySelector('.copy-text');
    if (copyText) {
        navigator.clipboard.writeText(copyText.innerText.trim()).then(() => {
            showToast('Copied to clipboard!', 'success');
        }).catch(() => {
            showToast('Failed to copy', 'error');
        });
    }
}

function copyMessageContent(msgId) {
    const msgEl = document.getElementById(msgId);
    if (msgEl) {
        const bodyEl = msgEl.querySelector('.message-body');
        if (bodyEl) {
            const text = bodyEl.innerText.trim();
            navigator.clipboard.writeText(text).then(() => {
                // Find the copy button and show success state
                const btn = msgEl.querySelector('.message-action-btn');
                if (btn) {
                    btn.classList.add('copied');
                    setTimeout(() => btn.classList.remove('copied'), 2000);
                }
                showToast('Copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }
    }
}

let lastUserMessage = '';

// Feedback popup functions
function openBadFeedback(msgId) {
    closeAllFeedbackPopups();
    const popup = document.getElementById('bad-feedback-' + msgId);
    if (popup) {
        popup.classList.add('active');
        popup.querySelector('textarea').focus();
    }
}

function openRetryPopup(msgId) {
    closeAllFeedbackPopups();
    const popup = document.getElementById('retry-popup-' + msgId);
    if (popup) {
        const textarea = popup.querySelector('textarea');
        textarea.value = lastUserMessage;
        popup.classList.add('active');
        textarea.focus();
        autoResizeFeedback(textarea);
    }
}

function closeFeedbackPopup(popupId) {
    const popup = document.getElementById(popupId);
    if (popup) {
        popup.classList.remove('active');
    }
}

function closeAllFeedbackPopups() {
    document.querySelectorAll('.feedback-popup.active').forEach(p => p.classList.remove('active'));
}

function autoResizeFeedback(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 300) + 'px';
}

async function handleGoodFeedback(feedbackId, btn) {
    btn.classList.add('active-good');
    showToast('Thanks for the feedback!', 'success');

    // Send feedback to API
    try {
        await fetch('/api/script-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                rating: 1,
                feedback: 'Good response (thumbs up)',
                query: lastUserMessage,
                script: clips.length > 0 ? JSON.stringify(clips) : '',
                conversation_id: currentConversationId
            })
        });
    } catch (e) {
        console.error('Feedback error:', e);
    }
}

async function submitBadFeedback(msgId) {
    const textarea = document.getElementById('bad-feedback-text-' + msgId);
    const feedbackText = textarea.value.trim();

    if (!feedbackText) {
        showToast('Please provide feedback', 'error');
        return;
    }

    closeFeedbackPopup('bad-feedback-' + msgId);

    // Mark button as active
    const msgEl = document.getElementById(msgId);
    if (msgEl) {
        const thumbsDownBtn = msgEl.querySelectorAll('.message-action-btn')[2];
        if (thumbsDownBtn) thumbsDownBtn.classList.add('active-bad');
    }

    showToast('Feedback submitted. Thank you!', 'success');

    // Send feedback to API
    try {
        await fetch('/api/script-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                rating: -1,
                feedback: feedbackText,
                query: lastUserMessage,
                script: clips.length > 0 ? JSON.stringify(clips) : '',
                conversation_id: currentConversationId
            })
        });
    } catch (e) {
        console.error('Feedback error:', e);
    }
}

async function submitRetry(msgId) {
    const textarea = document.getElementById('retry-text-' + msgId);
    const newMessage = textarea.value.trim();

    if (!newMessage) {
        showToast('Please enter a message', 'error');
        return;
    }

    closeFeedbackPopup('retry-popup-' + msgId);

    // Send retry feedback to API for quality improvement
    try {
        await fetch('/api/script-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                rating: 0,
                feedback: 'Retry with edit: ' + newMessage,
                query: lastUserMessage,
                script: clips.length > 0 ? JSON.stringify(clips) : '',
                conversation_id: currentConversationId
            })
        });
    } catch (e) {
        console.error('Retry feedback error:', e);
    }

    // Send the new message
    document.getElementById('chatInput').value = newMessage;
    sendMessage();
}

function retryLastMessage() {
    if (lastUserMessage) {
        document.getElementById('chatInput').value = lastUserMessage;
        sendMessage();
    }
}

// Close popups when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.feedback-popup') && !e.target.closest('.message-action-btn')) {
        closeAllFeedbackPopups();
    }
});

function showTyping() {
    const div = document.createElement('div');
    div.className = 'message-assistant';
    div.id = 'typing';
    div.innerHTML = `
        <div class="message-body">
            <div class="typing"><span></span><span></span><span></span></div>
        </div>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTyping() {
    const el = document.getElementById('typing');
    if (el) el.remove();
}

async function sendMessage() {
    const msg = chatInput.value.trim();
    if (!msg) return;

    lastUserMessage = msg;  // Save for retry
    addMsg(msg, true);
    history.push({ role: 'user', content: msg });

    chatInput.value = '';
    chatInput.style.height = 'auto';
    sendBtn.disabled = true;
    chatInput.disabled = true;
    showTyping();

    try {
        const model = document.getElementById('modelSelect').value;
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: msg,
                history: history,
                model: model,
                conversation_id: currentConversationId,
                previous_clips: clips || []  // Send previously used clips to avoid duplicates
            })
        });
        const data = await res.json();
        hideTyping();

        if (data.error) {
            addMsg('Error: ' + data.error, false);
        } else {
            // Track for feedback BEFORE rendering buttons
            lastQuery = msg;
            lastScript = data.response;
            lastModel = model;

            let text = data.response.replace(/```json[\s\S]*?```/g, '');

            // Handle copy generation vs video script differently
            if (data.is_copy) {
                addCopyMsg(text, data.persona, data.platform);
            } else {
                addMsg(text, false, data.clips || [], data.context_segments || 0, data.audio_clips || []);
            }
            history.push({ role: 'assistant', content: data.response });

            // Update conversation title in sidebar if it was auto-named
            const conv = conversations.find(c => c.id === currentConversationId);
            if (conv && conv.title === 'New Chat') {
                conv.title = msg.substring(0, 50) + (msg.length > 50 ? '...' : '');
                renderConversations();
            }
        }
    } catch (e) {
        hideTyping();
        addMsg('Connection error. Please try again.', false);
    }

    sendBtn.disabled = false;
    chatInput.disabled = false;
    chatInput.focus();
}

function send(text) {
    chatInput.value = text;
    sendMessage();
}

function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
    // Shift+Enter allows new line (default behavior)
}

function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}

function toggle(id, btn) {
    const el = document.getElementById(id);
    if (!btn) btn = el.previousElementSibling;
    el.classList.toggle('show');
    btn.textContent = el.classList.contains('show') ? 'Hide clips' : 'Show clips';
}

function toggleAudioClips(id, btn) {
    const el = document.getElementById(id);
    if (!btn) btn = el.previousElementSibling;
    el.classList.toggle('open');
    btn.textContent = el.classList.contains('open') ? 'Hide audio' : 'Show audio';
}

async function playAudioClip(idx) {
    if (!audioClips || !audioClips[idx]) {
        showToast('Audio clip not found', 'error');
        return;
    }

    const clip = audioClips[idx];
    const audioId = clip.audio_id;
    const startTime = clip.start_time || 0;
    const endTime = clip.end_time || null;

    // Stop current audio if playing
    if (currentAudioPlayer) {
        currentAudioPlayer.pause();
        currentAudioPlayer = null;
        // Remove playing state from all buttons
        document.querySelectorAll('.audio-item-play.playing').forEach(b => b.classList.remove('playing'));
    }

    // Get all play buttons and find the one for this index
    const playBtn = document.querySelector(`.audio-item[data-audio-idx="${idx}"] .audio-item-play`);
    if (playBtn) {
        playBtn.classList.add('playing');
        playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
    }

    try {
        // Fetch audio URL from API
        const res = await fetch(`/api/audio-clip/${audioId}?start=${startTime}${endTime ? '&end=' + endTime : ''}`);
        const data = await res.json();

        if (data.error) {
            showToast('Error loading audio: ' + data.error, 'error');
            if (playBtn) {
                playBtn.classList.remove('playing');
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            }
            return;
        }

        // Create audio element and play
        currentAudioPlayer = new Audio(data.url);
        currentAudioPlayer.currentTime = 0;

        currentAudioPlayer.onended = () => {
            if (playBtn) {
                playBtn.classList.remove('playing');
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            }
            currentAudioPlayer = null;
        };

        currentAudioPlayer.onerror = () => {
            showToast('Error playing audio', 'error');
            if (playBtn) {
                playBtn.classList.remove('playing');
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            }
            currentAudioPlayer = null;
        };

        await currentAudioPlayer.play();
    } catch (e) {
        showToast('Error playing audio: ' + e.message, 'error');
        if (playBtn) {
            playBtn.classList.remove('playing');
            playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
        }
    }
}

async function exportScript() {
    if (!clips.length) return;
    const name = prompt('Script name:', 'My Script');
    if (!name) return;

    try {
        // Trigger file download via the browser
        const res = await fetch('/api/chat/export-script', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                clips,
                title: name,
                script_text: lastScript
            })
        });

        if (res.ok) {
            // Create blob and trigger download
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name.replace(/[^\w\-_ ]/g, '_')}_script.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } else {
            const data = await res.json();
            alert('Export failed: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        console.error('Export error:', e);
        alert('Failed to export script');
    }
}

function downloadClipByIndex(index, btn) {
    if (clips && clips[index]) {
        downloadClip(clips[index], btn);
    } else {
        alert('Clip not found');
    }
}

// SVG icons for download states
const ICONS = {
    download: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>',
    spinner: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin"><circle cx="12" cy="12" r="10" stroke-opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/></svg>',
    success: '<svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>',
    error: '<svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>',
    video: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M10 9l5 3-5 3z"/></svg>'
};

async function downloadClip(clip, btn) {
    const originalIcon = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = ICONS.spinner;
    btn.title = 'Preparing clip...';

    try {
        const url = `/api/clip-download/${clip.video_id}?start=${clip.start_time}&end=${clip.end_time}`;

        // Fetch with proper error handling
        const response = await fetch(url);

        if (!response.ok) {
            // Try to get error message from JSON response
            let errorMsg = 'Download failed';
            try {
                const errorData = await response.json();
                errorMsg = errorData.error || errorMsg;
            } catch {
                errorMsg = `Server error (${response.status})`;
            }
            throw new Error(errorMsg);
        }

        // Get the blob and trigger download
        const blob = await response.blob();
        const filename = response.headers.get('Content-Disposition')?.match(/filename="(.+)"/)?.[1] || 'clip.mp4';

        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(downloadUrl);

        // Show success icon briefly
        btn.innerHTML = ICONS.success;
        btn.title = 'Downloaded!';
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
            btn.title = 'Download';
        }, 2000);

    } catch (e) {
        console.error('Download error:', e);
        // Show error icon
        btn.innerHTML = ICONS.error;
        btn.title = e.message || 'Download failed';

        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
            btn.title = 'Download';
        }, 3000);
    }
}

async function downloadFullVideo(videoId, btn) {
    const originalIcon = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = ICONS.spinner;
    btn.title = 'Starting download...';

    try {
        // Redirect to full video download
        window.location.href = `/api/video-download/${videoId}`;

        // Show success after redirect starts
        setTimeout(() => {
            btn.innerHTML = ICONS.success;
            btn.title = 'Download started!';
        }, 500);

        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
            btn.title = 'Download Full Video';
        }, 2500);
    } catch (e) {
        btn.innerHTML = ICONS.error;
        btn.title = 'Download failed';
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
            btn.title = 'Download Full Video';
        }, 2000);
    }
}

async function sendFeedback(feedbackId, rating, btn) {
    try {
        const section = document.getElementById(feedbackId);
        const buttons = section.querySelectorAll('.feedback-btn');

        // Disable buttons
        buttons.forEach(b => b.disabled = true);

        const res = await fetch('/api/script-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query: lastQuery,
                script: lastScript,
                clips: clips,
                rating: rating,
                model: lastModel
            })
        });
        const data = await res.json();

        if (data.success) {
            // Update UI
            btn.classList.add(rating === 1 ? 'active-good' : 'active-bad');

            // Show thanks message
            const thanks = document.createElement('span');
            thanks.className = 'feedback-thanks';
            thanks.textContent = rating === 1 ? 'Thanks! This helps improve future scripts.' : 'Thanks for the feedback!';
            section.appendChild(thanks);

            // Hide other button
            buttons.forEach(b => {
                if (b !== btn) b.style.display = 'none';
            });
        }
    } catch (e) {
        console.error('Feedback error:', e);
    }
}

chatInput.focus();

// Video preview functions
const videoModal = document.getElementById('videoModal');
const previewVideo = document.getElementById('previewVideo');
const previewTitle = document.getElementById('previewTitle');
const previewTime = document.getElementById('previewTime');
let currentClipEnd = 0;

function previewClipByIndex(index) {
    if (clips && clips[index]) {
        previewClip(clips[index]);
    } else {
        alert('Clip not found');
    }
}

async function previewClip(clip) {
    try {
        previewTitle.textContent = clip.video_title || 'Video Preview';
        previewTime.textContent = `${clip.start_time?.toFixed(1)}s - ${clip.end_time?.toFixed(1)}s`;

        // Show modal immediately
        videoModal.classList.add('show');

        // Get presigned URL for streaming
        const previewUrl = `/api/clip-preview/${clip.video_id}?start=${clip.start_time}&end=${clip.end_time}`;
        const res = await fetch(previewUrl);
        const data = await res.json();

        if (data.error) {
            alert('Error loading video: ' + data.error);
            closePreview();
            return;
        }

        // Use presigned URL with seek - fast and reliable
        previewVideo.src = data.url;
        currentClipEnd = data.end || clip.end_time || 0;
        const startTime = data.start || clip.start_time || 0;

        previewVideo.onloadedmetadata = () => {
            previewVideo.currentTime = startTime;
            previewVideo.play().catch(() => {}); // Ignore autoplay errors
        };

        previewVideo.ontimeupdate = () => {
            if (currentClipEnd > 0 && previewVideo.currentTime >= currentClipEnd) {
                previewVideo.pause();
                previewVideo.currentTime = startTime;
            }
        };

    } catch (e) {
        console.error('Preview error:', e);
        alert('Failed to load video preview');
        closePreview();
    }
}

// Transcript editing functions
function editClipText(index, btn) {
    const clip = clips[index];
    if (!clip) return;

    // Find the quote element
    const quoteEl = document.querySelector(`.clip-quote[data-clip-index="${index}"]`);
    if (!quoteEl) return;

    // Get current text (remove surrounding quotes)
    let currentText = clip.text || quoteEl.textContent;
    currentText = currentText.replace(/^[""]|[""]$/g, '').trim();

    // Replace with textarea
    const container = quoteEl.parentElement;
    const originalHTML = quoteEl.outerHTML;

    quoteEl.outerHTML = `
        <div class="clip-quote-edit-container">
            <textarea class="clip-quote-editing" data-clip-index="${index}">${currentText}</textarea>
            <div class="clip-quote-actions">
                <button class="clip-quote-save" onclick="saveClipText(${index})">Save</button>
                <button class="clip-quote-cancel" onclick="cancelClipEdit(${index}, '${encodeURIComponent(originalHTML)}')">Cancel</button>
            </div>
        </div>
    `;

    // Focus the textarea
    const textarea = container.querySelector('.clip-quote-editing');
    if (textarea) {
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    }
}

async function saveClipText(index) {
    const clip = clips[index];
    if (!clip) return;

    const textarea = document.querySelector(`.clip-quote-editing[data-clip-index="${index}"]`);
    if (!textarea) return;

    const newText = textarea.value.trim();
    if (!newText) {
        alert('Text cannot be empty');
        return;
    }

    try {
        const res = await fetch('/api/transcript-segment/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                video_id: clip.video_id,
                start_time: clip.start_time,
                end_time: clip.end_time,
                text: newText
            })
        });

        const data = await res.json();

        if (data.success) {
            // Update local clip data
            clip.text = newText;

            // Replace textarea with updated quote
            const container = textarea.closest('.clip-quote-edit-container');
            if (container) {
                container.outerHTML = `<p class="clip-quote" data-clip-index="${index}">"${newText.replace(/"/g, '&quot;')}"</p>`;
            }
        } else {
            alert('Failed to save: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        console.error('Save error:', e);
        alert('Failed to save changes');
    }
}

function cancelClipEdit(index, encodedOriginalHTML) {
    const container = document.querySelector('.clip-quote-edit-container');
    if (container) {
        container.outerHTML = decodeURIComponent(encodedOriginalHTML);
    }
}

function closePreview() {
    videoModal.classList.remove('show');
    previewVideo.pause();
    previewVideo.src = '';
    currentClipEnd = 0;
}

function closeModal(e) {
    if (e.target === videoModal) {
        closePreview();
    }
}

// Close on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && videoModal.classList.contains('show')) {
        closePreview();
    }
    if (e.key === 'Escape' && shareModal.classList.contains('show')) {
        closeShareModal();
    }
});

// ============================================================================
// CHAT MENU FUNCTIONS
// ============================================================================

function toggleChatMenu(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('chatMenuDropdown');
    dropdown.classList.toggle('active');
}

function closeChatMenu() {
    const dropdown = document.getElementById('chatMenuDropdown');
    dropdown.classList.remove('active');
}

// Close chat menu when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('chatMenuDropdown');
    const menuBtn = document.querySelector('.chat-menu-btn');
    if (dropdown && !dropdown.contains(event.target) && !menuBtn.contains(event.target)) {
        dropdown.classList.remove('active');
    }
});

function deleteCurrentConversation() {
    if (currentConversationId) {
        deleteConversation(currentConversationId);
    } else {
        alert('No conversation selected');
    }
}

async function archiveConversation() {
    if (!currentConversationId) {
        alert('No conversation selected');
        return;
    }

    if (!confirm('Archive this conversation? It will be hidden from your list.')) return;

    try {
        const res = await fetch(`/api/conversations/${currentConversationId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ archived: true })
        });

        if (res.ok) {
            // Remove from list and load next conversation
            conversations = conversations.filter(c => c.id !== currentConversationId);
            renderConversations();

            if (conversations.length > 0) {
                await loadConversation(conversations[0].id);
            } else {
                await createNewConversation();
            }
        } else {
            alert('Failed to archive conversation');
        }
    } catch (e) {
        console.error('Archive error:', e);
        alert('Failed to archive conversation');
    }
}

// ============================================================================
// COLLABORATION FUNCTIONS
// ============================================================================

const shareModal = document.getElementById('shareModal');
let participantsCache = [];
let searchTimeout = null;

function openShareModal() {
    if (!currentConversationId) {
        alert('Please select a conversation first');
        return;
    }
    shareModal.classList.add('show');
    loadParticipants();
}

function closeShareModal(e) {
    if (!e || e.target === shareModal) {
        shareModal.classList.remove('show');
        document.getElementById('userSearch').value = '';
        document.getElementById('searchResults').innerHTML = '';
    }
}

async function loadParticipants() {
    try {
        const res = await fetch(`/api/conversations/${currentConversationId}/participants`);
        const data = await res.json();
        participantsCache = data.participants || [];
        renderParticipants();
    } catch (e) {
        console.error('Error loading participants:', e);
    }
}

function renderParticipants() {
    const container = document.getElementById('participantsContent');
    if (!participantsCache.length) {
        container.innerHTML = '<div style="color: #888; font-size: 0.75rem;">Only you have access</div>';
        return;
    }

    container.innerHTML = participantsCache.map(p => `
        <div class="participant-item">
            <div class="search-result-avatar">${(p.name || 'U')[0].toUpperCase()}</div>
            <div class="search-result-info">
                <div class="search-result-name">${escapeHtml(p.name)}</div>
                <div class="search-result-email">${escapeHtml(p.email)}</div>
            </div>
            <span class="participant-role ${p.role}">${p.role}</span>
        </div>
    `).join('');
}

async function searchUsers(query) {
    clearTimeout(searchTimeout);
    const resultsDiv = document.getElementById('searchResults');

    if (query.length < 2) {
        resultsDiv.innerHTML = '';
        return;
    }

    searchTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();

            // Filter out existing participants
            const participantIds = participantsCache.map(p => p.id);
            const available = (data.users || []).filter(u => !participantIds.includes(u.id));

            if (!available.length) {
                resultsDiv.innerHTML = '<div style="color: #888; font-size: 0.75rem; padding: 0.5rem;">No users found</div>';
                return;
            }

            resultsDiv.innerHTML = available.map(u => `
                <div class="search-result" onclick="inviteUser('${u.id}', '${escapeHtml(u.name)}')">
                    <div class="search-result-avatar">${u.name[0].toUpperCase()}</div>
                    <div class="search-result-info">
                        <div class="search-result-name">${escapeHtml(u.name)}</div>
                        <div class="search-result-email">${escapeHtml(u.email)}</div>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            console.error('Search error:', e);
        }
    }, 300);
}

async function inviteUser(userId, userName) {
    try {
        const res = await fetch(`/api/conversations/${currentConversationId}/invite`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
        });
        const data = await res.json();

        if (data.success) {
            document.getElementById('userSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
            loadParticipants();
        } else {
            alert(data.error || 'Failed to invite user');
        }
    } catch (e) {
        console.error('Invite error:', e);
        alert('Failed to invite user');
    }
}

// ============================================================================
// SCRIPT CLIP INTERACTIONS (hover actions on VIDEO CLIP blocks)
// ============================================================================

function playScriptClip(clipIdx) {
    if (clips && clips[clipIdx]) {
        previewClip(clips[clipIdx]);
    }
}

async function regenerateScriptClip(clipIdx) {
    console.log('[DEBUG] regenerateScriptClip called with clipIdx:', clipIdx);
    console.log('[DEBUG] clips array:', clips);
    console.log('[DEBUG] clips[clipIdx]:', clips ? clips[clipIdx] : 'clips is undefined');
    console.log('[DEBUG] currentConversationId:', currentConversationId);

    if (!clips || !clips[clipIdx]) {
        console.error('[DEBUG] No clip found at index', clipIdx, '- clips array length:', clips?.length);
        alert('Clip data not available. This may happen if you are trying to regenerate a clip from an older message. Try regenerating the entire response first.');
        return;
    }

    const clip = clips[clipIdx];
    const feedback = prompt('What kind of alternative are you looking for? (or leave blank for any alternative)');
    if (feedback === null) return; // cancelled

    const model = document.getElementById('modelSelect').value;
    const videoClipEl = document.querySelector(`.video-clip[data-clip-idx="${clipIdx}"]`);

    // Show loading state
    if (videoClipEl) {
        videoClipEl.style.opacity = '0.5';
    }

    try {
        const res = await fetch(`/api/clips/${currentConversationId}/${clipIdx}/regenerate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                feedback,
                original_clip: clip,
                history: history,
                model
            })
        });
        const data = await res.json();

        if (data.success && data.alternative_clips && data.alternative_clips.length > 0) {
            const newClip = data.alternative_clips[0];

            // Update clips array
            clips[clipIdx] = { ...newClip, verified: false };

            // Update the VIDEO CLIP display
            if (videoClipEl) {
                const pEl = videoClipEl.querySelector('p');
                if (pEl) {
                    pEl.textContent = `"${newClip.text}"`;
                }
                const speakerEl = videoClipEl.querySelector('.speaker');
                if (speakerEl && newClip.speaker) {
                    speakerEl.textContent = `‚Äî ${newClip.speaker}`;
                }
            }

            // Update the clips section thumbnail and quote
            const clipQuote = document.querySelector(`.clip-quote[data-clip-index="${clipIdx}"]`);
            if (clipQuote) {
                clipQuote.textContent = `"${newClip.text}"`;
            }
        } else {
            alert('Could not find an alternative clip. Try providing more specific feedback.');
        }
    } catch (e) {
        console.error('Regenerate error:', e);
        alert('Failed to regenerate clip');
    }

    if (videoClipEl) {
        videoClipEl.style.opacity = '1';
    }
}

function commentScriptClip(clipIdx) {
    if (!clips || !clips[clipIdx]) return;

    const comment = prompt('Add a comment (use @teammate to mention, @mv-video to regenerate):');
    if (!comment) return;

    // Submit comment
    fetch(`/api/clips/${currentConversationId}/${clipIdx}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: comment })
    }).then(res => res.json()).then(data => {
        if (data.success) {
            // If mentioned @mv-video, trigger regeneration
            if (data.comment.is_regenerate_request) {
                regenerateScriptClip(clipIdx);
            }
        }
    });
}

// ============================================================================
// RECORD SECTION INTERACTIONS (hover actions on RECORD THIS blocks)
// ============================================================================

async function regenerateRecord(recordIdx) {
    const recordEl = document.querySelector(`.record-section[data-record-idx="${recordIdx}"]`);
    if (!recordEl) return;

    const currentText = recordEl.querySelector('p')?.textContent || '';
    const feedback = prompt('What kind of alternative narration are you looking for? (or leave blank for any alternative)');
    if (feedback === null) return; // cancelled

    const model = document.getElementById('modelSelect').value;

    // Show loading state
    recordEl.style.opacity = '0.5';

    try {
        const res = await fetch(`/api/records/${currentConversationId}/${recordIdx}/regenerate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                feedback,
                original_text: currentText,
                history: history,
                model
            })
        });
        const data = await res.json();

        if (data.success && data.new_text) {
            // Update the RECORD section display
            const pEl = recordEl.querySelector('p');
            if (pEl) {
                pEl.textContent = data.new_text;
            }
        } else {
            alert('Could not generate an alternative. Try providing more specific feedback.');
        }
    } catch (e) {
        console.error('Regenerate record error:', e);
        alert('Failed to regenerate narration');
    }

    recordEl.style.opacity = '1';
}

function commentRecord(recordIdx) {
    const recordEl = document.querySelector(`.record-section[data-record-idx="${recordIdx}"]`);
    if (!recordEl) return;

    const currentText = recordEl.querySelector('p')?.textContent || '';
    const comment = prompt('Add a comment (use @mv-video to regenerate with feedback):');
    if (!comment) return;

    // Submit comment
    fetch(`/api/records/${currentConversationId}/${recordIdx}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: comment, original_text: currentText })
    }).then(res => res.json()).then(data => {
        if (data.success) {
            // If mentioned @mv-video, trigger regeneration with the comment as feedback
            if (data.comment && data.comment.is_regenerate_request) {
                regenerateRecord(recordIdx);
            }
        }
    }).catch(e => {
        console.error('Comment error:', e);
    });
}

// ============================================================================
// CLIP COMMENTS & REGENERATION (legacy - for clips section)
// ============================================================================

let openCommentPanel = null;

async function toggleClipComments(clipIndex, btn) {
    const existingPanel = document.getElementById(`comment-panel-${clipIndex}`);

    // Close any open panel
    if (openCommentPanel && openCommentPanel !== existingPanel) {
        openCommentPanel.remove();
        openCommentPanel = null;
    }

    if (existingPanel) {
        existingPanel.remove();
        openCommentPanel = null;
        return;
    }

    // Create panel
    const panel = document.createElement('div');
    panel.className = 'comment-panel show';
    panel.id = `comment-panel-${clipIndex}`;
    panel.innerHTML = `
        <div class="comment-panel-header">
            <h4>Comments</h4>
            <button class="comment-panel-close" onclick="toggleClipComments(${clipIndex})">&times;</button>
        </div>
        <div class="comments-list" id="comments-list-${clipIndex}">Loading...</div>
        <div class="comment-input-area">
            <textarea class="comment-input" id="comment-input-${clipIndex}" placeholder="Add a comment..." rows="2" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();submitComment(${clipIndex});}"></textarea>
            <div class="comment-hint">@teammate to mention, @mv-video to regenerate</div>
        </div>
    `;

    btn.closest('.clip-actions').appendChild(panel);
    openCommentPanel = panel;

    // Load comments
    await loadClipComments(clipIndex);
}

async function loadClipComments(clipIndex) {
    try {
        const res = await fetch(`/api/clips/${currentConversationId}/${clipIndex}/comments`);
        const data = await res.json();

        const list = document.getElementById(`comments-list-${clipIndex}`);
        if (!data.comments || !data.comments.length) {
            list.innerHTML = '<div style="color: #888; font-size: 0.75rem; padding: 0.5rem;">No comments yet</div>';
            return;
        }

        list.innerHTML = data.comments.map(c => `
            <div class="comment-item">
                <div class="comment-author">${escapeHtml(c.user_name)}</div>
                <div class="comment-text">${formatCommentText(c.content)}</div>
                <div class="comment-time">${formatDate(c.created_at)}</div>
            </div>
        `).join('');
    } catch (e) {
        console.error('Error loading comments:', e);
    }
}

function formatCommentText(text) {
    // Highlight @mentions
    return escapeHtml(text).replace(/@(\w+(?:-\w+)*)/g, '<span style="color: #d97757; font-weight: 500;">@$1</span>');
}

async function submitComment(clipIndex) {
    const input = document.getElementById(`comment-input-${clipIndex}`);
    const content = input.value.trim();
    if (!content) return;

    try {
        const res = await fetch(`/api/clips/${currentConversationId}/${clipIndex}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });
        const data = await res.json();

        if (data.success) {
            input.value = '';
            await loadClipComments(clipIndex);

            // If mentioned @mv-video, trigger regeneration
            if (data.comment.is_regenerate_request && clips[clipIndex]) {
                regenerateClip(clipIndex, content);
            }
        }
    } catch (e) {
        console.error('Error submitting comment:', e);
    }
}

async function regenerateClip(clipIndex, feedback = '') {
    if (!clips[clipIndex]) return;

    const clip = clips[clipIndex];
    const model = document.getElementById('modelSelect').value;

    try {
        // Show loading state
        const btn = document.querySelector(`[data-regen-clip="${clipIndex}"]`);
        if (btn) {
            btn.innerHTML = ICONS.spinner;
            btn.disabled = true;
        }

        const res = await fetch(`/api/clips/${currentConversationId}/${clipIndex}/regenerate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                feedback,
                original_clip: clip,
                history: history,
                model
            })
        });
        const data = await res.json();

        if (data.success && data.alternative_clips && data.alternative_clips.length > 0) {
            // Replace the clip
            const newClip = data.alternative_clips[0];
            clips[clipIndex] = { ...newClip, verified: false };

            // Show success message
            alert(`Found alternative clip: "${newClip.text.substring(0, 100)}..."`);

            // TODO: Update the UI to show the new clip
        } else {
            alert('Could not find an alternative clip. Try providing more specific feedback.');
        }

        if (btn) {
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>';
            btn.disabled = false;
        }
    } catch (e) {
        console.error('Regenerate error:', e);
        alert('Failed to regenerate clip');
    }
}

// ============================================================================
// SIDEBAR & USER MENU FUNCTIONS
// ============================================================================

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('collapsed');
    localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
}

function toggleProjectsSection() {
    const headers = document.querySelectorAll('.sidebar-section-header');
    const header = headers[0]; // First header is Projects
    const section = document.getElementById('projectsSection');
    header.classList.toggle('expanded');
    section.classList.toggle('expanded');
    localStorage.setItem('projectsExpanded', section.classList.contains('expanded'));
}

function toggleLibrarySection() {
    const headers = document.querySelectorAll('.sidebar-section-header');
    const header = headers[1]; // Second header is Library
    const section = document.getElementById('librarySection');
    header.classList.toggle('expanded');
    section.classList.toggle('expanded');
    localStorage.setItem('libraryExpanded', section.classList.contains('expanded'));
}

// Projects functionality
let projects = [];
let selectedProjectColor = '#d97757';

async function loadProjects() {
    try {
        const res = await fetch('/api/projects');
        if (res.ok) {
            projects = await res.json();
            renderProjects();
        }
    } catch (e) {
        console.error('Failed to load projects:', e);
    }
}

function renderProjects() {
    const projectsList = document.getElementById('projectsList');
    if (!projectsList) return;

    if (projects.length === 0) {
        projectsList.innerHTML = '<div style="padding: 0.5rem 1rem 0.5rem 2.25rem; font-size: 0.75rem; color: #888;">No projects yet</div>';
        return;
    }

    projectsList.innerHTML = projects.map(p => `
        <a href="/project/${p.id}" class="project-item">
            <div class="project-color-dot" style="background: ${p.color || '#d97757'};"></div>
            <span class="project-name">${escapeHtml(p.name)}</span>
            <span class="project-count">${p.conversation_count || 0}</span>
        </a>
    `).join('');
}

function showCreateProjectModal() {
    document.getElementById('createProjectModal').classList.add('active');
    document.getElementById('projectName').focus();
    // Reset form
    document.getElementById('projectName').value = '';
    document.getElementById('projectDescription').value = '';
    document.getElementById('projectInstructions').value = '';
    selectedProjectColor = '#d97757';
    document.querySelectorAll('.color-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.color === '#d97757');
    });
}

function closeCreateProjectModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('createProjectModal').classList.remove('active');
}

function selectProjectColor(el) {
    selectedProjectColor = el.dataset.color;
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.toggle('selected', option === el);
    });
}

async function createProject() {
    const name = document.getElementById('projectName').value.trim();
    if (!name) {
        alert('Please enter a project name');
        return;
    }

    const btn = document.getElementById('createProjectBtn');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    try {
        const res = await fetch('/api/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                description: document.getElementById('projectDescription').value.trim(),
                custom_instructions: document.getElementById('projectInstructions').value.trim(),
                color: selectedProjectColor
            })
        });

        if (res.ok) {
            const project = await res.json();
            closeCreateProjectModal();
            await loadProjects();
            // Navigate to the new project
            window.location.href = `/project/${project.id}`;
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to create project');
        }
    } catch (e) {
        console.error('Failed to create project:', e);
        alert('Failed to create project');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Create project';
    }
}

function toggleUserMenu(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('userMenuDropdown');
    dropdown.classList.toggle('active');
}

// Close user menu when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('userMenuDropdown');
    if (dropdown && !e.target.closest('.sidebar-footer')) {
        dropdown.classList.remove('active');
    }
});

// Restore sidebar state on load
document.addEventListener('DOMContentLoaded', function() {
    const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (sidebarCollapsed) {
        document.getElementById('sidebar').classList.add('collapsed');
    }

    // Restore projects section state
    const projectsExpanded = localStorage.getItem('projectsExpanded');
    if (projectsExpanded === 'false') {
        const headers = document.querySelectorAll('.sidebar-section-header');
        headers[0].classList.remove('expanded');
        document.getElementById('projectsSection').classList.remove('expanded');
    }

    // Restore library section state
    const libraryExpanded = localStorage.getItem('libraryExpanded');
    if (libraryExpanded === 'false') {
        const headers = document.querySelectorAll('.sidebar-section-header');
        headers[1].classList.remove('expanded');
        document.getElementById('librarySection').classList.remove('expanded');
    }
});

// Toast notification system
function showToast(message, type = 'info', duration = 3000) {
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.cssText = 'position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.5rem;';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.style.cssText = `
        background: ${type === 'success' ? '#065f46' : type === 'error' ? '#991b1b' : '#1a1a1a'};
        color: white;
        padding: 0.875rem 1.25rem;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;
    toast.innerHTML = `<span>${message}</span>`;
    container.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
</style>

</body>
</html>
