<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - MV Internal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
    // Restore sidebar state BEFORE first paint to prevent layout shift
    (function() {
        var style = document.createElement('style');
        // Always disable chevron transitions on initial load
        var css = '.sidebar-section-toggle { transition: none !important; } .recents-project-chevron { transition: none !important; }';

        // Library section - if explicitly collapsed
        if (localStorage.getItem('libraryExpanded') === 'false') {
            css += '#librarySection { display: none !important; }';
            css += '#libraryHeader .sidebar-section-toggle { transform: rotate(0deg) !important; }';
        }

        // Sidebar collapsed
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            css += '.sidebar { width: 0 !important; transform: translateX(-260px) !important; }';
        }

        style.id = 'sidebar-state-override';
        style.textContent = css;
        document.head.appendChild(style);
    })();
    </script>
</head>
<body>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f5f4ef;
        min-height: 100vh;
        display: flex;
    }

    /* Sidebar styles */
    .sidebar {
        width: 260px;
        background: #faf9f7;
        border-right: 1px solid #e5e4df;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        height: 100vh;
        transition: width 0.2s ease, transform 0.2s ease;
    }

    .sidebar.collapsed {
        width: 0;
        transform: translateX(-260px);
    }

    .sidebar-header {
        padding: 1rem 1rem 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .sidebar-logo {
        font-family: 'EB Garamond', Georgia, serif;
        font-size: 1.25rem;
        font-weight: 500;
        color: #1a1a1a;
        letter-spacing: -0.01em;
    }

    .sidebar-toggle {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        transition: all 0.15s;
    }

    .sidebar-toggle:hover {
        background: #e5e4df;
        color: #1a1a1a;
    }

    .sidebar-toggle svg {
        width: 18px;
        height: 18px;
    }

    /* Floating toggle when collapsed */
    .sidebar-toggle-floating {
        position: fixed;
        top: 1rem;
        left: 1rem;
        width: 36px;
        height: 36px;
        border: 1px solid #e5e4df;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        color: #666;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        z-index: 100;
        transition: all 0.15s;
    }

    .sidebar-toggle-floating:hover {
        background: #f5f4ef;
        color: #1a1a1a;
    }

    .sidebar-toggle-floating svg {
        width: 18px;
        height: 18px;
    }

    .sidebar.collapsed ~ .main-content .sidebar-toggle-floating {
        display: flex;
    }

    /* New chat button */
    .new-chat-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        margin: 0;
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        border-radius: 0;
        font-size: 0.875rem;
        color: #444;
        cursor: pointer;
        font-family: inherit;
        transition: background 0.15s;
        text-decoration: none;
    }

    .new-chat-btn:hover {
        background: #f0efea;
    }

    .new-chat-btn.active {
        background: #e8e6e1;
    }

    .new-chat-icon {
        width: 18px;
        height: 18px;
        background: #d97757;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .new-chat-icon svg {
        width: 10px;
        height: 10px;
        color: white;
        stroke-width: 2.5;
    }

    /* Sidebar navigation */
    .sidebar-nav {
        padding: 0;
        margin-bottom: 0.5rem;
    }

    .sidebar-nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        border-radius: 0;
        font-size: 0.875rem;
        color: #444;
        cursor: pointer;
        font-family: inherit;
        text-decoration: none;
        transition: background 0.15s, color 0.15s;
    }

    .sidebar-nav-item:hover {
        background: #f0efea;
        color: #1a1a1a;
    }

    .sidebar-nav-item.active {
        background: #e5e4df;
        color: #1a1a1a;
    }

    .sidebar-nav-item svg {
        width: 18px;
        height: 18px;
        color: #666;
    }

    .sidebar-nav-item.active svg {
        color: #1a1a1a;
    }

    /* Collapsible section */
    .sidebar-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 1rem;
        margin: 0;
        border-radius: 0;
        cursor: pointer;
        transition: background 0.15s;
    }

    .sidebar-section-header:hover {
        background: #f0efea;
    }

    .sidebar-section-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.875rem;
        color: #444;
    }

    .sidebar-section-header-left svg {
        width: 18px;
        height: 18px;
        color: #666;
    }

    .sidebar-section-toggle {
        width: 18px;
        height: 18px;
        color: #888;
        transition: transform 0.2s;
    }

    .sidebar-section-header.expanded .sidebar-section-toggle {
        transform: rotate(180deg);
    }

    .sidebar-section-items {
        display: none;
        padding-left: 0;
    }

    .sidebar-section-items.expanded {
        display: block;
    }

    .sidebar-section-items .sidebar-nav-item {
        display: flex;
        width: 100%;
        padding-left: 2.75rem;
        font-size: 0.8125rem;
    }

    .sidebar-divider {
        height: 1px;
        background: #e5e4df;
        margin: 0.5rem 1rem;
    }

    /* Recents section */
    .sidebar-section {
        padding: 0 1rem;
        margin-bottom: 0.5rem;
    }

    .sidebar-section-title {
        font-size: 0.6875rem;
        font-weight: 600;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .conversations-list {
        flex: 1;
        min-height: 100px;
        overflow-y: auto;
        scrollbar-gutter: stable;
        padding: 0 0.5rem;
    }

    .conversation-item {
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 0.125rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.15s;
    }

    .conversation-item:hover {
        background: #f0efea;
    }

    .conversation-item.active {
        background: #e5e4df;
    }

    .conversation-title {
        font-size: 0.8125rem;
        color: #1a1a1a;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }

    .conversation-date {
        display: none;
    }

    /* Chat item menu button (‚Ä¢‚Ä¢‚Ä¢) */
    .chat-item-menu {
        opacity: 0;
        background: #e5e4df;
        border: none;
        border-radius: 6px;
        color: #666;
        padding: 2px 6px;
        cursor: pointer;
        font-size: 12px;
        letter-spacing: 1px;
        transition: opacity 0.15s, background 0.15s;
        flex-shrink: 0;
    }

    .conversation-item:hover .chat-item-menu {
        opacity: 1;
    }

    .chat-item-menu:hover {
        background: #d5d4cf;
        color: #1a1a1a;
    }

    /* Shared chat menu dropdown */
    .chat-menu-dropdown {
        display: none;
        position: fixed;
        background: white;
        border: 1px solid #e5e4df;
        border-radius: 12px;
        padding: 6px 0;
        min-width: 200px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        z-index: 10000;
    }

    .chat-menu-dropdown.open {
        display: block;
    }

    .chat-menu-dropdown button {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
        padding: 10px 16px;
        background: none;
        border: none;
        color: #1a1a1a;
        font-size: 14px;
        font-family: inherit;
        cursor: pointer;
        text-align: left;
    }

    .chat-menu-dropdown button:hover {
        background: #f5f4ef;
    }

    .chat-menu-dropdown .menu-delete {
        color: #dc2626;
    }

    .chat-menu-dropdown .menu-delete:hover {
        background: #fef2f2;
    }

    .menu-icon {
        width: 20px;
        text-align: center;
        font-size: 16px;
    }

    /* Chat header bar with title and share */
    .chat-header-bar {
        display: none;
        align-items: center;
        justify-content: space-between;
        padding: 12px 20px;
        border-bottom: 1px solid #e5e4df;
    }

    .chat-header-bar.visible {
        display: flex;
    }

    .chat-header-left {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chat-project-link {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #666;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
    }

    .chat-project-link:hover {
        text-decoration: underline;
    }

    .chat-project-link .project-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .chat-breadcrumb-separator {
        color: #999;
        font-size: 14px;
    }

    .chat-title-dropdown {
        display: flex;
        align-items: center;
        gap: 6px;
        background: none;
        border: none;
        color: #1a1a1a;
        font-size: 14px;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
    }

    .chat-title-dropdown:hover {
        background: #f5f4ef;
    }

    .chat-title-dropdown .chat-title-text {
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .share-btn {
        background: #d97757;
        border: none;
        color: white;
        padding: 8px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.15s;
    }

    .share-btn:hover {
        background: #c46a4a;
    }

    /* Recents project groups */
    .recents-project-group {
        margin-bottom: 0.25rem;
    }

    .recents-project-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.15s;
    }

    .recents-project-header:hover {
        background: #f0efea;
    }

    .recents-project-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .recents-project-name {
        font-size: 0.8125rem;
        font-weight: 500;
        color: #1a1a1a;
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .recents-project-chevron {
        width: 14px;
        height: 14px;
        color: #888;
        transition: transform 0.2s;
        flex-shrink: 0;
    }

    .recents-project-header.expanded .recents-project-chevron {
        transform: rotate(180deg);
    }

    .recents-project-items {
        display: none;
        padding-left: 0.5rem;
    }

    .recents-project-items.expanded {
        display: block;
    }

    .conversation-item.nested {
        padding-left: 1.25rem;
    }

    .sidebar-footer {
        padding: 0.75rem 1rem;
        border-top: 1px solid #e5e4df;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        flex: 1;
        min-width: 0;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #1a1a1a;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8125rem;
        font-weight: 600;
        flex-shrink: 0;
    }

    .user-details {
        min-width: 0;
        flex: 1;
    }

    .user-name {
        font-size: 0.8125rem;
        color: #1a1a1a;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .user-menu-btn {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        transition: all 0.15s;
    }

    .user-menu-btn:hover {
        background: #e5e4df;
        color: #1a1a1a;
    }

    .user-menu-btn svg {
        width: 16px;
        height: 16px;
    }

    /* User dropdown menu - Claude style */
    .user-menu-dropdown {
        position: absolute;
        bottom: 100%;
        left: 0.5rem;
        right: 0.5rem;
        margin-bottom: 0.5rem;
        background: white;
        border: 1px solid #e5e4df;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.12);
        display: none;
        overflow: hidden;
        z-index: 100;
    }

    .user-menu-dropdown.active {
        display: block;
    }

    .user-menu-header {
        padding: 1rem 1rem 0.75rem;
        border-bottom: 1px solid #e5e4df;
    }

    .user-menu-email {
        font-size: 0.875rem;
        color: #666;
        margin-bottom: 0.5rem;
    }

    .user-menu-role {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
        color: #666;
        background: #f5f4ef;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }

    .user-menu-section {
        padding: 0.5rem 0;
    }

    .user-menu-section + .user-menu-section {
        border-top: 1px solid #e5e4df;
    }

    .user-menu-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.625rem 1rem;
        border: none;
        background: none;
        font-size: 0.875rem;
        color: #374151;
        cursor: pointer;
        text-decoration: none;
        font-family: inherit;
        transition: background 0.15s;
    }

    .user-menu-item:hover {
        background: #f5f4ef;
    }

    .user-menu-item svg {
        width: 18px;
        height: 18px;
        color: #666;
    }

    /* Main chat area - full width with scrollbar on window edge */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        position: relative;
        height: 100vh;
    }

    /* Chat header with menu */
    .chat-header {
        position: sticky;
        top: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: transparent;
        z-index: 10;
    }

    .chat-messages {
        flex: 1;
        padding: 1.5rem;
        padding-bottom: 140px;
        max-width: 768px;
        width: 100%;
        margin: 0 auto;
        box-sizing: border-box;
    }

    /* Chats List View */
    .chats-list-view {
        flex: 1;
        padding: 2rem;
        max-width: 900px;
        width: 100%;
        margin: 0 auto;
        box-sizing: border-box;
        display: none;
    }

    .chats-list-view.active {
        display: block;
    }

    .chats-list-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
    }

    .chats-list-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .chats-new-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: #1a1a1a;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
    }

    .chats-new-btn:hover {
        background: #333;
    }

    .chats-new-btn svg {
        width: 16px;
        height: 16px;
    }

    .chats-search-wrapper {
        margin-bottom: 1rem;
    }

    .chats-search {
        width: 100%;
        padding: 0.75rem 1rem;
        padding-left: 2.5rem;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-family: inherit;
        background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") no-repeat 0.75rem center;
    }

    .chats-search:focus {
        outline: none;
        border-color: #d97757;
    }

    .chats-count-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        color: #666;
    }

    .chats-select-btn {
        color: #d97757;
        background: none;
        border: none;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
    }

    .chats-select-btn:hover {
        text-decoration: underline;
    }

    .chats-list {
        border-top: 1px solid #e5e4df;
    }

    .chat-list-item {
        display: flex;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid #e5e4df;
        cursor: pointer;
        transition: background 0.15s;
    }

    .chat-list-item:hover {
        background: #f9f9f7;
        margin: 0 -1rem;
        padding: 1rem;
    }

    .chat-list-checkbox {
        width: 18px;
        height: 18px;
        margin-right: 1rem;
        accent-color: #d97757;
        display: none;
    }

    .chats-list-view.select-mode .chat-list-checkbox {
        display: block;
    }

    .chat-list-content {
        flex: 1;
        min-width: 0;
    }

    .chat-list-title {
        font-size: 0.9375rem;
        font-weight: 500;
        color: #1a1a1a;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-list-meta {
        font-size: 0.8125rem;
        color: #888;
    }

    .chat-list-actions {
        opacity: 0;
        transition: opacity 0.15s;
    }

    .chat-list-item:hover .chat-list-actions {
        opacity: 1;
    }

    .chat-list-action-btn {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: #888;
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chat-list-action-btn:hover {
        background: #e5e4df;
        color: #1a1a1a;
    }

    .chats-select-actions {
        display: none;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        background: #f5f4ef;
        border-radius: 8px;
    }

    .chats-list-view.select-mode .chats-select-actions {
        display: flex;
    }

    .chats-list-view.select-mode .chats-count-row {
        display: none;
    }

    .select-count {
        font-size: 0.875rem;
        color: #666;
        flex: 1;
    }

    .select-action-btn {
        padding: 0.5rem 0.75rem;
        border: none;
        background: transparent;
        color: #666;
        font-size: 0.8125rem;
        cursor: pointer;
        border-radius: 4px;
        font-family: inherit;
    }

    .select-action-btn:hover {
        background: #e5e4df;
    }

    .select-action-btn.danger {
        color: #dc2626;
    }

    .select-action-btn.danger:hover {
        background: #fef2f2;
    }

    /* Library List View */
    .library-list-view {
        flex: 1;
        padding: 2rem;
        max-width: 900px;
        width: 100%;
        margin: 0 auto;
        box-sizing: border-box;
        display: none;
    }

    .library-list-view.active {
        display: block;
    }

    .library-list-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
    }

    .library-list-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .library-count-row {
        margin-bottom: 1.5rem;
        font-size: 0.875rem;
        color: #666;
    }

    .library-categories {
        display: flex;
        flex-direction: column;
        gap: 0;
        border-top: 1px solid #e5e4df;
    }

    .library-category-item {
        display: flex;
        align-items: center;
        padding: 1.25rem 0;
        border-bottom: 1px solid #e5e4df;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        transition: background 0.15s;
    }

    .library-category-item:hover {
        background: #f9f9f7;
        margin: 0 -1rem;
        padding: 1.25rem 1rem;
    }

    .library-category-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .library-category-icon svg {
        width: 20px;
        height: 20px;
        color: white;
    }

    .library-category-content {
        flex: 1;
        min-width: 0;
    }

    .library-category-title {
        font-size: 1rem;
        font-weight: 500;
        color: #1a1a1a;
        margin-bottom: 0.25rem;
    }

    .library-category-desc {
        font-size: 0.8125rem;
        color: #888;
    }

    .library-category-count {
        font-size: 0.875rem;
        color: #888;
        margin-left: 1rem;
    }

    .message {
        margin-bottom: 1.5rem;
    }

    /* User messages - right aligned, bubble style */
    .message-user {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1rem;
    }

    .message-user .message-bubble {
        max-width: 70%;
        background: #1a1a1a;
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 18px 18px 4px 18px;
        font-size: 0.9375rem;
        line-height: 1.5;
    }

    .message-user .message-bubble p {
        margin: 0;
    }

    /* Assistant messages - left aligned, full width */
    .message-assistant {
        margin-bottom: 1.5rem;
    }

    .message-assistant .message-body {
        color: #374151;
        line-height: 1.7;
        font-size: 0.9375rem;
    }

    /* Message actions */
    .message-actions {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        margin-top: 0.75rem;
    }

    .message-action-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: none;
        background: transparent;
        color: #888;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
    }

    .message-action-btn:hover {
        background: #f0efea;
        color: #1a1a1a;
    }

    .message-action-btn:active {
        transform: scale(0.95);
    }

    .message-action-btn svg {
        width: 18px;
        height: 18px;
    }

    .message-action-btn.active-good {
        color: #22c55e;
    }

    .message-action-btn.active-bad {
        color: #ef4444;
    }

    .message-action-btn.copied {
        color: #22c55e;
    }

    /* Feedback popup */
    .feedback-popup {
        position: absolute;
        bottom: 100%;
        left: 0;
        margin-bottom: 0.5rem;
        background: white;
        border: 1px solid #e5e4df;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        padding: 1rem;
        width: 400px;
        max-width: calc(100vw - 2rem);
        z-index: 100;
        display: none;
    }

    .feedback-popup.active {
        display: block;
    }

    .feedback-popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .feedback-popup-title {
        font-weight: 600;
        font-size: 0.875rem;
        color: #1a1a1a;
    }

    .feedback-popup-close {
        width: 24px;
        height: 24px;
        border: none;
        background: none;
        color: #888;
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .feedback-popup-close:hover {
        background: #f0efea;
        color: #1a1a1a;
    }

    .feedback-textarea {
        width: 100%;
        min-height: 80px;
        max-height: 300px;
        padding: 0.75rem;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.875rem;
        resize: vertical;
        margin-bottom: 0.75rem;
    }

    .feedback-textarea:focus {
        outline: none;
        border-color: #d97757;
    }

    .feedback-popup-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .feedback-btn-cancel {
        padding: 0.5rem 1rem;
        border: 1px solid #e5e4df;
        background: white;
        border-radius: 6px;
        font-size: 0.8125rem;
        cursor: pointer;
        font-family: inherit;
    }

    .feedback-btn-cancel:hover {
        background: #f0efea;
    }

    .feedback-btn-submit {
        padding: 0.5rem 1rem;
        border: none;
        background: #1a1a1a;
        color: white;
        border-radius: 6px;
        font-size: 0.8125rem;
        cursor: pointer;
        font-family: inherit;
    }

    .feedback-btn-submit:hover {
        background: #333;
    }

    /* Legacy styles - keeping for compatibility */
    .message-header {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        margin-bottom: 0.625rem;
    }

    .avatar {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .avatar-user {
        background: #e5e4df;
        color: #666;
    }

    .avatar-assistant {
        background: #d97757;
        color: white;
    }

    .message-name {
        font-weight: 600;
        font-size: 0.875rem;
        color: #1a1a1a;
    }

    .message-body {
        color: #374151;
        line-height: 1.7;
        font-size: 0.9375rem;
    }

    .message-body p {
        margin-bottom: 0.875rem;
    }

    .message-body p:last-child {
        margin-bottom: 0;
    }

    .message-body ul {
        margin: 0.75rem 0;
        padding-left: 1.25rem;
    }

    .message-body li {
        margin-bottom: 0.375rem;
        color: #555;
    }

    .message-body strong {
        font-weight: 600;
        color: #1a1a1a;
    }

    /* Script output */
    .script-title {
        font-weight: 600;
        font-size: 1.125rem;
        color: #1a1a1a;
        margin: 1rem 0 0.75rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e5e4df;
    }

    /* RECORD sections - narration to record */
    .record-section {
        margin: 1rem 0;
        padding: 0.875rem 1rem;
        padding-right: 3rem;
        background: linear-gradient(135deg, #f8f7f4 0%, #f0efea 100%);
        border: 1px dashed #ccc;
        border-radius: 8px;
        position: relative;
    }

    .record-section::before {
        content: "üé§ RECORD THIS";
        position: absolute;
        top: -10px;
        left: 12px;
        background: #666;
        color: white;
        font-size: 0.625rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .record-section p {
        color: #555;
        font-style: italic;
        font-size: 0.9375rem;
        line-height: 1.6;
        margin: 0;
    }

    .record-section:hover {
        border-color: #999;
    }

    /* Record section hover actions */
    .record-section-actions {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .record-section:hover .record-section-actions {
        opacity: 1;
    }

    .record-section-action {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        background: #e8e7e2;
        color: #666;
    }

    .record-section-action:hover {
        background: #666;
        color: white;
    }

    .record-section-action svg {
        width: 14px;
        height: 14px;
    }

    /* VIDEO sections - actual clips (interactive) */
    .video-clip {
        margin: 1rem 0;
        padding: 0.875rem 1rem;
        padding-right: 3rem;
        background: #fff;
        border-left: 4px solid #d97757;
        border-radius: 0 8px 8px 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        position: relative;
        transition: box-shadow 0.15s;
    }

    .video-clip:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    .video-clip::before {
        content: "üé¨ VIDEO CLIP";
        position: absolute;
        top: -10px;
        left: 12px;
        background: #d97757;
        color: white;
        font-size: 0.625rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .video-clip p {
        color: #1a1a1a;
        font-size: 1rem;
        line-height: 1.6;
        margin: 0;
    }

    .video-clip .speaker {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: #888;
        font-style: normal;
    }

    /* Video clip hover actions */
    .video-clip-actions {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .video-clip:hover .video-clip-actions {
        opacity: 1;
    }

    .video-clip-action {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        background: #f5f4ef;
        color: #666;
    }

    .video-clip-action:hover {
        background: #d97757;
        color: white;
    }

    .video-clip-action svg {
        width: 14px;
        height: 14px;
    }

    .video-clip-action.playing {
        background: #d97757;
        color: white;
    }

    /* AUDIO sections - audio clips from Otter AI */
    .audio-clip {
        margin: 1rem 0;
        padding: 0.875rem 1rem;
        padding-right: 3rem;
        background: #fff;
        border-left: 4px solid #3b82f6;
        border-radius: 0 8px 8px 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        position: relative;
        transition: box-shadow 0.15s;
    }

    .audio-clip:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    .audio-clip::before {
        content: "üéôÔ∏è AUDIO CLIP";
        position: absolute;
        top: -10px;
        left: 12px;
        background: #3b82f6;
        color: white;
        font-size: 0.625rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .audio-clip p {
        color: #1a1a1a;
        font-size: 1rem;
        line-height: 1.6;
        margin: 0;
    }

    .audio-clip .speaker {
        display: block;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: #888;
        font-style: normal;
    }

    .audio-clip .audio-meta {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.5rem;
        font-size: 0.6875rem;
        color: #999;
    }

    .audio-clip .audio-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* Audio clip hover actions */
    .audio-clip-actions {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .audio-clip:hover .audio-clip-actions {
        opacity: 1;
    }

    .audio-clip-action {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        background: #f5f4ef;
        color: #666;
    }

    .audio-clip-action:hover {
        background: #3b82f6;
        color: white;
    }

    .audio-clip-action svg {
        width: 14px;
        height: 14px;
    }

    .audio-clip-action.playing {
        background: #3b82f6;
        color: white;
    }

    /* Audio clips section in response */
    .audio-clips-section {
        margin-top: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e5e4df;
    }

    .audio-clips-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .audio-clips-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
        color: #666;
    }

    .audio-clips-meta strong {
        color: #1a1a1a;
    }

    .audio-clips-list {
        display: none;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 0.5rem;
    }

    .audio-clips-list.open {
        display: flex;
    }

    .audio-item {
        display: flex;
        gap: 0.75rem;
        padding: 0.75rem;
        background: #faf9f7;
        border-radius: 8px;
        border: 1px solid #e5e4df;
        transition: all 0.15s;
    }

    .audio-item:hover {
        border-color: #3b82f6;
        background: #f8fafc;
    }

    .audio-item-play {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #3b82f6;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.15s;
    }

    .audio-item-play:hover {
        background: #2563eb;
        transform: scale(1.05);
    }

    .audio-item-play.playing {
        background: #1d4ed8;
    }

    .audio-item-play svg {
        width: 16px;
        height: 16px;
    }

    .audio-item-content {
        flex: 1;
        min-width: 0;
    }

    .audio-item-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .audio-item-text {
        font-size: 0.8125rem;
        color: #444;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .audio-item-meta {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.375rem;
        font-size: 0.6875rem;
        color: #888;
    }

    /* Legacy support */
    .clip-line {
        background: #faf9f7;
        border-left: 3px solid #d97757;
        padding: 0.75rem 1rem;
        margin: 0.5rem 0;
        border-radius: 0 6px 6px 0;
        font-size: 1rem;
        line-height: 1.6;
        color: #1a1a1a;
    }

    /* Clips section - Compact horizontal layout */
    .clips-section {
        margin-top: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e5e4df;
    }

    .clips-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .clips-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
        color: #666;
    }

    .clips-meta strong {
        color: #1a1a1a;
    }

    .toggle-clips {
        background: none;
        border: 1px solid #e5e4df;
        color: #666;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.6875rem;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.15s;
    }

    .toggle-clips:hover {
        background: #faf9f7;
        color: #1a1a1a;
    }

    .clips-list {
        display: none;
    }

    .clips-list.show {
        display: flex;
        flex-direction: column;
        gap: 1px;
        background: #e5e4df;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 0.5rem;
    }

    /* Compact clip row */
    .clip {
        display: flex;
        align-items: stretch;
        background: #fff;
        min-height: 64px;
    }

    .clip.verified .clip-thumb {
        border-left: 3px solid #22c55e;
    }

    /* Thumbnail container */
    .clip-thumb {
        position: relative;
        width: 100px;
        min-width: 100px;
        background: #1a1a1a;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border-left: 3px solid transparent;
    }

    .clip-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .clip-thumb-placeholder {
        color: #888;
        font-size: 0.625rem;
        text-align: center;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 0.25rem;
    }

    .clip-thumb-placeholder svg {
        width: 20px;
        height: 20px;
        opacity: 0.5;
    }

    .clip-thumb-loading {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .clip-thumb-loading svg {
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        color: #888;
    }

    .clip-thumb-play {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.4);
        opacity: 0;
        transition: opacity 0.15s;
    }

    .clip-thumb:hover .clip-thumb-play {
        opacity: 1;
    }

    .clip-thumb-play svg {
        width: 28px;
        height: 28px;
        color: white;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));
    }

    .clip-thumb-duration {
        position: absolute;
        bottom: 2px;
        right: 2px;
        background: rgba(0,0,0,0.8);
        color: white;
        font-size: 0.5625rem;
        padding: 1px 4px;
        border-radius: 2px;
        font-weight: 500;
        font-family: ui-monospace, monospace;
    }

    /* Clip content */
    .clip-content {
        flex: 1;
        padding: 0.5rem 0.75rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-width: 0;
        gap: 0.25rem;
    }

    .clip-top {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.6875rem;
    }

    .clip-num {
        font-weight: 700;
        color: #d97757;
        flex-shrink: 0;
    }

    .clip-title {
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .clip-verified {
        font-size: 0.5625rem;
        padding: 1px 4px;
        background: #dcfce7;
        color: #15803d;
        border-radius: 2px;
        font-weight: 600;
        text-transform: uppercase;
        flex-shrink: 0;
    }

    .clip-quote {
        font-size: 0.8125rem;
        color: #1a1a1a;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin: 0;
    }

    .clip-quote-full {
        display: none;
        position: absolute;
        left: 100px;
        right: 0;
        top: 100%;
        background: #fff;
        border: 1px solid #e5e4df;
        border-radius: 6px;
        padding: 0.75rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10;
        font-size: 0.8125rem;
        line-height: 1.5;
        color: #1a1a1a;
    }

    .clip:hover .clip-quote-full {
        display: block;
    }

    /* Compact action buttons */
    .clip-actions {
        display: flex;
        align-items: center;
        gap: 2px;
        padding: 0.5rem;
        flex-shrink: 0;
    }

    .clip-action {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s;
        position: relative;
    }

    .clip-action svg {
        width: 14px;
        height: 14px;
    }

    .clip-action-primary {
        background: #d97757;
        color: white;
    }

    .clip-action-primary:hover {
        background: #c56646;
    }

    .clip-action-secondary {
        background: #f5f4ef;
        color: #666;
    }

    .clip-action-secondary:hover {
        background: #e5e4df;
        color: #1a1a1a;
    }

    .clip-action:disabled {
        opacity: 0.5;
        cursor: wait;
    }

    .clip-action-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1a1a1a;
        color: white;
        font-size: 0.625rem;
        padding: 2px 6px;
        border-radius: 3px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s;
        margin-bottom: 4px;
    }

    .clip-action:hover .clip-action-tooltip {
        opacity: 1;
    }

    /* Loading spinner for actions */
    .clip-action svg.spin {
        animation: spin 1s linear infinite;
    }

    /* Edit button for transcript */
    .clip-edit-btn {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        padding: 2px;
        border-radius: 3px;
        display: inline-flex;
        align-items: center;
        margin-left: auto;
        opacity: 0;
        transition: opacity 0.15s, color 0.15s;
    }

    .clip:hover .clip-edit-btn {
        opacity: 1;
    }

    .clip-edit-btn:hover {
        color: #d97757;
        background: #f5f4ef;
    }

    /* Editable quote styles */
    .clip-quote-editing {
        background: white;
        border: 2px solid #d97757;
        border-radius: 4px;
        padding: 0.5rem;
        font-size: 0.8125rem;
        line-height: 1.4;
        width: 100%;
        min-height: 60px;
        resize: vertical;
        font-family: inherit;
    }

    .clip-quote-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .clip-quote-save, .clip-quote-cancel {
        padding: 0.25rem 0.5rem;
        font-size: 0.6875rem;
        border-radius: 4px;
        cursor: pointer;
        font-family: inherit;
        border: none;
    }

    .clip-quote-save {
        background: #d97757;
        color: white;
    }

    .clip-quote-save:hover {
        background: #c56646;
    }

    .clip-quote-cancel {
        background: #e5e4df;
        color: #666;
    }

    .clip-quote-cancel:hover {
        background: #d5d4cf;
    }

    .export-btn {
        margin-top: 0.75rem;
        width: 100%;
        padding: 0.625rem;
        background: #1a1a1a;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.8125rem;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
    }

    .export-btn:hover {
        background: #333;
    }

    .preview-btn {
        padding: 0.375rem 0.75rem;
        background: #d97757;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .preview-btn:hover {
        background: #c56646;
    }

    .preview-btn svg {
        width: 12px;
        height: 12px;
    }

    .download-btn {
        padding: 0.375rem 0.75rem;
        background: #1a1a1a;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        font-family: inherit;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .download-btn:hover {
        background: #333;
    }

    .download-btn:disabled {
        background: #999;
        cursor: wait;
    }

    .download-btn svg {
        width: 12px;
        height: 12px;
    }

    .download-btn svg.spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Video modal */
    .video-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .video-modal.show {
        display: flex;
    }

    .video-container {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
    }

    .video-container video {
        max-width: 100%;
        max-height: 80vh;
        border-radius: 8px;
    }

    .video-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        color: white;
    }

    .video-title {
        font-weight: 600;
        font-size: 0.875rem;
    }

    .video-time {
        font-size: 0.75rem;
        color: #999;
    }

    .close-modal {
        position: absolute;
        top: -2.5rem;
        right: 0;
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
    }

    .close-modal:hover {
        color: #d97757;
    }

    /* Input area */
    .input-area {
        position: fixed;
        bottom: 0;
        left: 280px;  /* Align with sidebar width */
        right: 0;
        background: #f5f4ef;
        border-top: 1px solid #e5e4df;
        padding: 1rem;
    }

    .input-wrap {
        max-width: 768px;
        width: 100%;
        margin: 0 auto;
        padding: 0 1.5rem;
        box-sizing: border-box;
    }

    .input-box {
        display: flex;
        align-items: center;
        background: #fff;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        overflow: hidden;
    }

    .input-box:focus-within {
        border-color: #d97757;
    }

    .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: none;
        font-size: 0.9375rem;
        color: #1a1a1a;
        background: transparent;
        outline: none;
        font-family: inherit;
        resize: none;
        min-height: 24px;
        max-height: 200px;
        line-height: 1.5;
        overflow-y: auto;
    }

    .chat-input::placeholder {
        color: #999;
    }

    .input-box {
        align-items: flex-end;
    }

    .send-btn {
        padding: 0.5rem;
        margin: 0.25rem;
        background: #1a1a1a;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
    }

    .send-btn:hover {
        background: #333;
    }

    .send-btn:disabled {
        background: #e5e4df;
        cursor: not-allowed;
    }

    .send-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Welcome screen - centered new chat view */
    .welcome-screen {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        text-align: center;
    }

    .welcome-greeting {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
    }

    .welcome-greeting-main {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .welcome-icon {
        width: 32px;
        height: 32px;
        color: #d97757;
    }

    .welcome-text {
        font-family: 'EB Garamond', Georgia, serif;
        font-size: 2rem;
        font-weight: 400;
        color: #1a1a1a;
    }

    .welcome-project-badge {
        display: none;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        background: #f5f4ef;
        border-radius: 1rem;
        font-size: 0.8125rem;
        color: #666;
    }

    .welcome-project-badge.visible {
        display: flex;
    }

    .welcome-project-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #d97757;
    }

    .welcome-input-container {
        width: 100%;
        max-width: 600px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 1rem;
    }

    .welcome-input {
        width: 100%;
        padding: 0.75rem;
        border: none;
        font-size: 1rem;
        font-family: inherit;
        resize: none;
        outline: none;
    }

    .welcome-input::placeholder {
        color: #999;
    }

    .welcome-input-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 0.5rem;
        border-top: 1px solid #f0efea;
        margin-top: 0.5rem;
    }

    .welcome-input-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .welcome-action-btn {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #888;
        transition: all 0.15s;
    }

    .welcome-action-btn:hover {
        background: #f0efea;
        color: #1a1a1a;
    }

    .welcome-action-btn svg {
        width: 18px;
        height: 18px;
    }

    .welcome-model-select {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .welcome-model-select select {
        padding: 0.375rem 0.5rem;
        border: 1px solid #e5e4df;
        border-radius: 6px;
        background: #fff;
        font-size: 0.8125rem;
        color: #444;
        cursor: pointer;
        font-family: inherit;
    }

    .welcome-send-btn {
        width: 36px;
        height: 36px;
        background: #d97757;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.15s;
    }

    .welcome-send-btn:hover {
        background: #c56647;
    }

    .welcome-send-btn svg {
        width: 18px;
        height: 18px;
    }

    .welcome-chips {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }

    .welcome-chip {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid #e5e4df;
        border-radius: 2rem;
        font-size: 0.875rem;
        color: #444;
        cursor: pointer;
        transition: all 0.15s;
    }

    .welcome-chip:hover {
        background: #f5f4ef;
        border-color: #d97757;
    }

    .welcome-chip svg {
        width: 16px;
        height: 16px;
        color: #888;
    }

    /* Model selector */
    .model-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .model-selector label {
        font-size: 0.75rem;
        color: #888;
        font-weight: 500;
    }

    .model-select {
        padding: 0.375rem 0.75rem;
        border: 1px solid #e5e4df;
        border-radius: 6px;
        background: #fff;
        font-size: 0.75rem;
        color: #444;
        cursor: pointer;
        font-family: inherit;
    }

    .model-select:focus {
        outline: none;
        border-color: #d97757;
    }

    .model-badge {
        font-size: 0.625rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .model-badge.claude {
        background: #d4a574;
        color: white;
    }

    .model-badge.openai {
        background: #10a37f;
        color: white;
    }

    /* Typing */
    .typing {
        display: flex;
        gap: 3px;
    }

    .typing span {
        width: 5px;
        height: 5px;
        background: #999;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing span:nth-child(1) { animation-delay: -0.32s; }
    .typing span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    .context-note {
        font-size: 0.75rem;
        color: #999;
        margin-top: 0.5rem;
    }

    /* Feedback buttons */
    .feedback-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e5e4df;
    }

    .feedback-btn {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.375rem 0.625rem;
        background: none;
        border: 1px solid #e5e4df;
        border-radius: 6px;
        color: #666;
        font-size: 0.75rem;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.15s;
    }

    .feedback-btn:hover {
        background: #faf9f7;
        color: #1a1a1a;
    }

    .feedback-btn.active-good {
        background: #dcfce7;
        border-color: #22c55e;
        color: #15803d;
    }

    .feedback-btn.active-bad {
        background: #fee2e2;
        border-color: #ef4444;
        color: #b91c1c;
    }

    .feedback-btn svg {
        width: 14px;
        height: 14px;
    }

    .feedback-thanks {
        font-size: 0.75rem;
        color: #22c55e;
        margin-left: 0.5rem;
    }

    /* Share modal */
    .share-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .share-modal.show {
        display: flex;
    }

    .share-modal-content {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        width: 100%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .share-modal h3 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .share-modal .close-btn {
        background: none;
        border: none;
        font-size: 1.25rem;
        cursor: pointer;
        color: #666;
    }

    .user-search {
        width: 100%;
        padding: 0.625rem;
        border: 1px solid #e5e4df;
        border-radius: 6px;
        font-size: 0.875rem;
        margin-bottom: 0.75rem;
    }

    .user-search:focus {
        outline: none;
        border-color: #d97757;
    }

    .search-results {
        max-height: 150px;
        overflow-y: auto;
        margin-bottom: 1rem;
    }

    .search-result {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 6px;
        cursor: pointer;
    }

    .search-result:hover {
        background: #f5f4ef;
    }

    .search-result-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #d97757;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .search-result-info {
        flex: 1;
    }

    .search-result-name {
        font-size: 0.875rem;
        font-weight: 500;
    }

    .search-result-email {
        font-size: 0.75rem;
        color: #666;
    }

    .participants-list {
        border-top: 1px solid #e5e4df;
        padding-top: 1rem;
    }

    .participants-list h4 {
        font-size: 0.75rem;
        color: #666;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
    }

    .participant-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0;
    }

    .participant-role {
        font-size: 0.625rem;
        background: #e5e4df;
        padding: 1px 6px;
        border-radius: 4px;
        color: #666;
    }

    .participant-role.owner {
        background: #d97757;
        color: white;
    }

    /* Clip comment button */
    .clip-comment-btn {
        position: relative;
    }

    .clip-comment-count {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #d97757;
        color: white;
        font-size: 0.5rem;
        min-width: 14px;
        height: 14px;
        border-radius: 7px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    /* Comment panel */
    .comment-panel {
        position: absolute;
        right: 100%;
        top: 0;
        width: 280px;
        background: white;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 20;
        margin-right: 0.5rem;
        display: none;
    }

    .comment-panel.show {
        display: block;
    }

    .comment-panel-header {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e4df;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .comment-panel-header h4 {
        font-size: 0.8125rem;
        font-weight: 600;
    }

    .comment-panel-close {
        background: none;
        border: none;
        cursor: pointer;
        color: #666;
    }

    .comments-list {
        max-height: 200px;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .comment-item {
        padding: 0.5rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        background: #f5f4ef;
    }

    .comment-author {
        font-size: 0.6875rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .comment-text {
        font-size: 0.75rem;
        color: #444;
        margin-top: 0.25rem;
    }

    .comment-time {
        font-size: 0.625rem;
        color: #888;
        margin-top: 0.25rem;
    }

    .comment-input-area {
        padding: 0.5rem;
        border-top: 1px solid #e5e4df;
    }

    .comment-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #e5e4df;
        border-radius: 6px;
        font-size: 0.75rem;
        resize: none;
        font-family: inherit;
    }

    .comment-input:focus {
        outline: none;
        border-color: #d97757;
    }

    .comment-hint {
        font-size: 0.625rem;
        color: #888;
        margin-top: 0.25rem;
    }

    /* Regenerate button */
    .clip-action.regenerate {
        background: #f0efea;
        color: #666;
    }

    .clip-action.regenerate:hover {
        background: #d97757;
        color: white;
    }

    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e5e4df;
    }

    .modal-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .modal-close {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        border-radius: 6px;
        color: #666;
        cursor: pointer;
        transition: all 0.15s;
    }

    .modal-close:hover {
        background: #f5f4ef;
        color: #1a1a1a;
    }

    .modal-close svg {
        width: 20px;
        height: 20px;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #444;
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-family: inherit;
        transition: border-color 0.15s;
    }

    .form-input:focus {
        outline: none;
        border-color: #d97757;
    }

    .form-textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-family: inherit;
        resize: vertical;
        min-height: 80px;
        transition: border-color 0.15s;
    }

    .form-textarea:focus {
        outline: none;
        border-color: #d97757;
    }

    .form-hint {
        font-size: 0.75rem;
        color: #888;
        margin-top: 0.375rem;
    }

    .color-picker {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.15s;
    }

    .color-option:hover {
        transform: scale(1.1);
    }

    .color-option.selected {
        border-color: #1a1a1a;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        border-top: 1px solid #e5e4df;
    }

    .btn {
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.15s;
    }

    .btn-secondary {
        background: #f5f4ef;
        border: 1px solid #e5e4df;
        color: #444;
    }

    .btn-secondary:hover {
        background: #e5e4df;
    }

    .btn-primary {
        background: #d97757;
        border: none;
        color: white;
    }

    .btn-primary:hover {
        background: #c56647;
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
</style>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span class="sidebar-logo">MV Internal</span>
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="Close sidebar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <path d="M9 3v18"/>
            </svg>
        </button>
    </div>

    <a href="/chat" class="new-chat-btn{% if view == 'new' %} active{% endif %}" id="newChatBtn">
        <div class="new-chat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
        </div>
        New chat
    </a>

    <nav class="sidebar-nav">
        <a href="/chat/recents" class="sidebar-nav-item{% if view == 'recents' %} active{% endif %}" id="chatsNavItem">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            Chats
        </a>
        <a href="/projects" class="sidebar-nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
            </svg>
            Projects
        </a>
        <div class="sidebar-section-header expanded" id="libraryHeader" onclick="toggleLibrarySection()">
            <div class="sidebar-section-header-left">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                Library
            </div>
            <svg class="sidebar-section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="sidebar-section-items expanded" id="librarySection">
            <a href="/videos" class="sidebar-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="23 7 16 12 23 17 23 7"/>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                </svg>
                Videos
            </a>
            <a href="/audio" class="sidebar-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18V5l12-2v13"/>
                    <circle cx="6" cy="18" r="3"/>
                    <circle cx="18" cy="16" r="3"/>
                </svg>
                Audio
            </a>
            <a href="/transcripts" class="sidebar-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                </svg>
                Transcripts
            </a>
            <a href="/personas" class="sidebar-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                Personas
            </a>
        </div>
    </nav>

    <div class="sidebar-divider"></div>

    <div class="sidebar-section">
        <div class="sidebar-section-title">Recents</div>
    </div>

    <div class="conversations-list" id="conversationsList">
        {% for group in sidebar_conv_groups %}
        <div class="recents-project-group">
            <div class="recents-project-header expanded" onclick="toggleRecentsProject('{{ group.project.id }}')">
                <span class="recents-project-dot" style="background: {{ group.project.color }}"></span>
                <span class="recents-project-name">{{ group.project.name }}</span>
                <svg class="recents-project-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="recents-project-items expanded" id="recents-project-{{ group.project.id }}">
                {% for conv in group.conversations %}
                <div class="conversation-item nested{% if conv.id == conversation_id %} active{% endif %}"
                     onclick="loadConversation('{{ conv.id }}')"
                     data-id="{{ conv.id }}"
                     data-title="{{ conv.title }}">
                    <div class="conversation-title">{{ conv.title }}</div>
                    <button class="chat-item-menu" onclick="event.stopPropagation(); openChatMenu(event, '{{ conv.id }}', '{{ conv.title|e }}')">‚Ä¢‚Ä¢‚Ä¢</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% for conv in sidebar_conv_ungrouped %}
        <div class="conversation-item{% if conv.id == conversation_id %} active{% endif %}"
             onclick="loadConversation('{{ conv.id }}')"
             data-id="{{ conv.id }}"
             data-title="{{ conv.title }}">
            <div class="conversation-title">{{ conv.title }}</div>
            <button class="chat-item-menu" onclick="event.stopPropagation(); openChatMenu(event, '{{ conv.id }}', '{{ conv.title|e }}')">‚Ä¢‚Ä¢‚Ä¢</button>
        </div>
        {% endfor %}
    </div>

    <!-- Shared chat menu dropdown -->
    <div id="chatMenu" class="chat-menu-dropdown">
        <button onclick="chatMenuAction('star')">
            <span class="menu-icon">‚òÜ</span>
            <span>Star</span>
        </button>
        <button onclick="chatMenuAction('rename')">
            <span class="menu-icon">‚úé</span>
            <span>Rename</span>
        </button>
        <button onclick="chatMenuAction('addToProject')">
            <span class="menu-icon">üìÅ</span>
            <span>Add to project</span>
        </button>
        <button onclick="chatMenuAction('delete')" class="menu-delete">
            <span class="menu-icon">üóë</span>
            <span>Delete</span>
        </button>
    </div>

    <div class="sidebar-footer" style="position: relative;">
        <div class="user-info">
            <div class="user-avatar">{{ session.get('user_name', 'U')[0].upper() }}</div>
            <div class="user-details">
                <span class="user-name">{{ session.get('user_name', 'User') }}</span>
            </div>
        </div>
        <button class="user-menu-btn" onclick="toggleUserMenu(event)" title="Menu">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </button>
        <div class="user-menu-dropdown" id="userMenuDropdown">
            <div class="user-menu-header">
                <div class="user-menu-email">{{ session.get('user_email', '') }}</div>
                {% if session.get('user_email') in ['joy@maurinventures.com'] %}
                <span class="user-menu-role">Admin</span>
                {% endif %}
            </div>
            <div class="user-menu-section">
                <a href="/ai-logs" class="user-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    AI Logs
                </a>
            </div>
            {% if session.get('user_email') in ['joy@maurinventures.com'] %}
            <div class="user-menu-section">
                <a href="/admin/invite" class="user-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="8.5" cy="7" r="4"/>
                        <line x1="20" y1="8" x2="20" y2="14"/>
                        <line x1="23" y1="11" x2="17" y2="11"/>
                    </svg>
                    Invite User
                </a>
            </div>
            {% endif %}
            <div class="user-menu-section">
                <a href="/logout" class="user-menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Log out
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Main Chat Area -->
<div class="main-content">
    <!-- Floating sidebar toggle (appears when sidebar is collapsed) -->
    <button class="sidebar-toggle-floating" onclick="toggleSidebar()" title="Open sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M9 3v18"/>
        </svg>
    </button>

    <!-- Chat header bar with project breadcrumb, title dropdown, and share -->
    <div class="chat-header-bar" id="chatHeaderBar">
        <div class="chat-header-left">
            <!-- Project link (shown when chat is in a project) -->
            <a href="#" class="chat-project-link" id="chatProjectLink" style="display: none;" onclick="goToProject(event)">
                <span class="project-dot" id="chatProjectDot"></span>
                <span id="chatProjectName">Project</span>
            </a>
            <span class="chat-breadcrumb-separator" id="chatBreadcrumb" style="display: none;">/</span>
            <!-- Chat title with dropdown -->
            <button class="chat-title-dropdown" id="chatTitleDropdown" onclick="openChatMenu(event, currentConversationId, document.getElementById('chatTitleText')?.textContent || 'Chat', true)">
                <span class="chat-title-text" id="chatTitleText">Chat</span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </button>
        </div>
        <button class="share-btn" onclick="shareChat()">Share</button>
    </div>

    <!-- Chats List View - shown only on /chat/recents route -->
    {% if view == 'recents' %}
    <div class="chats-list-view active" id="chatsListView">
        <div class="chats-list-header">
            <h1 class="chats-list-title">Chats</h1>
            <button class="chats-new-btn" onclick="createNewConversationFromList()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                New chat
            </button>
        </div>
        <div class="chats-search-wrapper">
            <input type="text" class="chats-search" id="chatsSearch" placeholder="Search your chats..." oninput="filterChatsList()">
        </div>
        <div class="chats-count-row">
            <span id="chatsCount">0 chats with MV Internal</span>
            <button class="chats-select-btn" onclick="toggleSelectMode()">Select</button>
        </div>
        <div class="chats-select-actions">
            <span class="select-count" id="selectCount">0 selected</span>
            <button class="select-action-btn" onclick="toggleSelectMode()">Cancel</button>
            <button class="select-action-btn danger" onclick="deleteSelectedChats()">Delete</button>
        </div>
        <div class="chats-list" id="chatsList">
            <!-- Chat items loaded dynamically -->
        </div>
    </div>
    {% endif %}

    <!-- Library List View - not used in route-based navigation -->
    {% if view == 'library' %}
    <div class="library-list-view active" id="libraryListView">
        <div class="library-list-header">
            <h1 class="library-list-title">Library</h1>
        </div>
        <div class="library-count-row">
            <span id="libraryCount">4 categories in your library</span>
        </div>
        <div class="library-categories">
            <a href="/videos" class="library-category-item">
                <div class="library-category-icon" style="background: #3b82f6">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="23 7 16 12 23 17 23 7"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                    </svg>
                </div>
                <div class="library-category-content">
                    <div class="library-category-title">Videos</div>
                    <div class="library-category-desc">Source videos and footage</div>
                </div>
                <span class="library-category-count" id="videosCount"></span>
            </a>
            <a href="/audio" class="library-category-item">
                <div class="library-category-icon" style="background: #8b5cf6">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18V5l12-2v13"/>
                        <circle cx="6" cy="18" r="3"/>
                        <circle cx="18" cy="16" r="3"/>
                    </svg>
                </div>
                <div class="library-category-content">
                    <div class="library-category-title">Audio</div>
                    <div class="library-category-desc">Audio recordings and clips</div>
                </div>
                <span class="library-category-count" id="audioCount"></span>
            </a>
            <a href="/transcripts" class="library-category-item">
                <div class="library-category-icon" style="background: #10b981">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                    </svg>
                </div>
                <div class="library-category-content">
                    <div class="library-category-title">Transcripts</div>
                    <div class="library-category-desc">Video and audio transcriptions</div>
                </div>
                <span class="library-category-count" id="transcriptsCount"></span>
            </a>
            <a href="/personas" class="library-category-item">
                <div class="library-category-icon" style="background: #f59e0b">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
                <div class="library-category-content">
                    <div class="library-category-title">Personas</div>
                    <div class="library-category-desc">AI voices for content generation</div>
                </div>
                <span class="library-category-count" id="personasCount"></span>
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Chat messages - shown for conversation view -->
    {% if view == 'conversation' %}
    <div class="chat-messages" id="chatMessages"></div>
    {% endif %}

    <!-- Welcome screen for new chats - shown for new chat view -->
    {% if view == 'new' %}
    <div class="welcome-screen" id="welcomeScreen" style="display: flex;">
        <div class="welcome-greeting">
            <div class="welcome-greeting-main">
                <svg class="welcome-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span class="welcome-text" id="welcomeText">Good afternoon, Joseph</span>
            </div>
            <div class="welcome-project-badge" id="welcomeProjectBadge">
                <span class="welcome-project-dot" id="welcomeProjectDot"></span>
                <span id="welcomeProjectName">Project Name</span>
            </div>
        </div>

        <div class="welcome-input-container">
            <textarea class="welcome-input" id="welcomeInput" placeholder="What do you want to create?" rows="2" onkeydown="handleWelcomeKeyDown(event)" oninput="autoResizeWelcome(this)"></textarea>
            <div class="welcome-input-footer">
                <div class="welcome-input-actions">
                    <button class="welcome-action-btn" title="Attach file">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
                        </svg>
                    </button>
                </div>
                <div class="welcome-model-select">
                    <select id="welcomeModelSelect">
                        <option value="claude-sonnet" selected>Claude 3.5 Sonnet</option>
                        <option value="claude-opus">Claude 3 Opus</option>
                        <option value="claude-haiku">Claude 3 Haiku</option>
                        <option value="gpt-4o">GPT-4o</option>
                    </select>
                    <button class="welcome-send-btn" onclick="sendWelcomeMessage()" id="welcomeSendBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="welcome-chips">
            <button class="welcome-chip" onclick="fillWelcomePrompt('Create a 60-second script about leadership')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                </svg>
                Create a script
            </button>
            <button class="welcome-chip" onclick="fillWelcomePrompt('Find powerful clips about innovation and technology')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                </svg>
                Find clips
            </button>
            <button class="welcome-chip" onclick="fillWelcomePrompt('What are the most inspiring moments in my video library?')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                Discover highlights
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Input area - shown for conversation view -->
    {% if view == 'conversation' %}
<div class="input-area">
    <div class="input-wrap">
        <div class="model-selector">
            <label>Model:</label>
            <select class="model-select" id="modelSelect">
                <optgroup label="Anthropic (Claude)">
                    <option value="claude-sonnet" selected>Claude 3.5 Sonnet (Recommended)</option>
                    <option value="claude-opus">Claude 3 Opus</option>
                    <option value="claude-haiku">Claude 3 Haiku (Fast)</option>
                </optgroup>
                <optgroup label="OpenAI">
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fast)</option>
                </optgroup>
            </select>
        </div>
        <div class="input-box">
            <textarea class="chat-input" id="chatInput" placeholder="What kind of script do you want to create?" rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
            </button>
        </div>
    </div>
</div>
    {% endif %}
</div> <!-- Close main-content -->

<!-- Video Preview Modal -->
<div class="video-modal" id="videoModal" onclick="closeModal(event)">
    <div class="video-container" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="closePreview()">&times;</button>
        <div class="video-header">
            <span class="video-title" id="previewTitle">Video Preview</span>
            <span class="video-time" id="previewTime"></span>
        </div>
        <video id="previewVideo" controls></video>
    </div>
</div>

<!-- Share Modal -->
<div class="share-modal" id="shareModal" onclick="closeShareModal(event)">
    <div class="share-modal-content" onclick="event.stopPropagation()">
        <h3>
            Share Conversation
            <button class="close-btn" onclick="closeShareModal()">&times;</button>
        </h3>
        <input type="text" class="user-search" id="userSearch" placeholder="Search team members by name or email..." oninput="searchUsers(this.value)">
        <div class="search-results" id="searchResults"></div>
        <div class="participants-list" id="participantsList">
            <h4>Participants</h4>
            <div id="participantsContent">Loading...</div>
        </div>
    </div>
</div>

<script src="/static/js/shared.js"></script>
<script>
// Route-based view (set by server)
const CURRENT_VIEW = '{{ view }}';
const CONVERSATION_ID = '{{ conversation_id or "" }}';
const PROJECT_ID = '{{ project_id or "" }}';

const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const conversationsList = document.getElementById('conversationsList');

let history = [];
let clips = [];
let audioClips = [];
let currentAudioPlayer = null;
let lastQuery = '';
let lastScript = '';
let lastModel = '';
let currentConversationId = CONVERSATION_ID || null;
let currentProjectId = null;
let currentProject = null;  // Full project info {id, name, color}
let conversations = [];

// Select mode state (for list views)
let isSelectMode = false;
let selectedChats = new Set();

// Chat menu state (defined early to avoid TDZ issues)
let menuChatId = null;
let menuChatTitle = null;

// Initialize based on route
document.addEventListener('DOMContentLoaded', async () => {
    // Sidebar data is now server-rendered by Jinja - no initial JS load needed

    // Initialize based on current route/view
    if (CURRENT_VIEW === 'recents') {
        // Chats list view - render list
        renderChatsList();
    } else if (CURRENT_VIEW === 'conversation' && CONVERSATION_ID) {
        // Conversation view - load the specific conversation
        await loadConversationData(CONVERSATION_ID);

        // Check for pending message from welcome screen
        const pendingMessage = sessionStorage.getItem('pendingMessage');
        const pendingModel = sessionStorage.getItem('pendingModel');
        if (pendingMessage) {
            sessionStorage.removeItem('pendingMessage');
            sessionStorage.removeItem('pendingModel');

            // Set the model if available
            const modelSelect = document.getElementById('modelSelect');
            if (modelSelect && pendingModel) {
                modelSelect.value = pendingModel;
            }

            // Put message in input and send
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = pendingMessage;
                await sendMessage();
            }
        }
    } else if (CURRENT_VIEW === 'new') {
        // New chat view - update greeting and set project context if provided
        updateWelcomeGreeting();
        if (PROJECT_ID) {
            currentProjectId = PROJECT_ID;
            // Fetch full project object for badge display
            try {
                const projRes = await fetch(`/api/projects/${PROJECT_ID}`);
                if (projRes.ok) {
                    const projData = await projRes.json();
                    currentProject = projData;
                    // Show welcome screen project badge
                    const projectBadge = document.getElementById('welcomeProjectBadge');
                    if (projectBadge) {
                        document.getElementById('welcomeProjectName').textContent = currentProject.name;
                        document.getElementById('welcomeProjectDot').style.background = currentProject.color || '#d97757';
                        projectBadge.classList.add('visible');
                    }
                }
            } catch (e) {
                console.error('Failed to load project:', e);
            }
        }
    }

    // Load library counts for sidebar
    loadLibraryCounts();
});

// Update welcome greeting based on time of day
function updateWelcomeGreeting() {
    const welcomeText = document.getElementById('welcomeText');
    if (!welcomeText) return;

    const hour = new Date().getHours();
    let greeting = 'Good morning';
    if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
    else if (hour >= 17) greeting = 'Good evening';
    welcomeText.textContent = `${greeting}, Joseph`;
}

// Load conversation data for conversation view
async function loadConversationData(conversationId) {
    try {
        const res = await fetch(`/api/conversations/${conversationId}`);
        const data = await res.json();

        currentConversationId = conversationId;
        currentProjectId = data.project_id || null;
        currentProject = data.project || null;
        history = [];
        clips = [];

        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) chatMessages.innerHTML = '';

        // Load messages
        if (data.messages && data.messages.length > 0) {
            for (const msg of data.messages) {
                if (msg.role === 'user') {
                    addMsg(msg.content, true);
                    history.push({ role: 'user', content: msg.content });
                } else {
                    addMsg(msg.content, false, msg.clips || [], 0);
                    history.push({ role: 'assistant', content: msg.content });
                    if (msg.clips && msg.clips.length > 0) {
                        clips = msg.clips;
                    }
                }
            }
        }

        // Update header project link if present
        const projectLink = document.getElementById('chatProjectLink');
        const breadcrumb = document.getElementById('chatBreadcrumb');
        if (projectLink && currentProject) {
            document.getElementById('chatProjectDot').style.background = currentProject.color || '#d97757';
            document.getElementById('chatProjectName').textContent = currentProject.name;
            projectLink.style.display = 'flex';
            if (breadcrumb) breadcrumb.style.display = 'inline';
        } else if (projectLink) {
            projectLink.style.display = 'none';
            if (breadcrumb) breadcrumb.style.display = 'none';
        }

        // Update chat header bar with title
        const chatTitleText = document.getElementById('chatTitleText');
        if (chatTitleText) {
            chatTitleText.textContent = data.title || 'Chat';
        }

        // Show header bar if there are messages
        const headerBar = document.getElementById('chatHeaderBar');
        if (headerBar && data.messages && data.messages.length > 0) {
            headerBar.classList.add('visible');
        }

    } catch (e) {
        console.error('Failed to load conversation:', e);
    }
}

// Navigate to a conversation (for use in onclick handlers)
function navigateToConversation(conversationId) {
    window.location.href = `/chat/${conversationId}`;
}

async function loadLibraryCounts() {
    try {
        // Load video count
        const videosRes = await fetch('/api/videos');
        if (videosRes.ok) {
            const videos = await videosRes.json();
            const count = Array.isArray(videos) ? videos.length : (videos.videos?.length || 0);
            document.getElementById('videosCount').textContent = count + ' items';
        }
    } catch (e) {
        console.error('Failed to load video count:', e);
    }

    try {
        // Load audio count
        const audioRes = await fetch('/api/audio');
        if (audioRes.ok) {
            const audio = await audioRes.json();
            const count = Array.isArray(audio) ? audio.length : (audio.recordings?.length || 0);
            document.getElementById('audioCount').textContent = count + ' items';
        }
    } catch (e) {
        document.getElementById('audioCount').textContent = '';
    }

    try {
        // Load transcript count
        const transcriptsRes = await fetch('/api/transcripts');
        if (transcriptsRes.ok) {
            const transcripts = await transcriptsRes.json();
            const count = Array.isArray(transcripts) ? transcripts.length : (transcripts.transcripts?.length || 0);
            document.getElementById('transcriptsCount').textContent = count + ' items';
        }
    } catch (e) {
        console.error('Failed to load transcript count:', e);
    }

    try {
        // Load persona count
        const personasRes = await fetch('/api/personas');
        if (personasRes.ok) {
            const personas = await personasRes.json();
            const count = Array.isArray(personas) ? personas.length : 0;
            document.getElementById('personasCount').textContent = count + ' items';
        }
    } catch (e) {
        console.error('Failed to load persona count:', e);
    }
}

// Projects List View Functions removed - will be rebuilt as /projects page

// showChatView - now route-based, navigates to appropriate chat route
function showChatView() {
    if (currentConversationId) {
        window.location.href = `/chat/${currentConversationId}`;
    } else {
        window.location.href = '/chat';
    }
}

function renderChatsList() {
    const chatsList = document.getElementById('chatsList');
    const chatsSearch = document.getElementById('chatsSearch');
    const chatsCount = document.getElementById('chatsCount');

    // Only render if elements exist (recents view)
    if (!chatsList) return;

    const searchTerm = chatsSearch ? chatsSearch.value.toLowerCase() : '';

    // Filter out empty chats (message_count === 0) and apply search
    const filteredChats = conversations.filter(conv =>
        conv.message_count > 0 && conv.title.toLowerCase().includes(searchTerm)
    );

    if (chatsCount) {
        chatsCount.textContent = `${filteredChats.length} chat${filteredChats.length !== 1 ? 's' : ''} with MV Internal`;
    }

    chatsList.innerHTML = filteredChats.map(conv => `
        <div class="chat-list-item" data-id="${conv.id}" onclick="openChatFromList('${conv.id}')">
            <input type="checkbox" class="chat-list-checkbox"
                   ${selectedChats.has(conv.id) ? 'checked' : ''}
                   onclick="event.stopPropagation(); toggleChatSelection('${conv.id}')">
            <div class="chat-list-content">
                <div class="chat-list-title">${escapeHtml(conv.title)}</div>
                <div class="chat-list-meta">Last message ${timeAgo(conv.updated_at)}</div>
            </div>
            <div class="chat-list-actions">
                <button class="chat-list-action-btn" onclick="event.stopPropagation(); deleteChatFromList('${conv.id}')" title="Delete">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

function filterChatsList() {
    renderChatsList();
}

function timeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);

    const intervals = [
        { label: 'year', seconds: 31536000 },
        { label: 'month', seconds: 2592000 },
        { label: 'day', seconds: 86400 },
        { label: 'hour', seconds: 3600 },
        { label: 'minute', seconds: 60 }
    ];

    for (const interval of intervals) {
        const count = Math.floor(seconds / interval.seconds);
        if (count >= 1) {
            return `${count} ${interval.label}${count !== 1 ? 's' : ''} ago`;
        }
    }
    return 'just now';
}

function openChatFromList(conversationId) {
    if (isSelectMode) {
        toggleChatSelection(conversationId);
        return;
    }
    // Navigate to conversation
    window.location.href = `/chat/${conversationId}`;
}

function createNewConversationFromList() {
    // Navigate to new chat
    window.location.href = '/chat';
}

function toggleSelectMode() {
    isSelectMode = !isSelectMode;
    const listView = document.getElementById('chatsListView');
    if (isSelectMode) {
        listView.classList.add('select-mode');
        selectedChats.clear();
    } else {
        listView.classList.remove('select-mode');
        selectedChats.clear();
    }
    renderChatsList();
    updateSelectCount();
}

function toggleChatSelection(conversationId) {
    if (selectedChats.has(conversationId)) {
        selectedChats.delete(conversationId);
    } else {
        selectedChats.add(conversationId);
    }
    renderChatsList();
    updateSelectCount();
}

function updateSelectCount() {
    document.getElementById('selectCount').textContent = `${selectedChats.size} selected`;
}

async function deleteSelectedChats() {
    if (selectedChats.size === 0) return;
    if (!confirm(`Delete ${selectedChats.size} conversation${selectedChats.size !== 1 ? 's' : ''}?`)) return;

    for (const id of selectedChats) {
        try {
            await fetch(`/api/conversations/${id}`, { method: 'DELETE' });
        } catch (e) {
            console.error('Failed to delete conversation:', e);
        }
    }

    // Refresh
    await loadConversations();
    toggleSelectMode();
    renderChatsList();
}

async function deleteChatFromList(conversationId) {
    if (!confirm('Delete this conversation?')) return;

    try {
        await fetch(`/api/conversations/${conversationId}`, { method: 'DELETE' });
        conversations = conversations.filter(c => c.id !== conversationId);
        renderConversations();
        renderChatsList();
    } catch (e) {
        console.error('Failed to delete conversation:', e);
    }
}

async function loadConversations() {
    try {
        const res = await fetch('/api/conversations');
        const data = await res.json();
        conversations = data.conversations || [];
        renderConversations();

        // If on recents view, re-render the list now that we have data
        if (CURRENT_VIEW === 'recents') {
            renderChatsList();
        }
    } catch (e) {
        console.error('Failed to load conversations:', e);
    }
}

function renderConversations() {
    // Group conversations by project - filter out empty chats (message_count === 0)
    // Empty chats are not shown in sidebar until first message is sent
    const projectGroups = {};
    const ungrouped = [];

    conversations.filter(conv => conv.message_count > 0).forEach(conv => {
        if (conv.project) {
            if (!projectGroups[conv.project.id]) {
                projectGroups[conv.project.id] = {
                    project: conv.project,
                    conversations: []
                };
            }
            projectGroups[conv.project.id].conversations.push(conv);
        } else {
            ungrouped.push(conv);
        }
    });

    let html = '';

    // Render project groups
    Object.values(projectGroups).forEach(group => {
        const isExpanded = localStorage.getItem(`recents_project_${group.project.id}`) !== 'false';
        html += `
            <div class="recents-project-group">
                <div class="recents-project-header ${isExpanded ? 'expanded' : ''}" onclick="toggleRecentsProject('${group.project.id}')">
                    <span class="recents-project-dot" style="background: ${group.project.color || '#d97757'}"></span>
                    <span class="recents-project-name">${escapeHtml(group.project.name)}</span>
                    <svg class="recents-project-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="recents-project-items ${isExpanded ? 'expanded' : ''}" id="recents-project-${group.project.id}">
                    ${group.conversations.map(conv => renderConversationItem(conv)).join('')}
                </div>
            </div>
        `;
    });

    // Render ungrouped conversations
    ungrouped.forEach(conv => {
        html += renderConversationItem(conv);
    });

    conversationsList.innerHTML = html;
}

function renderConversationItem(conv) {
    const escapedTitle = escapeHtml(conv.title).replace(/'/g, "\\'").replace(/"/g, '&quot;');
    return `
        <div class="conversation-item ${conv.id === currentConversationId ? 'active' : ''} ${conv.project ? 'nested' : ''}"
             onclick="loadConversation('${conv.id}')"
             data-id="${conv.id}"
             data-title="${escapeHtml(conv.title)}">
            <div class="conversation-title">${escapeHtml(conv.title)}</div>
            <button class="chat-item-menu" onclick="event.stopPropagation(); openChatMenu(event, '${conv.id}', '${escapedTitle}')">‚Ä¢‚Ä¢‚Ä¢</button>
        </div>
    `;
}

// toggleRecentsProject() - now in shared.js

// escapeHtml() and formatDate() - now in shared.js

async function createNewConversation(projectId = null) {
    // In route-based navigation, just create the conversation
    // View switching is handled by navigation

    // Check for existing empty chat (no messages) to reuse
    // If creating a project chat, look for empty chat in that specific project
    // If creating a regular chat, look for any empty chat without a project
    const emptyChat = conversations.find(c =>
        c.message_count === 0 &&
        (projectId ? c.project_id === projectId : !c.project_id)
    );

    if (emptyChat) {
        // Reuse existing empty chat
        currentConversationId = emptyChat.id;
        currentProjectId = emptyChat.project_id || null;
        currentProject = emptyChat.project || null;
        history = [];
        clips = [];
        renderConversations();
        clearChat();
        return;
    }

    try {
        const body = { title: 'New Chat' };
        if (projectId) {
            body.project_id = projectId;
        }

        const res = await fetch('/api/conversations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await res.json();

        // Add to list and select
        conversations.unshift({
            id: data.id,
            title: data.title,
            updated_at: data.created_at,
            message_count: 0,
            project_id: data.project_id,
            project: data.project || null
        });

        currentConversationId = data.id;
        currentProjectId = data.project_id || null;
        currentProject = data.project || null;
        history = [];
        clips = [];

        // Auto-expand project folder in sidebar when creating project chat
        if (currentProjectId) {
            localStorage.setItem(`recents_project_${currentProjectId}`, 'true');
        }

        renderConversations();
        clearChat();

        // Clear project param from URL
        if (window.location.search.includes('project=')) {
            window.history.replaceState({}, '', '/chat');
        }
    } catch (e) {
        console.error('Failed to create conversation:', e);
    }
}

async function loadConversation(conversationId) {
    // In route-based navigation, navigate to the conversation route
    // This is used by sidebar clicks and other navigation
    window.location.href = `/chat/${conversationId}`;
}

// Internal function to load conversation data without navigation
async function _loadConversationInternal(conversationId) {
    try {
        const res = await fetch(`/api/conversations/${conversationId}`);
        const data = await res.json();

        currentConversationId = conversationId;
        currentProjectId = data.project_id || null;
        currentProject = data.project || null;
        history = [];
        clips = [];
        chatMessages.innerHTML = '';
        renderConversations();

        // If no messages, show welcome screen; otherwise show chat interface
        if (!data.messages || data.messages.length === 0) {
            clearChat();
        } else {
            showChatInterface();
            // Load messages
            for (const msg of data.messages) {
                if (msg.role === 'user') {
                    addMsg(msg.content, true);
                    history.push({ role: 'user', content: msg.content });
                } else {
                    addMsg(msg.content, false, msg.clips || [], 0);
                    history.push({ role: 'assistant', content: msg.content });
                    if (msg.clips && msg.clips.length > 0) {
                        clips = msg.clips;
                    }
                }
            }
        }
    } catch (e) {
        console.error('Failed to load conversation:', e);
    }
}

async function renameConversation(conversationId) {
    const conv = conversations.find(c => c.id === conversationId);
    const newTitle = prompt('Rename conversation:', conv?.title || 'New Chat');
    if (!newTitle) return;

    try {
        await fetch(`/api/conversations/${conversationId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle })
        });

        // Update local state
        const idx = conversations.findIndex(c => c.id === conversationId);
        if (idx >= 0) {
            conversations[idx].title = newTitle;
            renderConversations();
        }
    } catch (e) {
        console.error('Failed to rename:', e);
    }
}

async function generateConversationTitle(conversationId, firstMessage) {
    try {
        const res = await fetch(`/api/conversations/${conversationId}/generate-title`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: firstMessage })
        });
        const data = await res.json();
        return data.title || null;
    } catch (e) {
        console.error('Failed to generate title:', e);
        return null;
    }
}

async function deleteConversation(conversationId) {
    if (!confirm('Delete this conversation?')) return;

    try {
        await fetch(`/api/conversations/${conversationId}`, {
            method: 'DELETE'
        });

        // Remove from list
        conversations = conversations.filter(c => c.id !== conversationId);
        renderConversations();

        // If deleted current, load another or create new
        if (currentConversationId === conversationId) {
            if (conversations.length > 0) {
                await loadConversation(conversations[0].id);
            } else {
                await createNewConversation();
            }
        }
    } catch (e) {
        console.error('Failed to delete:', e);
    }
}

function clearChat() {
    // Show welcome screen, hide messages and input
    chatMessages.innerHTML = '';
    chatMessages.style.display = 'none';
    document.getElementById('welcomeScreen').style.display = 'flex';
    document.querySelector('.input-area').style.display = 'none';

    // Hide header project link and header bar (welcome screen has its own)
    const projectLink = document.getElementById('chatProjectLink');
    const breadcrumb = document.getElementById('chatBreadcrumb');
    if (projectLink) projectLink.style.display = 'none';
    if (breadcrumb) breadcrumb.style.display = 'none';
    document.getElementById('chatHeaderBar')?.classList.remove('visible');

    // Update greeting based on time of day
    const hour = new Date().getHours();
    let greeting = 'Good morning';
    if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
    else if (hour >= 17) greeting = 'Good evening';
    document.getElementById('welcomeText').textContent = `${greeting}, Joseph`;

    // Show project badge if in a project context
    const projectBadge = document.getElementById('welcomeProjectBadge');
    if (currentProject) {
        document.getElementById('welcomeProjectName').textContent = currentProject.name;
        document.getElementById('welcomeProjectDot').style.background = currentProject.color || '#d97757';
        projectBadge.classList.add('visible');
    } else {
        projectBadge.classList.remove('visible');
    }

    // Focus the welcome input
    setTimeout(() => document.getElementById('welcomeInput').focus(), 100);
}

function showChatInterface() {
    // Hide welcome screen, show messages and input
    document.getElementById('welcomeScreen').style.display = 'none';
    chatMessages.style.display = '';  // Use CSS default (block)
    document.querySelector('.input-area').style.display = '';

    // Update header project badge
    updateHeaderProject();
}

function updateHeaderProject() {
    const projectLink = document.getElementById('chatProjectLink');
    const breadcrumb = document.getElementById('chatBreadcrumb');
    if (currentProject) {
        document.getElementById('chatProjectName').textContent = currentProject.name;
        document.getElementById('chatProjectDot').style.background = currentProject.color || '#d97757';
        if (projectLink) projectLink.style.display = 'flex';
        if (breadcrumb) breadcrumb.style.display = 'inline';
    } else {
        if (projectLink) projectLink.style.display = 'none';
        if (breadcrumb) breadcrumb.style.display = 'none';
    }
}

function goToProject(event) {
    event.preventDefault();
    if (currentProject) {
        window.location.href = `/project/${currentProject.id}`;
    }
}

// Welcome screen functions
function handleWelcomeKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendWelcomeMessage();
    }
}

function autoResizeWelcome(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 150) + 'px';
}

function fillWelcomePrompt(text) {
    const input = document.getElementById('welcomeInput');
    input.value = text;
    input.focus();
    autoResizeWelcome(input);
}

async function sendWelcomeMessage() {
    const welcomeInput = document.getElementById('welcomeInput');
    const msg = welcomeInput.value.trim();
    if (!msg) return;

    // Store message and model selection before navigating
    const welcomeModel = document.getElementById('welcomeModelSelect')?.value || 'claude-sonnet';

    // Create a new conversation (with project if set)
    try {
        const body = { title: 'New Chat' };
        if (currentProjectId) {
            body.project_id = currentProjectId;
        }
        const res = await fetch('/api/conversations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await res.json();

        // Store the pending message in sessionStorage so it can be sent after navigation
        sessionStorage.setItem('pendingMessage', msg);
        sessionStorage.setItem('pendingModel', welcomeModel);

        // Navigate to the conversation
        window.location.href = `/chat/${data.id}`;
    } catch (e) {
        console.error('Failed to create conversation:', e);
    }
}

function format(text) {
    // Remove JSON blocks and cleanup
    text = text.replace(/```json[\s\S]*?```/g, '');
    text = text.replace(/---/g, '');
    text = text.replace(/Why this works:[\s\S]*?(?=\n\n|$)/gi, '');
    text = text.replace(/Then provide JSON[\s\S]*?(?=\n\n|$)/gi, '');

    // Format script with title
    text = text.replace(/\*\*\[(.*?)\]\*\*/g, '<div class="script-title">$1</div>');

    // Format RECORD sections (narration to record) with interactive buttons
    // Track record index for actions
    let recordIdx = 0;

    text = text.replace(/\[RECORD:\s*(.*?)\]/g, (match, content) => {
        const idx = recordIdx++;
        return `<div class="record-section" data-record-idx="${idx}">
            <p>${content}</p>
            <div class="record-section-actions">
                <button class="record-section-action" onclick="regenerateRecord(${idx})" title="Regenerate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                </button>
                <button class="record-section-action" onclick="commentRecord(${idx})" title="Comment">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>
        </div>`;
    });
    text = text.replace(/\[VOICEOVER:\s*(.*?)\]/g, (match, content) => {
        const idx = recordIdx++;
        return `<div class="record-section" data-record-idx="${idx}">
            <p>${content}</p>
            <div class="record-section-actions">
                <button class="record-section-action" onclick="regenerateRecord(${idx})" title="Regenerate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                </button>
                <button class="record-section-action" onclick="commentRecord(${idx})" title="Comment">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>
        </div>`;
    });
    text = text.replace(/\[NARRATE:\s*(.*?)\]/g, (match, content) => {
        const idx = recordIdx++;
        return `<div class="record-section" data-record-idx="${idx}">
            <p>${content}</p>
            <div class="record-section-actions">
                <button class="record-section-action" onclick="regenerateRecord(${idx})" title="Regenerate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                </button>
                <button class="record-section-action" onclick="commentRecord(${idx})" title="Comment">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>
        </div>`;
    });

    // Format VIDEO sections with interactive buttons
    // Track clip index for matching with clips array
    let clipIdx = 0;

    // With speaker
    text = text.replace(/\[VIDEO:\s*"(.*?)"\s*‚Äî\s*(.*?)\]/gs, (match, quote, speaker) => {
        const idx = clipIdx++;
        return `<div class="video-clip" data-clip-idx="${idx}">
            <p>"${quote}"</p>
            <span class="speaker">‚Äî ${speaker}</span>
            <div class="video-clip-actions">
                <button class="video-clip-action" onclick="playScriptClip(${idx})" title="Preview">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button class="video-clip-action" onclick="regenerateScriptClip(${idx})" title="Find alternative">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                </button>
                <button class="video-clip-action" onclick="commentScriptClip(${idx})" title="Comment">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>
        </div>`;
    });

    // Without speaker
    text = text.replace(/\[VIDEO:\s*"(.*?)"\]/gs, (match, quote) => {
        const idx = clipIdx++;
        return `<div class="video-clip" data-clip-idx="${idx}">
            <p>"${quote}"</p>
            <div class="video-clip-actions">
                <button class="video-clip-action" onclick="playScriptClip(${idx})" title="Preview">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button class="video-clip-action" onclick="regenerateScriptClip(${idx})" title="Find alternative">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                </button>
                <button class="video-clip-action" onclick="commentScriptClip(${idx})" title="Comment">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>
        </div>`;
    });

    // Legacy CLIP format
    text = text.replace(/\[CLIP\s*\d*:\s*"(.*?)"\]/gs, (match, quote) => {
        const idx = clipIdx++;
        return `<div class="video-clip" data-clip-idx="${idx}">
            <p>"${quote}"</p>
            <div class="video-clip-actions">
                <button class="video-clip-action" onclick="playScriptClip(${idx})" title="Preview">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button class="video-clip-action" onclick="regenerateScriptClip(${idx})" title="Find alternative">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                </button>
                <button class="video-clip-action" onclick="commentScriptClip(${idx})" title="Comment">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
            </div>
        </div>`;
    });

    // Strip markdown formatting for clean, human-like text
    text = text.replace(/^#{1,6}\s+(.*)$/gm, '$1');  // Headers
    text = text.replace(/^[\*\-]\s+/gm, '‚Ä¢ ');       // Bullet lists to simple bullets
    text = text.replace(/^\d+\.\s+/gm, '');          // Remove numbered list markers
    text = text.replace(/```[\s\S]*?```/g, '');      // Remove code blocks
    text = text.replace(/`([^`]+)`/g, '$1');         // Inline code to plain text
    text = text.replace(/^\>\s+/gm, '');             // Remove blockquotes
    text = text.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1'); // Links to just text

    // Bold and italic
    text = text.replace(/\*\*([\s\S]*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*([\s\S]*?)\*/g, '<em>$1</em>');

    // Clean up extra whitespace
    text = text.replace(/\n{3,}/g, '\n\n');

    const paras = text.split('\n\n').filter(p => p.trim());
    return paras.map(p => {
        if (p.includes('script-title') || p.includes('narration') || p.includes('clip-line') || p.includes('video-clip')) return p;
        return `<p>${p.replace(/\n/g, '<br>')}</p>`;
    }).join('');
}

function addMsg(content, isUser, clipData = [], ctx = 0, audioClipData = []) {
    const div = document.createElement('div');
    const msgId = 'msg-' + Date.now();

    if (isUser) {
        // User message - right aligned bubble
        div.className = 'message-user';
        div.innerHTML = `<div class="message-bubble">${format(content)}</div>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return;
    }

    // Assistant message - left aligned, full width
    div.className = 'message-assistant';
    div.id = msgId;

    let html = `<div class="message-body">${format(content)}`;

    if (!isUser && clipData.length > 0) {
        clips = clipData;
        const dur = clipData.reduce((s, c) => s + (c.duration || c.end_time - c.start_time), 0);
        const verified = clipData.filter(c => c.verified).length;
        const id = 'clips-' + Date.now();

        html += `<div class="clips-section">
            <div class="clips-header">
                <div class="clips-meta">
                    <span><strong>${clipData.length}</strong> clips</span>
                    <span><strong>${dur.toFixed(0)}s</strong> total</span>
                    <span><strong>${verified}/${clipData.length}</strong> verified</span>
                </div>
                <button class="toggle-clips" onclick="toggle('${id}', this)">Show clips</button>
            </div>
            <div id="${id}" class="clips-list">`;

        clipData.forEach((c, i) => {
            const d = c.duration || c.end_time - c.start_time;
            const displayText = (c.text || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const displayTitle = (c.video_title || 'Unknown').replace(/"/g, '&quot;');
            const shortTitle = displayTitle.length > 35 ? displayTitle.substring(0, 35) + '...' : displayTitle;
            const thumbUrl = `/api/video-thumbnail/${c.video_id}?time=${c.start_time || 0}`;

            html += `
                <div class="clip ${c.verified ? 'verified' : ''}" style="position:relative;">
                    <div class="clip-thumb" onclick="previewClipByIndex(${i})" title="Preview clip">
                        <div class="clip-thumb-loading" id="thumb-loading-${i}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/></svg>
                        </div>
                        <img src="${thumbUrl}" alt="" style="display:none;" onload="this.style.display='block';document.getElementById('thumb-loading-${i}').style.display='none';" onerror="this.style.display='none';document.getElementById('thumb-loading-${i}').innerHTML='<svg viewBox=\\'0 0 24 24\\' fill=\\'currentColor\\' style=\\'opacity:0.3\\'><path d=\\'M4 4h16v16H4z\\'/><path d=\\'M10 9l5 3-5 3z\\' fill=\\'#1a1a1a\\'/></svg>';">
                        <div class="clip-thumb-play">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        </div>
                        <span class="clip-thumb-duration">${d.toFixed(1)}s</span>
                    </div>
                    <div class="clip-content">
                        <div class="clip-top">
                            <span class="clip-num">#${i + 1}</span>
                            <span class="clip-title">${shortTitle}</span>
                            ${c.verified ? '<span class="clip-verified">Verified</span>' : ''}
                            <button class="clip-edit-btn" onclick="editClipText(${i}, this)" title="Edit transcript">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                        </div>
                        <p class="clip-quote" data-clip-index="${i}">"${displayText}"</p>
                    </div>
                    <div class="clip-actions">
                        <button class="clip-action clip-action-primary" onclick="previewClipByIndex(${i})" title="Preview">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                            <span class="clip-action-tooltip">Preview</span>
                        </button>
                        <button class="clip-action clip-action-secondary" onclick="downloadClipByIndex(${i}, this)" title="Download clip">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                            <span class="clip-action-tooltip">Download</span>
                        </button>
                        <button class="clip-action clip-action-secondary" onclick="downloadFullVideo('${c.video_id}', this)" title="Download full source video">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M10 9l5 3-5 3z"/></svg>
                            <span class="clip-action-tooltip">Full Video</span>
                        </button>
                    </div>
                </div>`;
        });

        html += `</div><button class="export-btn" onclick="exportScript()">Export Script</button></div>`;
    }

    // Add audio clips section
    if (!isUser && audioClipData && audioClipData.length > 0) {
        audioClips = audioClipData;
        const totalDur = audioClipData.reduce((s, c) => s + (c.duration || 0), 0);
        const audioId = 'audio-clips-' + Date.now();

        html += `<div class="audio-clips-section">
            <div class="audio-clips-header">
                <div class="audio-clips-meta">
                    <span><strong>${audioClipData.length}</strong> audio clips</span>
                    <span><strong>${totalDur.toFixed(0)}s</strong> total</span>
                </div>
                <button class="toggle-clips" onclick="toggleAudioClips('${audioId}', this)">Show audio</button>
            </div>
            <div id="${audioId}" class="audio-clips-list">`;

        audioClipData.forEach((a, i) => {
            const displayText = (a.text || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const displayTitle = (a.audio_title || a.title || 'Unknown Recording').replace(/"/g, '&quot;');
            const shortTitle = displayTitle.length > 40 ? displayTitle.substring(0, 40) + '...' : displayTitle;
            const duration = a.duration ? a.duration.toFixed(1) + 's' : '';
            const speaker = a.speaker || '';

            html += `
                <div class="audio-item" data-audio-idx="${i}">
                    <button class="audio-item-play" onclick="playAudioClip(${i})" title="Play audio">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <div class="audio-item-content">
                        <div class="audio-item-title">${shortTitle}</div>
                        <p class="audio-item-text">"${displayText}"</p>
                        <div class="audio-item-meta">
                            ${speaker ? `<span>üéôÔ∏è ${speaker}</span>` : ''}
                            ${duration ? `<span>‚è±Ô∏è ${duration}</span>` : ''}
                            ${a.score ? `<span>üìä ${(a.score * 100).toFixed(0)}% match</span>` : ''}
                        </div>
                    </div>
                </div>`;
        });

        html += `</div></div>`;
    }

    if (!isUser && ctx > 0) {
        html += `<div class="context-note">Searched ${ctx.toLocaleString()} segments</div>`;
    }

    // Add message action buttons for all assistant messages
    const feedbackId = 'feedback-' + Date.now();
    const hasClips = clipData.length > 0;
    html += `</div>
        <div class="message-actions" style="position: relative;">
            <button class="message-action-btn" onclick="copyMessageContent('${msgId}')" title="Copy">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M12.5 3C13.3284 3 14 3.67157 14 4.5V6H15.5C16.3284 6 17 6.67157 17 7.5V15.5C17 16.3284 16.3284 17 15.5 17H7.5C6.67157 17 6 16.3284 6 15.5V14H4.5C3.67157 14 3 13.3284 3 12.5V4.5C3 3.67157 3.67157 3 4.5 3H12.5ZM14 12.5C14 13.3284 13.3284 14 12.5 14H7V15.5C7 15.7761 7.22386 16 7.5 16H15.5C15.7761 16 16 15.7761 16 15.5V7.5C16 7.22386 15.7761 7 15.5 7H14V12.5ZM4.5 4C4.22386 4 4 4.22386 4 4.5V12.5C4 12.7761 4.22386 13 4.5 13H12.5C12.7761 13 13 12.7761 13 12.5V4.5C13 4.22386 12.7761 4 12.5 4H4.5Z"/>
                </svg>
            </button>
            <button class="message-action-btn" onclick="handleGoodFeedback('${feedbackId}', this)" title="Good response">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9.56055 2C11.1381 2.00009 12.3211 3.44332 12.0117 4.99023L11.6094 7H13.8438C15.5431 7 16.836 8.52594 16.5566 10.2021L15.876 14.2842C15.6148 15.8513 14.2586 17 12.6699 17H4.5C3.67157 17 3 16.3284 3 15.5V9.23828C3.00013 8.57996 3.4294 7.99838 4.05859 7.80469L5.19824 7.4541L5.33789 7.40723C6.02983 7.15302 6.59327 6.63008 6.89746 5.9541L8.41113 2.58984L8.48047 2.46094C8.66235 2.17643 8.97898 2.00002 9.32324 2H9.56055ZM7.80957 6.36523C7.39486 7.2867 6.62674 7.99897 5.68359 8.3457L5.49219 8.41016L4.35254 8.76074C4.14305 8.82539 4.00013 9.01904 4 9.23828V15.5C4 15.7761 4.22386 16 4.5 16H12.6699C13.7697 16 14.7087 15.2049 14.8896 14.1201L15.5703 10.0381C15.7481 8.97141 14.9251 8 13.8438 8H11C10.8503 8 10.7083 7.9331 10.6133 7.81738C10.5184 7.70164 10.4805 7.54912 10.5098 7.40234L11.0312 4.79395C11.2167 3.86589 10.507 3.00009 9.56055 3H9.32324L7.80957 6.36523Z"/>
                </svg>
            </button>
            <button class="message-action-btn" onclick="openBadFeedback('${msgId}')" title="Bad response">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M12.6699 3C14.2586 3 15.6148 4.14871 15.876 5.71582L16.5566 9.79785C16.836 11.4741 15.5431 13 13.8438 13H11.6094L12.0117 15.0098C12.3211 16.5567 11.1381 17.9999 9.56055 18H9.32324C8.97898 18 8.66235 17.8236 8.48047 17.5391L8.41113 17.4102L6.89746 14.0459C6.59327 13.3699 6.02983 12.847 5.33789 12.5928L5.19824 12.5459L4.05859 12.1953C3.4294 12.0016 3.00013 11.42 3 10.7617V4.5C3 3.67157 3.67157 3 4.5 3H12.6699ZM4.5 4C4.22386 4 4 4.22386 4 4.5V10.7617C4.00013 10.981 4.14305 11.1746 4.35254 11.2393L5.49219 11.5898L5.68359 11.6543C6.62674 12.001 7.39486 12.7133 7.80957 13.6348L9.32324 17H9.56055C10.507 16.9999 11.2167 16.1341 11.0312 15.2061L10.5098 12.5977C10.4805 12.4509 10.5184 12.2984 10.6133 12.1826C10.7083 12.0669 10.8503 12 11 12H13.8438C14.9251 12 15.7481 11.0286 15.5703 9.96191L14.8896 5.87988C14.7087 4.79508 13.7697 4 12.6699 4H4.5Z"/>
                </svg>
            </button>
            <button class="message-action-btn" onclick="openRetryPopup('${msgId}')" title="Retry">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.3857 2.50977C14.3486 2.71054 17.5 5.98724 17.5 10C17.5 14.1421 14.1421 17.5 10 17.5C5.85786 17.5 2.5 14.1421 2.5 10C2.5 7.54619 3.67878 5.3677 5.49902 4H3C2.72386 4 2.5 3.77614 2.5 3.5C2.5 3.22386 2.72386 3 3 3H6.5C6.63261 3 6.75975 3.05272 6.85352 3.14648C6.92392 3.21689 6.97106 3.30611 6.99023 3.40234L7 3.5V7C7 7.27614 6.77614 7.5 6.5 7.5C6.22386 7.5 6 7.27614 6 7V4.87891C4.4782 6.06926 3.5 7.91979 3.5 10C3.5 13.5899 6.41015 16.5 10 16.5C13.5899 16.5 16.5 13.5899 16.5 10C16.5 6.5225 13.7691 3.68312 10.335 3.50879L10 3.5L9.89941 3.49023C9.67145 3.44371 9.5 3.24171 9.5 3C9.5 2.72386 9.72386 2.5 10 2.5L10.3857 2.50977Z"/>
                </svg>
            </button>

            <!-- Bad feedback popup -->
            <div class="feedback-popup" id="bad-feedback-${msgId}">
                <div class="feedback-popup-header">
                    <span class="feedback-popup-title">What could be improved?</span>
                    <button class="feedback-popup-close" onclick="closeFeedbackPopup('bad-feedback-${msgId}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    </button>
                </div>
                <textarea class="feedback-textarea" id="bad-feedback-text-${msgId}" placeholder="Tell us what was wrong with this response..." oninput="autoResizeFeedback(this)"></textarea>
                <div class="feedback-popup-actions">
                    <button class="feedback-btn-cancel" onclick="closeFeedbackPopup('bad-feedback-${msgId}')">Cancel</button>
                    <button class="feedback-btn-submit" onclick="submitBadFeedback('${msgId}')">Submit Feedback</button>
                </div>
            </div>

            <!-- Retry popup -->
            <div class="feedback-popup" id="retry-popup-${msgId}">
                <div class="feedback-popup-header">
                    <span class="feedback-popup-title">Edit and retry</span>
                    <button class="feedback-popup-close" onclick="closeFeedbackPopup('retry-popup-${msgId}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    </button>
                </div>
                <textarea class="feedback-textarea" id="retry-text-${msgId}" placeholder="Edit your message..." oninput="autoResizeFeedback(this)">${lastUserMessage.replace(/"/g, '&quot;')}</textarea>
                <div class="feedback-popup-actions">
                    <button class="feedback-btn-cancel" onclick="closeFeedbackPopup('retry-popup-${msgId}')">Cancel</button>
                    <button class="feedback-btn-submit" onclick="submitRetry('${msgId}')">Retry</button>
                </div>
            </div>
        </div>`;

    div.innerHTML = html;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addCopyMsg(content, persona, platform) {
    const div = document.createElement('div');
    div.className = 'message';

    const platformLabel = {
        'linkedin': 'LinkedIn',
        'x': 'X (Twitter)',
        'email': 'Email',
        'blog': 'Blog Post'
    }[platform] || platform;

    const platformIcon = {
        'linkedin': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19a.66.66 0 000 .14V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z"/></svg>',
        'x': '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>',
        'email': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
        'blog': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>'
    }[platform] || '';

    const copyId = 'copy-' + Date.now();

    let html = `
        <div class="message-header">
            <div class="avatar avatar-assistant">M</div>
            <span class="message-name">MV Copy</span>
            <span class="copy-badge" style="margin-left: 0.5rem; display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.125rem 0.5rem; background: var(--accent-light); color: var(--accent); border-radius: 1rem; font-size: 0.75rem;">
                ${platformIcon} ${platformLabel}
            </span>
            <span class="persona-badge" style="margin-left: 0.25rem; padding: 0.125rem 0.5rem; background: var(--border-light); color: var(--text-secondary); border-radius: 1rem; font-size: 0.75rem;">
                ${persona || 'Unknown'}'s voice
            </span>
        </div>
        <div class="message-body copy-content" id="${copyId}">
            <div class="copy-text" style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--accent); margin-bottom: 1rem; white-space: pre-wrap;">
${content}
            </div>
            <div class="copy-actions" style="display: flex; gap: 0.5rem;">
                <button class="btn btn-accent btn-sm" onclick="copyToClipboard('${copyId}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    Copy to clipboard
                </button>
            </div>
        </div>`;

    div.innerHTML = html;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function copyToClipboard(id) {
    const el = document.getElementById(id);
    const copyText = el.querySelector('.copy-text');
    if (copyText) {
        navigator.clipboard.writeText(copyText.innerText.trim()).then(() => {
            showToast('Copied to clipboard!', 'success');
        }).catch(() => {
            showToast('Failed to copy', 'error');
        });
    }
}

function copyMessageContent(msgId) {
    const msgEl = document.getElementById(msgId);
    if (msgEl) {
        const bodyEl = msgEl.querySelector('.message-body');
        if (bodyEl) {
            const text = bodyEl.innerText.trim();
            navigator.clipboard.writeText(text).then(() => {
                // Find the copy button and show success state
                const btn = msgEl.querySelector('.message-action-btn');
                if (btn) {
                    btn.classList.add('copied');
                    setTimeout(() => btn.classList.remove('copied'), 2000);
                }
                showToast('Copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }
    }
}

let lastUserMessage = '';

// Feedback popup functions
function openBadFeedback(msgId) {
    closeAllFeedbackPopups();
    const popup = document.getElementById('bad-feedback-' + msgId);
    if (popup) {
        popup.classList.add('active');
        popup.querySelector('textarea').focus();
    }
}

function openRetryPopup(msgId) {
    closeAllFeedbackPopups();
    const popup = document.getElementById('retry-popup-' + msgId);
    if (popup) {
        const textarea = popup.querySelector('textarea');
        textarea.value = lastUserMessage;
        popup.classList.add('active');
        textarea.focus();
        autoResizeFeedback(textarea);
    }
}

function closeFeedbackPopup(popupId) {
    const popup = document.getElementById(popupId);
    if (popup) {
        popup.classList.remove('active');
    }
}

function closeAllFeedbackPopups() {
    document.querySelectorAll('.feedback-popup.active').forEach(p => p.classList.remove('active'));
}

function autoResizeFeedback(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 300) + 'px';
}

async function handleGoodFeedback(feedbackId, btn) {
    btn.classList.add('active-good');
    showToast('Thanks for the feedback!', 'success');

    // Send feedback to API
    try {
        await fetch('/api/script-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                rating: 1,
                feedback: 'Good response (thumbs up)',
                query: lastUserMessage,
                script: clips.length > 0 ? JSON.stringify(clips) : '',
                conversation_id: currentConversationId
            })
        });
    } catch (e) {
        console.error('Feedback error:', e);
    }
}

async function submitBadFeedback(msgId) {
    const textarea = document.getElementById('bad-feedback-text-' + msgId);
    const feedbackText = textarea.value.trim();

    if (!feedbackText) {
        showToast('Please provide feedback', 'error');
        return;
    }

    closeFeedbackPopup('bad-feedback-' + msgId);

    // Mark button as active
    const msgEl = document.getElementById(msgId);
    if (msgEl) {
        const thumbsDownBtn = msgEl.querySelectorAll('.message-action-btn')[2];
        if (thumbsDownBtn) thumbsDownBtn.classList.add('active-bad');
    }

    showToast('Feedback submitted. Thank you!', 'success');

    // Send feedback to API
    try {
        await fetch('/api/script-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                rating: -1,
                feedback: feedbackText,
                query: lastUserMessage,
                script: clips.length > 0 ? JSON.stringify(clips) : '',
                conversation_id: currentConversationId
            })
        });
    } catch (e) {
        console.error('Feedback error:', e);
    }
}

async function submitRetry(msgId) {
    const textarea = document.getElementById('retry-text-' + msgId);
    const newMessage = textarea.value.trim();

    if (!newMessage) {
        showToast('Please enter a message', 'error');
        return;
    }

    closeFeedbackPopup('retry-popup-' + msgId);

    // Send retry feedback to API for quality improvement
    try {
        await fetch('/api/script-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                rating: 0,
                feedback: 'Retry with edit: ' + newMessage,
                query: lastUserMessage,
                script: clips.length > 0 ? JSON.stringify(clips) : '',
                conversation_id: currentConversationId
            })
        });
    } catch (e) {
        console.error('Retry feedback error:', e);
    }

    // Send the new message
    document.getElementById('chatInput').value = newMessage;
    sendMessage();
}

function retryLastMessage() {
    if (lastUserMessage) {
        document.getElementById('chatInput').value = lastUserMessage;
        sendMessage();
    }
}

// Close popups when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.feedback-popup') && !e.target.closest('.message-action-btn')) {
        closeAllFeedbackPopups();
    }
});

function showTyping() {
    const div = document.createElement('div');
    div.className = 'message-assistant';
    div.id = 'typing';
    div.innerHTML = `
        <div class="message-body">
            <div class="typing"><span></span><span></span><span></span></div>
        </div>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTyping() {
    const el = document.getElementById('typing');
    if (el) el.remove();
}

async function sendMessage() {
    const msg = chatInput.value.trim();
    if (!msg) return;

    lastUserMessage = msg;  // Save for retry
    addMsg(msg, true);
    history.push({ role: 'user', content: msg });

    chatInput.value = '';
    chatInput.style.height = 'auto';
    sendBtn.disabled = true;
    chatInput.disabled = true;
    showTyping();

    try {
        const model = document.getElementById('modelSelect').value;
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: msg,
                history: history,
                model: model,
                conversation_id: currentConversationId,
                previous_clips: clips || []  // Send previously used clips to avoid duplicates
            })
        });
        const data = await res.json();
        hideTyping();

        if (data.error) {
            addMsg('Error: ' + data.error, false);
        } else {
            // Track for feedback BEFORE rendering buttons
            lastQuery = msg;
            lastScript = data.response;
            lastModel = model;

            let text = data.response.replace(/```json[\s\S]*?```/g, '');

            // Handle copy generation vs video script differently
            if (data.is_copy) {
                addCopyMsg(text, data.persona, data.platform);
            } else {
                addMsg(text, false, data.clips || [], data.context_segments || 0, data.audio_clips || []);
            }
            history.push({ role: 'assistant', content: data.response });

            // Update conversation in sidebar
            const conv = conversations.find(c => c.id === currentConversationId);
            if (conv) {
                // Update message count
                conv.message_count = (conv.message_count || 0) + 2; // user + assistant

                // Show header bar now that there are messages
                const headerBar = document.getElementById('chatHeaderBar');
                if (headerBar) headerBar.classList.add('visible');

                // Generate AI title if this is the first message
                if (conv.title === 'New Chat') {
                    // Set temporary title immediately for responsiveness
                    conv.title = msg.substring(0, 30) + (msg.length > 30 ? '...' : '');
                    renderConversations();

                    // Update header title too
                    const chatTitleText = document.getElementById('chatTitleText');
                    if (chatTitleText) chatTitleText.textContent = conv.title;

                    // Generate better title with AI in background
                    generateConversationTitle(currentConversationId, msg).then(title => {
                        if (title) {
                            conv.title = title;
                            renderConversations();
                            // Update header title too
                            const chatTitleText = document.getElementById('chatTitleText');
                            if (chatTitleText) chatTitleText.textContent = title;
                        }
                    });
                } else {
                    renderConversations();
                }
            }
        }
    } catch (e) {
        hideTyping();
        addMsg('Connection error. Please try again.', false);
    }

    sendBtn.disabled = false;
    chatInput.disabled = false;
    chatInput.focus();
}

function send(text) {
    chatInput.value = text;
    sendMessage();
}

function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
    // Shift+Enter allows new line (default behavior)
}

function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}

function toggle(id, btn) {
    const el = document.getElementById(id);
    if (!btn) btn = el.previousElementSibling;
    el.classList.toggle('show');
    btn.textContent = el.classList.contains('show') ? 'Hide clips' : 'Show clips';
}

function toggleAudioClips(id, btn) {
    const el = document.getElementById(id);
    if (!btn) btn = el.previousElementSibling;
    el.classList.toggle('open');
    btn.textContent = el.classList.contains('open') ? 'Hide audio' : 'Show audio';
}

async function playAudioClip(idx) {
    if (!audioClips || !audioClips[idx]) {
        showToast('Audio clip not found', 'error');
        return;
    }

    const clip = audioClips[idx];
    const audioId = clip.audio_id;
    const startTime = clip.start_time || 0;
    const endTime = clip.end_time || null;

    // Stop current audio if playing
    if (currentAudioPlayer) {
        currentAudioPlayer.pause();
        currentAudioPlayer = null;
        // Remove playing state from all buttons
        document.querySelectorAll('.audio-item-play.playing').forEach(b => b.classList.remove('playing'));
    }

    // Get all play buttons and find the one for this index
    const playBtn = document.querySelector(`.audio-item[data-audio-idx="${idx}"] .audio-item-play`);
    if (playBtn) {
        playBtn.classList.add('playing');
        playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
    }

    try {
        // Fetch audio URL from API
        const res = await fetch(`/api/audio-clip/${audioId}?start=${startTime}${endTime ? '&end=' + endTime : ''}`);
        const data = await res.json();

        if (data.error) {
            showToast('Error loading audio: ' + data.error, 'error');
            if (playBtn) {
                playBtn.classList.remove('playing');
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            }
            return;
        }

        // Create audio element and play
        currentAudioPlayer = new Audio(data.url);
        currentAudioPlayer.currentTime = 0;

        currentAudioPlayer.onended = () => {
            if (playBtn) {
                playBtn.classList.remove('playing');
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            }
            currentAudioPlayer = null;
        };

        currentAudioPlayer.onerror = () => {
            showToast('Error playing audio', 'error');
            if (playBtn) {
                playBtn.classList.remove('playing');
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            }
            currentAudioPlayer = null;
        };

        await currentAudioPlayer.play();
    } catch (e) {
        showToast('Error playing audio: ' + e.message, 'error');
        if (playBtn) {
            playBtn.classList.remove('playing');
            playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
        }
    }
}

async function exportScript() {
    if (!clips.length) return;
    const name = prompt('Script name:', 'My Script');
    if (!name) return;

    try {
        // Trigger file download via the browser
        const res = await fetch('/api/chat/export-script', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                clips,
                title: name,
                script_text: lastScript
            })
        });

        if (res.ok) {
            // Create blob and trigger download
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name.replace(/[^\w\-_ ]/g, '_')}_script.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } else {
            const data = await res.json();
            alert('Export failed: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        console.error('Export error:', e);
        alert('Failed to export script');
    }
}

function downloadClipByIndex(index, btn) {
    if (clips && clips[index]) {
        downloadClip(clips[index], btn);
    } else {
        alert('Clip not found');
    }
}

// SVG icons for download states
const ICONS = {
    download: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>',
    spinner: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin"><circle cx="12" cy="12" r="10" stroke-opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/></svg>',
    success: '<svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>',
    error: '<svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>',
    video: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M10 9l5 3-5 3z"/></svg>'
};

async function downloadClip(clip, btn) {
    const originalIcon = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = ICONS.spinner;
    btn.title = 'Preparing clip...';

    try {
        const url = `/api/clip-download/${clip.video_id}?start=${clip.start_time}&end=${clip.end_time}`;

        // Fetch with proper error handling
        const response = await fetch(url);

        if (!response.ok) {
            // Try to get error message from JSON response
            let errorMsg = 'Download failed';
            try {
                const errorData = await response.json();
                errorMsg = errorData.error || errorMsg;
            } catch {
                errorMsg = `Server error (${response.status})`;
            }
            throw new Error(errorMsg);
        }

        // Get the blob and trigger download
        const blob = await response.blob();
        const filename = response.headers.get('Content-Disposition')?.match(/filename="(.+)"/)?.[1] || 'clip.mp4';

        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(downloadUrl);

        // Show success icon briefly
        btn.innerHTML = ICONS.success;
        btn.title = 'Downloaded!';
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
            btn.title = 'Download';
        }, 2000);

    } catch (e) {
        console.error('Download error:', e);
        // Show error icon
        btn.innerHTML = ICONS.error;
        btn.title = e.message || 'Download failed';

        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
            btn.title = 'Download';
        }, 3000);
    }
}

async function downloadFullVideo(videoId, btn) {
    const originalIcon = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = ICONS.spinner;
    btn.title = 'Starting download...';

    try {
        // Redirect to full video download
        window.location.href = `/api/video-download/${videoId}`;

        // Show success after redirect starts
        setTimeout(() => {
            btn.innerHTML = ICONS.success;
            btn.title = 'Download started!';
        }, 500);

        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
            btn.title = 'Download Full Video';
        }, 2500);
    } catch (e) {
        btn.innerHTML = ICONS.error;
        btn.title = 'Download failed';
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = originalIcon;
            btn.title = 'Download Full Video';
        }, 2000);
    }
}

async function sendFeedback(feedbackId, rating, btn) {
    try {
        const section = document.getElementById(feedbackId);
        const buttons = section.querySelectorAll('.feedback-btn');

        // Disable buttons
        buttons.forEach(b => b.disabled = true);

        const res = await fetch('/api/script-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query: lastQuery,
                script: lastScript,
                clips: clips,
                rating: rating,
                model: lastModel
            })
        });
        const data = await res.json();

        if (data.success) {
            // Update UI
            btn.classList.add(rating === 1 ? 'active-good' : 'active-bad');

            // Show thanks message
            const thanks = document.createElement('span');
            thanks.className = 'feedback-thanks';
            thanks.textContent = rating === 1 ? 'Thanks! This helps improve future scripts.' : 'Thanks for the feedback!';
            section.appendChild(thanks);

            // Hide other button
            buttons.forEach(b => {
                if (b !== btn) b.style.display = 'none';
            });
        }
    } catch (e) {
        console.error('Feedback error:', e);
    }
}

if (chatInput) chatInput.focus();

// Video preview functions
const videoModal = document.getElementById('videoModal');
const previewVideo = document.getElementById('previewVideo');
const previewTitle = document.getElementById('previewTitle');
const previewTime = document.getElementById('previewTime');
let currentClipEnd = 0;

function previewClipByIndex(index) {
    if (clips && clips[index]) {
        previewClip(clips[index]);
    } else {
        alert('Clip not found');
    }
}

async function previewClip(clip) {
    try {
        previewTitle.textContent = clip.video_title || 'Video Preview';
        previewTime.textContent = `${clip.start_time?.toFixed(1)}s - ${clip.end_time?.toFixed(1)}s`;

        // Show modal immediately
        videoModal.classList.add('show');

        // Get presigned URL for streaming
        const previewUrl = `/api/clip-preview/${clip.video_id}?start=${clip.start_time}&end=${clip.end_time}`;
        const res = await fetch(previewUrl);
        const data = await res.json();

        if (data.error) {
            alert('Error loading video: ' + data.error);
            closePreview();
            return;
        }

        // Use presigned URL with seek - fast and reliable
        previewVideo.src = data.url;
        currentClipEnd = data.end || clip.end_time || 0;
        const startTime = data.start || clip.start_time || 0;

        previewVideo.onloadedmetadata = () => {
            previewVideo.currentTime = startTime;
            previewVideo.play().catch(() => {}); // Ignore autoplay errors
        };

        previewVideo.ontimeupdate = () => {
            if (currentClipEnd > 0 && previewVideo.currentTime >= currentClipEnd) {
                previewVideo.pause();
                previewVideo.currentTime = startTime;
            }
        };

    } catch (e) {
        console.error('Preview error:', e);
        alert('Failed to load video preview');
        closePreview();
    }
}

// Transcript editing functions
function editClipText(index, btn) {
    const clip = clips[index];
    if (!clip) return;

    // Find the quote element
    const quoteEl = document.querySelector(`.clip-quote[data-clip-index="${index}"]`);
    if (!quoteEl) return;

    // Get current text (remove surrounding quotes)
    let currentText = clip.text || quoteEl.textContent;
    currentText = currentText.replace(/^[""]|[""]$/g, '').trim();

    // Replace with textarea
    const container = quoteEl.parentElement;
    const originalHTML = quoteEl.outerHTML;

    quoteEl.outerHTML = `
        <div class="clip-quote-edit-container">
            <textarea class="clip-quote-editing" data-clip-index="${index}">${currentText}</textarea>
            <div class="clip-quote-actions">
                <button class="clip-quote-save" onclick="saveClipText(${index})">Save</button>
                <button class="clip-quote-cancel" onclick="cancelClipEdit(${index}, '${encodeURIComponent(originalHTML)}')">Cancel</button>
            </div>
        </div>
    `;

    // Focus the textarea
    const textarea = container.querySelector('.clip-quote-editing');
    if (textarea) {
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    }
}

async function saveClipText(index) {
    const clip = clips[index];
    if (!clip) return;

    const textarea = document.querySelector(`.clip-quote-editing[data-clip-index="${index}"]`);
    if (!textarea) return;

    const newText = textarea.value.trim();
    if (!newText) {
        alert('Text cannot be empty');
        return;
    }

    try {
        const res = await fetch('/api/transcript-segment/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                video_id: clip.video_id,
                start_time: clip.start_time,
                end_time: clip.end_time,
                text: newText
            })
        });

        const data = await res.json();

        if (data.success) {
            // Update local clip data
            clip.text = newText;

            // Replace textarea with updated quote
            const container = textarea.closest('.clip-quote-edit-container');
            if (container) {
                container.outerHTML = `<p class="clip-quote" data-clip-index="${index}">"${newText.replace(/"/g, '&quot;')}"</p>`;
            }
        } else {
            alert('Failed to save: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        console.error('Save error:', e);
        alert('Failed to save changes');
    }
}

function cancelClipEdit(index, encodedOriginalHTML) {
    const container = document.querySelector('.clip-quote-edit-container');
    if (container) {
        container.outerHTML = decodeURIComponent(encodedOriginalHTML);
    }
}

function closePreview() {
    videoModal.classList.remove('show');
    previewVideo.pause();
    previewVideo.src = '';
    currentClipEnd = 0;
}

function closeModal(e) {
    if (e.target === videoModal) {
        closePreview();
    }
}

// Close on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && videoModal.classList.contains('show')) {
        closePreview();
    }
    if (e.key === 'Escape' && shareModal.classList.contains('show')) {
        closeShareModal();
    }
});

function deleteCurrentConversation() {
    if (currentConversationId) {
        deleteConversation(currentConversationId);
    } else {
        alert('No conversation selected');
    }
}

async function archiveConversation() {
    if (!currentConversationId) {
        alert('No conversation selected');
        return;
    }

    if (!confirm('Archive this conversation? It will be hidden from your list.')) return;

    try {
        const res = await fetch(`/api/conversations/${currentConversationId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ archived: true })
        });

        if (res.ok) {
            // Remove from list and load next conversation
            conversations = conversations.filter(c => c.id !== currentConversationId);
            renderConversations();

            if (conversations.length > 0) {
                await loadConversation(conversations[0].id);
            } else {
                await createNewConversation();
            }
        } else {
            alert('Failed to archive conversation');
        }
    } catch (e) {
        console.error('Archive error:', e);
        alert('Failed to archive conversation');
    }
}

// ============================================================================
// COLLABORATION FUNCTIONS
// ============================================================================

const shareModal = document.getElementById('shareModal');
let participantsCache = [];
let searchTimeout = null;

function openShareModal() {
    if (!currentConversationId) {
        alert('Please select a conversation first');
        return;
    }
    shareModal.classList.add('show');
    loadParticipants();
}

function closeShareModal(e) {
    if (!e || e.target === shareModal) {
        shareModal.classList.remove('show');
        document.getElementById('userSearch').value = '';
        document.getElementById('searchResults').innerHTML = '';
    }
}

async function loadParticipants() {
    try {
        const res = await fetch(`/api/conversations/${currentConversationId}/participants`);
        const data = await res.json();
        participantsCache = data.participants || [];
        renderParticipants();
    } catch (e) {
        console.error('Error loading participants:', e);
    }
}

function renderParticipants() {
    const container = document.getElementById('participantsContent');
    if (!participantsCache.length) {
        container.innerHTML = '<div style="color: #888; font-size: 0.75rem;">Only you have access</div>';
        return;
    }

    container.innerHTML = participantsCache.map(p => `
        <div class="participant-item">
            <div class="search-result-avatar">${(p.name || 'U')[0].toUpperCase()}</div>
            <div class="search-result-info">
                <div class="search-result-name">${escapeHtml(p.name)}</div>
                <div class="search-result-email">${escapeHtml(p.email)}</div>
            </div>
            <span class="participant-role ${p.role}">${p.role}</span>
        </div>
    `).join('');
}

async function searchUsers(query) {
    clearTimeout(searchTimeout);
    const resultsDiv = document.getElementById('searchResults');

    if (query.length < 2) {
        resultsDiv.innerHTML = '';
        return;
    }

    searchTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();

            // Filter out existing participants
            const participantIds = participantsCache.map(p => p.id);
            const available = (data.users || []).filter(u => !participantIds.includes(u.id));

            if (!available.length) {
                resultsDiv.innerHTML = '<div style="color: #888; font-size: 0.75rem; padding: 0.5rem;">No users found</div>';
                return;
            }

            resultsDiv.innerHTML = available.map(u => `
                <div class="search-result" onclick="inviteUser('${u.id}', '${escapeHtml(u.name)}')">
                    <div class="search-result-avatar">${u.name[0].toUpperCase()}</div>
                    <div class="search-result-info">
                        <div class="search-result-name">${escapeHtml(u.name)}</div>
                        <div class="search-result-email">${escapeHtml(u.email)}</div>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            console.error('Search error:', e);
        }
    }, 300);
}

async function inviteUser(userId, userName) {
    try {
        const res = await fetch(`/api/conversations/${currentConversationId}/invite`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
        });
        const data = await res.json();

        if (data.success) {
            document.getElementById('userSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
            loadParticipants();
        } else {
            alert(data.error || 'Failed to invite user');
        }
    } catch (e) {
        console.error('Invite error:', e);
        alert('Failed to invite user');
    }
}

// ============================================================================
// SCRIPT CLIP INTERACTIONS (hover actions on VIDEO CLIP blocks)
// ============================================================================

function playScriptClip(clipIdx) {
    if (clips && clips[clipIdx]) {
        previewClip(clips[clipIdx]);
    }
}

async function regenerateScriptClip(clipIdx) {
    console.log('[DEBUG] regenerateScriptClip called with clipIdx:', clipIdx);
    console.log('[DEBUG] clips array:', clips);
    console.log('[DEBUG] clips[clipIdx]:', clips ? clips[clipIdx] : 'clips is undefined');
    console.log('[DEBUG] currentConversationId:', currentConversationId);

    if (!clips || !clips[clipIdx]) {
        console.error('[DEBUG] No clip found at index', clipIdx, '- clips array length:', clips?.length);
        alert('Clip data not available. This may happen if you are trying to regenerate a clip from an older message. Try regenerating the entire response first.');
        return;
    }

    const clip = clips[clipIdx];
    const feedback = prompt('What kind of alternative are you looking for? (or leave blank for any alternative)');
    if (feedback === null) return; // cancelled

    const model = document.getElementById('modelSelect').value;
    const videoClipEl = document.querySelector(`.video-clip[data-clip-idx="${clipIdx}"]`);

    // Show loading state
    if (videoClipEl) {
        videoClipEl.style.opacity = '0.5';
    }

    try {
        const res = await fetch(`/api/clips/${currentConversationId}/${clipIdx}/regenerate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                feedback,
                original_clip: clip,
                history: history,
                model
            })
        });
        const data = await res.json();

        if (data.success && data.alternative_clips && data.alternative_clips.length > 0) {
            const newClip = data.alternative_clips[0];

            // Update clips array
            clips[clipIdx] = { ...newClip, verified: false };

            // Update the VIDEO CLIP display
            if (videoClipEl) {
                const pEl = videoClipEl.querySelector('p');
                if (pEl) {
                    pEl.textContent = `"${newClip.text}"`;
                }
                const speakerEl = videoClipEl.querySelector('.speaker');
                if (speakerEl && newClip.speaker) {
                    speakerEl.textContent = `‚Äî ${newClip.speaker}`;
                }
            }

            // Update the clips section thumbnail and quote
            const clipQuote = document.querySelector(`.clip-quote[data-clip-index="${clipIdx}"]`);
            if (clipQuote) {
                clipQuote.textContent = `"${newClip.text}"`;
            }
        } else {
            alert('Could not find an alternative clip. Try providing more specific feedback.');
        }
    } catch (e) {
        console.error('Regenerate error:', e);
        alert('Failed to regenerate clip');
    }

    if (videoClipEl) {
        videoClipEl.style.opacity = '1';
    }
}

function commentScriptClip(clipIdx) {
    if (!clips || !clips[clipIdx]) return;

    const comment = prompt('Add a comment (use @teammate to mention, @mv-video to regenerate):');
    if (!comment) return;

    // Submit comment
    fetch(`/api/clips/${currentConversationId}/${clipIdx}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: comment })
    }).then(res => res.json()).then(data => {
        if (data.success) {
            // If mentioned @mv-video, trigger regeneration
            if (data.comment.is_regenerate_request) {
                regenerateScriptClip(clipIdx);
            }
        }
    });
}

// ============================================================================
// RECORD SECTION INTERACTIONS (hover actions on RECORD THIS blocks)
// ============================================================================

async function regenerateRecord(recordIdx) {
    const recordEl = document.querySelector(`.record-section[data-record-idx="${recordIdx}"]`);
    if (!recordEl) return;

    const currentText = recordEl.querySelector('p')?.textContent || '';
    const feedback = prompt('What kind of alternative narration are you looking for? (or leave blank for any alternative)');
    if (feedback === null) return; // cancelled

    const model = document.getElementById('modelSelect').value;

    // Show loading state
    recordEl.style.opacity = '0.5';

    try {
        const res = await fetch(`/api/records/${currentConversationId}/${recordIdx}/regenerate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                feedback,
                original_text: currentText,
                history: history,
                model
            })
        });
        const data = await res.json();

        if (data.success && data.new_text) {
            // Update the RECORD section display
            const pEl = recordEl.querySelector('p');
            if (pEl) {
                pEl.textContent = data.new_text;
            }
        } else {
            alert('Could not generate an alternative. Try providing more specific feedback.');
        }
    } catch (e) {
        console.error('Regenerate record error:', e);
        alert('Failed to regenerate narration');
    }

    recordEl.style.opacity = '1';
}

function commentRecord(recordIdx) {
    const recordEl = document.querySelector(`.record-section[data-record-idx="${recordIdx}"]`);
    if (!recordEl) return;

    const currentText = recordEl.querySelector('p')?.textContent || '';
    const comment = prompt('Add a comment (use @mv-video to regenerate with feedback):');
    if (!comment) return;

    // Submit comment
    fetch(`/api/records/${currentConversationId}/${recordIdx}/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: comment, original_text: currentText })
    }).then(res => res.json()).then(data => {
        if (data.success) {
            // If mentioned @mv-video, trigger regeneration with the comment as feedback
            if (data.comment && data.comment.is_regenerate_request) {
                regenerateRecord(recordIdx);
            }
        }
    }).catch(e => {
        console.error('Comment error:', e);
    });
}

// ============================================================================
// CLIP COMMENTS & REGENERATION (legacy - for clips section)
// ============================================================================

let openCommentPanel = null;

async function toggleClipComments(clipIndex, btn) {
    const existingPanel = document.getElementById(`comment-panel-${clipIndex}`);

    // Close any open panel
    if (openCommentPanel && openCommentPanel !== existingPanel) {
        openCommentPanel.remove();
        openCommentPanel = null;
    }

    if (existingPanel) {
        existingPanel.remove();
        openCommentPanel = null;
        return;
    }

    // Create panel
    const panel = document.createElement('div');
    panel.className = 'comment-panel show';
    panel.id = `comment-panel-${clipIndex}`;
    panel.innerHTML = `
        <div class="comment-panel-header">
            <h4>Comments</h4>
            <button class="comment-panel-close" onclick="toggleClipComments(${clipIndex})">&times;</button>
        </div>
        <div class="comments-list" id="comments-list-${clipIndex}">Loading...</div>
        <div class="comment-input-area">
            <textarea class="comment-input" id="comment-input-${clipIndex}" placeholder="Add a comment..." rows="2" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();submitComment(${clipIndex});}"></textarea>
            <div class="comment-hint">@teammate to mention, @mv-video to regenerate</div>
        </div>
    `;

    btn.closest('.clip-actions').appendChild(panel);
    openCommentPanel = panel;

    // Load comments
    await loadClipComments(clipIndex);
}

async function loadClipComments(clipIndex) {
    try {
        const res = await fetch(`/api/clips/${currentConversationId}/${clipIndex}/comments`);
        const data = await res.json();

        const list = document.getElementById(`comments-list-${clipIndex}`);
        if (!data.comments || !data.comments.length) {
            list.innerHTML = '<div style="color: #888; font-size: 0.75rem; padding: 0.5rem;">No comments yet</div>';
            return;
        }

        list.innerHTML = data.comments.map(c => `
            <div class="comment-item">
                <div class="comment-author">${escapeHtml(c.user_name)}</div>
                <div class="comment-text">${formatCommentText(c.content)}</div>
                <div class="comment-time">${formatDate(c.created_at)}</div>
            </div>
        `).join('');
    } catch (e) {
        console.error('Error loading comments:', e);
    }
}

function formatCommentText(text) {
    // Highlight @mentions
    return escapeHtml(text).replace(/@(\w+(?:-\w+)*)/g, '<span style="color: #d97757; font-weight: 500;">@$1</span>');
}

async function submitComment(clipIndex) {
    const input = document.getElementById(`comment-input-${clipIndex}`);
    const content = input.value.trim();
    if (!content) return;

    try {
        const res = await fetch(`/api/clips/${currentConversationId}/${clipIndex}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content })
        });
        const data = await res.json();

        if (data.success) {
            input.value = '';
            await loadClipComments(clipIndex);

            // If mentioned @mv-video, trigger regeneration
            if (data.comment.is_regenerate_request && clips[clipIndex]) {
                regenerateClip(clipIndex, content);
            }
        }
    } catch (e) {
        console.error('Error submitting comment:', e);
    }
}

async function regenerateClip(clipIndex, feedback = '') {
    if (!clips[clipIndex]) return;

    const clip = clips[clipIndex];
    const model = document.getElementById('modelSelect').value;

    try {
        // Show loading state
        const btn = document.querySelector(`[data-regen-clip="${clipIndex}"]`);
        if (btn) {
            btn.innerHTML = ICONS.spinner;
            btn.disabled = true;
        }

        const res = await fetch(`/api/clips/${currentConversationId}/${clipIndex}/regenerate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                feedback,
                original_clip: clip,
                history: history,
                model
            })
        });
        const data = await res.json();

        if (data.success && data.alternative_clips && data.alternative_clips.length > 0) {
            // Replace the clip
            const newClip = data.alternative_clips[0];
            clips[clipIndex] = { ...newClip, verified: false };

            // Show success message
            alert(`Found alternative clip: "${newClip.text.substring(0, 100)}..."`);

            // TODO: Update the UI to show the new clip
        } else {
            alert('Could not find an alternative clip. Try providing more specific feedback.');
        }

        if (btn) {
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>';
            btn.disabled = false;
        }
    } catch (e) {
        console.error('Regenerate error:', e);
        alert('Failed to regenerate clip');
    }
}

// ============================================================================
// SIDEBAR & USER MENU FUNCTIONS
// ============================================================================
// toggleSidebar(), toggleLibrarySection() - now in shared.js
// Projects functionality removed - will be rebuilt as /projects page

function toggleUserMenu(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('userMenuDropdown');
    dropdown.classList.toggle('active');
}

// Close user menu when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('userMenuDropdown');
    if (dropdown && !e.target.closest('.sidebar-footer')) {
        dropdown.classList.remove('active');
    }
});

// ============================================================================
// CHAT MENU FUNCTIONS
// ============================================================================

function openChatMenu(event, chatId, chatTitle, fromHeader = false) {
    event.preventDefault();
    event.stopPropagation();

    const menu = document.getElementById('chatMenu');
    if (!menu) return;

    // Toggle off if same chat
    if (menu.classList.contains('open') && menuChatId === chatId) {
        closeChatMenu();
        return;
    }

    menuChatId = chatId;
    menuChatTitle = chatTitle;

    // Position the menu
    const rect = event.currentTarget.getBoundingClientRect();

    if (fromHeader) {
        // Below the title button
        menu.style.top = (rect.bottom + 6) + 'px';
        menu.style.left = rect.left + 'px';
    } else {
        // Next to the ‚Ä¢‚Ä¢‚Ä¢ button in sidebar
        menu.style.top = rect.top + 'px';
        menu.style.left = (rect.right + 6) + 'px';
    }

    menu.classList.add('open');

    // Adjust if off-screen
    setTimeout(() => {
        const menuRect = menu.getBoundingClientRect();
        if (menuRect.right > window.innerWidth) {
            menu.style.left = (rect.left - menuRect.width - 6) + 'px';
        }
        if (menuRect.bottom > window.innerHeight) {
            menu.style.top = (window.innerHeight - menuRect.height - 10) + 'px';
        }
    }, 0);
}

function closeChatMenu() {
    const menu = document.getElementById('chatMenu');
    if (menu) menu.classList.remove('open');
    menuChatId = null;
    menuChatTitle = null;
}

// Close on click outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.chat-item-menu') &&
        !e.target.closest('.chat-title-btn') &&
        !e.target.closest('.chat-menu-dropdown')) {
        closeChatMenu();
    }
});

// Close on Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeChatMenu();
});

function chatMenuAction(action) {
    if (!menuChatId) return;

    switch (action) {
        case 'star':
            showToast('Starring coming soon', 'info');
            break;

        case 'rename':
            const newName = prompt('Enter new name:', menuChatTitle);
            if (newName && newName.trim() && newName !== menuChatTitle) {
                fetch(`/api/conversations/${menuChatId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newName.trim() })
                })
                .then(r => {
                    if (r.ok) {
                        // Update sidebar item
                        const item = document.querySelector(`.conversation-item[data-id="${menuChatId}"]`);
                        if (item) {
                            const titleEl = item.querySelector('.conversation-title');
                            if (titleEl) titleEl.textContent = newName.trim();
                            item.dataset.title = newName.trim();
                        }
                        // Update header title if viewing this chat
                        if (currentConversationId === menuChatId) {
                            const headerTitle = document.getElementById('chatTitleText');
                            if (headerTitle) headerTitle.textContent = newName.trim();
                        }
                        showToast('Chat renamed', 'success');
                    } else {
                        showToast('Failed to rename', 'error');
                    }
                })
                .catch(() => showToast('Failed to rename', 'error'));
            }
            break;

        case 'addToProject':
            showToast('Project picker coming soon', 'info');
            break;

        case 'delete':
            if (confirm(`Delete "${menuChatTitle}"?`)) {
                fetch(`/api/conversations/${menuChatId}`, { method: 'DELETE' })
                .then(r => {
                    if (r.ok) {
                        // Remove from sidebar
                        const item = document.querySelector(`.conversation-item[data-id="${menuChatId}"]`);
                        if (item) item.remove();
                        // Navigate away if viewing this chat
                        if (currentConversationId === menuChatId) {
                            window.location.href = '/chat';
                        } else {
                            showToast('Chat deleted', 'success');
                        }
                    } else {
                        showToast('Failed to delete', 'error');
                    }
                })
                .catch(() => showToast('Failed to delete', 'error'));
            }
            break;
    }

    closeChatMenu();
}

function shareChat() {
    if (!currentConversationId) {
        showToast('No chat to share', 'error');
        return;
    }
    const url = window.location.origin + '/chat?conversation=' + currentConversationId;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(url)
            .then(() => showToast('Link copied to clipboard!', 'success'))
            .catch(() => {
                prompt('Copy this link:', url);
            });
    } else {
        prompt('Copy this link:', url);
    }
}

// Show/hide chat header bar based on conversation state
function updateChatHeaderBar() {
    const headerBar = document.getElementById('chatHeaderBar');
    const titleText = document.getElementById('chatTitleText');
    if (!headerBar) return;

    if (currentConversationId && history && history.length > 0) {
        headerBar.classList.add('visible');
        // Update title from current conversation
        const conv = conversations.find(c => c.id === currentConversationId);
        if (conv && titleText) {
            titleText.textContent = conv.title;
        }
    } else {
        headerBar.classList.remove('visible');
    }
}

// Sidebar state restoration - now handled by shared.js

// Toast notification system
function showToast(message, type = 'info', duration = 3000) {
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.cssText = 'position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.5rem;';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.style.cssText = `
        background: ${type === 'success' ? '#065f46' : type === 'error' ? '#991b1b' : '#1a1a1a'};
        color: white;
        padding: 0.875rem 1.25rem;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;
    toast.innerHTML = `<span>${message}</span>`;
    container.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
</style>

</body>
</html>
