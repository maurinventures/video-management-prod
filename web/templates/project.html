<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project - MV Internal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f5f4ef;
        min-height: 100vh;
        display: flex;
    }

    /* Sidebar styles */
    .sidebar {
        width: 260px;
        background: #faf9f7;
        border-right: 1px solid #e5e4df;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        height: 100vh;
        transition: width 0.2s ease, transform 0.2s ease;
    }

    .sidebar.collapsed {
        width: 0;
        transform: translateX(-260px);
    }

    .sidebar-header {
        padding: 1rem 1rem 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .sidebar-logo {
        font-family: 'EB Garamond', Georgia, serif;
        font-size: 1.25rem;
        font-weight: 500;
        color: #1a1a1a;
        letter-spacing: -0.01em;
        text-decoration: none;
    }

    .sidebar-toggle {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        transition: all 0.15s;
    }

    .sidebar-toggle:hover {
        background: #e5e4df;
        color: #1a1a1a;
    }

    .sidebar-toggle svg {
        width: 18px;
        height: 18px;
    }

    .sidebar-toggle-floating {
        position: fixed;
        top: 1rem;
        left: 1rem;
        width: 36px;
        height: 36px;
        border: 1px solid #e5e4df;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        color: #666;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        z-index: 100;
        transition: all 0.15s;
    }

    .sidebar.collapsed ~ .main-content .sidebar-toggle-floating {
        display: flex;
    }

    .sidebar-toggle-floating:hover {
        background: #f5f4ef;
        color: #1a1a1a;
    }

    .sidebar-toggle-floating svg {
        width: 20px;
        height: 20px;
    }

    .new-chat-btn {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        margin: 0 0 0.5rem;
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        border-radius: 6px;
        font-size: 0.875rem;
        color: #444;
        cursor: pointer;
        font-family: inherit;
        text-decoration: none;
        transition: background 0.15s;
    }

    .new-chat-btn:hover {
        background: #f5f4ef;
    }

    .new-chat-icon {
        width: 24px;
        height: 24px;
        border: 1.5px solid #888;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .new-chat-icon svg {
        width: 14px;
        height: 14px;
        color: #888;
    }

    .new-chat-btn:hover .new-chat-icon {
        border-color: #1a1a1a;
    }

    .new-chat-btn:hover .new-chat-icon svg {
        color: #1a1a1a;
    }

    .new-chat-btn svg {
        width: 16px;
        height: 16px;
    }

    .sidebar-nav {
        padding: 0;
        margin-bottom: 0.5rem;
    }

    .sidebar-nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 1rem;
        color: #444;
        text-decoration: none;
        font-size: 0.875rem;
        transition: all 0.15s;
        border-radius: 0;
        margin: 0;
    }

    .sidebar-nav-item:hover {
        background: #f0efea;
    }

    .sidebar-nav-item.active {
        background: #e5e4df;
        color: #1a1a1a;
        font-weight: 500;
    }

    .sidebar-nav-item svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
    }

    .sidebar-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 1rem;
        color: #444;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.15s;
        border-radius: 0;
        margin: 0;
    }

    .sidebar-section-header:hover {
        background: #f0efea;
    }

    .sidebar-section-header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .sidebar-section-header-left svg {
        width: 18px;
        height: 18px;
    }

    .sidebar-section-toggle {
        width: 16px;
        height: 16px;
        transition: transform 0.2s;
    }

    .sidebar-section-header.expanded .sidebar-section-toggle {
        transform: rotate(180deg);
    }

    .sidebar-section-items {
        display: none;
        padding-left: 0;
    }

    .sidebar-section-items.expanded {
        display: block;
    }

    .sidebar-section-items .sidebar-nav-item {
        padding-left: 2.75rem;
        font-size: 0.8125rem;
    }

    .projects-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .project-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem 0.5rem 2.75rem;
        font-size: 0.8125rem;
        color: #444;
        text-decoration: none;
        border-radius: 0;
        cursor: pointer;
        transition: background 0.15s;
    }

    .project-item:hover {
        background: #f5f4ef;
    }

    .project-item.active {
        background: #f0efea;
        font-weight: 500;
    }

    .project-color-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .project-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .project-count {
        font-size: 0.75rem;
        color: #888;
    }

    .create-project-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: calc(100% - 3.75rem);
        margin: 0.25rem 1rem 0.25rem 2.75rem;
        padding: 0.5rem 0.75rem;
        background: transparent;
        border: 1px dashed #ccc;
        border-radius: 6px;
        color: #666;
        font-size: 0.8125rem;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.15s;
    }

    .create-project-btn:hover {
        background: #f5f4ef;
        border-color: #d97757;
        color: #d97757;
    }

    .create-project-btn svg {
        width: 14px;
        height: 14px;
    }

    .sidebar-divider {
        height: 1px;
        background: #e5e4df;
        margin: 0.5rem 1rem;
    }

    .sidebar-section {
        padding: 0 1rem;
    }

    .sidebar-section-title {
        font-size: 0.75rem;
        font-weight: 500;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .sidebar-footer {
        margin-top: auto;
        padding: 1rem;
        border-top: 1px solid #e5e4df;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        background: #d97757;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .user-name {
        font-size: 0.875rem;
        color: #1a1a1a;
    }

    /* Main content */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    .project-header {
        padding: 1.5rem 2rem;
        background: white;
        border-bottom: 1px solid #e5e4df;
    }

    .project-header-top {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .project-color-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .project-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .project-description {
        font-size: 0.9375rem;
        color: #666;
        margin-top: 0.25rem;
    }

    .project-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .project-action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        color: #444;
        font-size: 0.875rem;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.15s;
    }

    .project-action-btn:hover {
        background: #f5f4ef;
        border-color: #d97757;
        color: #d97757;
    }

    .project-action-btn svg {
        width: 16px;
        height: 16px;
    }

    .project-action-btn.primary {
        background: #d97757;
        border-color: #d97757;
        color: white;
    }

    .project-action-btn.primary:hover {
        background: #c56647;
    }

    .project-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem 2rem;
    }

    .section-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 1rem;
    }

    .conversations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
    }

    .conversation-card {
        background: white;
        border: 1px solid #e5e4df;
        border-radius: 12px;
        padding: 1.25rem;
        cursor: pointer;
        transition: all 0.15s;
    }

    .conversation-card:hover {
        border-color: #d97757;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .conversation-card-title {
        font-size: 0.9375rem;
        font-weight: 500;
        color: #1a1a1a;
        margin-bottom: 0.5rem;
    }

    .conversation-card-date {
        font-size: 0.75rem;
        color: #888;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #888;
    }

    .empty-state svg {
        width: 48px;
        height: 48px;
        color: #ccc;
        margin-bottom: 1rem;
    }

    .empty-state-text {
        font-size: 0.9375rem;
        margin-bottom: 1rem;
    }

    .custom-instructions-section {
        background: #faf9f7;
        border: 1px solid #e5e4df;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 2rem;
    }

    .custom-instructions-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .custom-instructions-text {
        font-size: 0.875rem;
        color: #444;
        white-space: pre-wrap;
    }

    /* Modal styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e5e4df;
    }

    .modal-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .modal-close {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        border-radius: 6px;
        color: #666;
        cursor: pointer;
        transition: all 0.15s;
    }

    .modal-close:hover {
        background: #f5f4ef;
        color: #1a1a1a;
    }

    .modal-close svg {
        width: 20px;
        height: 20px;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #444;
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-family: inherit;
        transition: border-color 0.15s;
    }

    .form-input:focus {
        outline: none;
        border-color: #d97757;
    }

    .form-textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e4df;
        border-radius: 8px;
        font-size: 0.9375rem;
        font-family: inherit;
        resize: vertical;
        min-height: 80px;
        transition: border-color 0.15s;
    }

    .form-textarea:focus {
        outline: none;
        border-color: #d97757;
    }

    .form-hint {
        font-size: 0.75rem;
        color: #888;
        margin-top: 0.375rem;
    }

    .color-picker {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.15s;
    }

    .color-option:hover {
        transform: scale(1.1);
    }

    .color-option.selected {
        border-color: #1a1a1a;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        border-top: 1px solid #e5e4df;
    }

    .btn {
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.15s;
    }

    .btn-secondary {
        background: #f5f4ef;
        border: 1px solid #e5e4df;
        color: #444;
    }

    .btn-secondary:hover {
        background: #e5e4df;
    }

    .btn-primary {
        background: #d97757;
        border: none;
        color: white;
    }

    .btn-primary:hover {
        background: #c56647;
    }

    .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .btn-danger {
        background: #dc2626;
        border: none;
        color: white;
    }

    .btn-danger:hover {
        background: #b91c1c;
    }
</style>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <a href="/chat" class="sidebar-logo">MV Internal</a>
        <button class="sidebar-toggle" onclick="toggleSidebar()" title="Close sidebar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <path d="M9 3v18"/>
            </svg>
        </button>
    </div>

    <a href="/chat" class="new-chat-btn">
        <div class="new-chat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
        </div>
        New chat
    </a>

    <nav class="sidebar-nav">
        <a href="/chat" class="sidebar-nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            Chats
        </a>
        <div class="sidebar-section-header expanded" onclick="toggleProjectsSection()">
            <div class="sidebar-section-header-left">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
                Projects
            </div>
            <svg class="sidebar-section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="sidebar-section-items expanded" id="projectsSection">
            <div id="projectsList" class="projects-list">
                <!-- Projects loaded dynamically -->
            </div>
            <button class="create-project-btn" onclick="showCreateProjectModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Create project
            </button>
        </div>
        <div class="sidebar-section-header expanded" onclick="toggleLibrarySection()">
            <div class="sidebar-section-header-left">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                Library
            </div>
            <svg class="sidebar-section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
            </svg>
        </div>
        <div class="sidebar-section-items expanded" id="librarySection">
            <a href="/videos" class="sidebar-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="23 7 16 12 23 17 23 7"/>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                </svg>
                Videos
            </a>
            <a href="/transcripts" class="sidebar-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                </svg>
                Transcripts
            </a>
            <a href="/personas" class="sidebar-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                Personas
            </a>
        </div>
    </nav>

    <div class="sidebar-divider"></div>

    <div class="sidebar-footer">
        <div class="user-info">
            <div class="user-avatar">{{ session.get('user_name', 'U')[0].upper() }}</div>
            <span class="user-name">{{ session.get('user_name', 'User') }}</span>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <button class="sidebar-toggle-floating" onclick="toggleSidebar()" title="Open sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"/>
            <path d="M9 3v18"/>
        </svg>
    </button>

    <div class="project-header" id="projectHeader">
        <!-- Loaded dynamically -->
    </div>

    <div class="project-content" id="projectContent">
        <!-- Loaded dynamically -->
    </div>
</div>

<!-- Edit Project Modal -->
<div class="modal-overlay" id="editProjectModal" onclick="closeEditProjectModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 class="modal-title">Edit project</h2>
            <button class="modal-close" onclick="closeEditProjectModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label" for="editProjectName">Name</label>
                <input type="text" class="form-input" id="editProjectName">
            </div>
            <div class="form-group">
                <label class="form-label" for="editProjectDescription">Description (optional)</label>
                <textarea class="form-textarea" id="editProjectDescription"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="editProjectInstructions">Custom instructions (optional)</label>
                <textarea class="form-textarea" id="editProjectInstructions"></textarea>
                <div class="form-hint">The AI will follow these instructions for all conversations in this project.</div>
            </div>
            <div class="form-group">
                <label class="form-label">Color</label>
                <div class="color-picker" id="editColorPicker">
                    <div class="color-option" style="background: #d97757;" data-color="#d97757" onclick="selectEditProjectColor(this)"></div>
                    <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6" onclick="selectEditProjectColor(this)"></div>
                    <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectEditProjectColor(this)"></div>
                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectEditProjectColor(this)"></div>
                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectEditProjectColor(this)"></div>
                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectEditProjectColor(this)"></div>
                    <div class="color-option" style="background: #6366f1;" data-color="#6366f1" onclick="selectEditProjectColor(this)"></div>
                    <div class="color-option" style="background: #14b8a6;" data-color="#14b8a6" onclick="selectEditProjectColor(this)"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="deleteProject()" style="margin-right: auto;">Delete</button>
            <button class="btn btn-secondary" onclick="closeEditProjectModal()">Cancel</button>
            <button class="btn btn-primary" id="saveProjectBtn" onclick="saveProject()">Save changes</button>
        </div>
    </div>
</div>

<!-- Create Project Modal -->
<div class="modal-overlay" id="createProjectModal" onclick="closeCreateProjectModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 class="modal-title">Create project</h2>
            <button class="modal-close" onclick="closeCreateProjectModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label" for="projectName">Name</label>
                <input type="text" class="form-input" id="projectName" placeholder="e.g., Marketing Campaign Q1">
            </div>
            <div class="form-group">
                <label class="form-label" for="projectDescription">Description (optional)</label>
                <textarea class="form-textarea" id="projectDescription" placeholder="What is this project about?"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" for="projectInstructions">Custom instructions (optional)</label>
                <textarea class="form-textarea" id="projectInstructions" placeholder="Instructions for the AI when working in this project..."></textarea>
                <div class="form-hint">The AI will follow these instructions for all conversations in this project.</div>
            </div>
            <div class="form-group">
                <label class="form-label">Color</label>
                <div class="color-picker" id="colorPicker">
                    <div class="color-option selected" style="background: #d97757;" data-color="#d97757" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #3b82f6;" data-color="#3b82f6" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #6366f1;" data-color="#6366f1" onclick="selectProjectColor(this)"></div>
                    <div class="color-option" style="background: #14b8a6;" data-color="#14b8a6" onclick="selectProjectColor(this)"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateProjectModal()">Cancel</button>
            <button class="btn btn-primary" id="createProjectBtn" onclick="createNewProject()">Create project</button>
        </div>
    </div>
</div>

<script>
const projectId = '{{ project_id }}';
let currentProject = null;
let projects = [];
let selectedProjectColor = '#d97757';
let editProjectColor = '#d97757';

// Load project data
document.addEventListener('DOMContentLoaded', () => {
    loadProject();
    loadProjects();
});

async function loadProject() {
    try {
        const res = await fetch(`/api/projects/${projectId}`);
        if (res.ok) {
            currentProject = await res.json();
            renderProject();
        } else {
            window.location.href = '/chat';
        }
    } catch (e) {
        console.error('Failed to load project:', e);
        window.location.href = '/chat';
    }
}

function renderProject() {
    if (!currentProject) return;

    document.title = `${currentProject.name} - MV Internal`;

    const header = document.getElementById('projectHeader');
    header.innerHTML = `
        <div class="project-header-top">
            <div class="project-color-indicator" style="background: ${currentProject.color || '#d97757'};"></div>
            <h1 class="project-title">${escapeHtml(currentProject.name)}</h1>
        </div>
        ${currentProject.description ? `<p class="project-description">${escapeHtml(currentProject.description)}</p>` : ''}
        <div class="project-actions">
            <button class="project-action-btn primary" onclick="startNewChat()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                New chat
            </button>
            <button class="project-action-btn" onclick="showEditProjectModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Edit
            </button>
        </div>
    `;

    const content = document.getElementById('projectContent');
    let html = '';

    if (currentProject.custom_instructions) {
        html += `
            <div class="custom-instructions-section">
                <div class="custom-instructions-label">Custom Instructions</div>
                <div class="custom-instructions-text">${escapeHtml(currentProject.custom_instructions)}</div>
            </div>
        `;
    }

    html += '<div class="section-title">Conversations</div>';

    if (currentProject.conversations && currentProject.conversations.length > 0) {
        html += '<div class="conversations-grid">';
        currentProject.conversations.forEach(conv => {
            html += `
                <div class="conversation-card" onclick="openConversation('${conv.id}')">
                    <div class="conversation-card-title">${escapeHtml(conv.title)}</div>
                    <div class="conversation-card-date">${formatDate(conv.updated_at)}</div>
                </div>
            `;
        });
        html += '</div>';
    } else {
        html += `
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <div class="empty-state-text">No conversations yet</div>
                <button class="btn btn-primary" onclick="startNewChat()">Start a new chat</button>
            </div>
        `;
    }

    content.innerHTML = html;
}

function openConversation(convId) {
    window.location.href = `/chat?conversation=${convId}`;
}

function startNewChat() {
    // TODO: Create a new conversation in this project
    window.location.href = `/chat?project=${projectId}`;
}

// Projects list in sidebar
async function loadProjects() {
    try {
        const res = await fetch('/api/projects');
        if (res.ok) {
            projects = await res.json();
            renderProjects();
        }
    } catch (e) {
        console.error('Failed to load projects:', e);
    }
}

function renderProjects() {
    const projectsList = document.getElementById('projectsList');
    if (!projectsList) return;

    if (projects.length === 0) {
        projectsList.innerHTML = '<div style="padding: 0.5rem 1rem 0.5rem 2.25rem; font-size: 0.75rem; color: #888;">No projects yet</div>';
        return;
    }

    projectsList.innerHTML = projects.map(p => `
        <a href="/project/${p.id}" class="project-item ${p.id === projectId ? 'active' : ''}">
            <div class="project-color-dot" style="background: ${p.color || '#d97757'};"></div>
            <span class="project-name">${escapeHtml(p.name)}</span>
            <span class="project-count">${p.conversation_count || 0}</span>
        </a>
    `).join('');
}

// Edit project modal
function showEditProjectModal() {
    if (!currentProject) return;
    document.getElementById('editProjectName').value = currentProject.name;
    document.getElementById('editProjectDescription').value = currentProject.description || '';
    document.getElementById('editProjectInstructions').value = currentProject.custom_instructions || '';
    editProjectColor = currentProject.color || '#d97757';
    document.querySelectorAll('#editColorPicker .color-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.color === editProjectColor);
    });
    document.getElementById('editProjectModal').classList.add('active');
    document.getElementById('editProjectName').focus();
}

function closeEditProjectModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('editProjectModal').classList.remove('active');
}

function selectEditProjectColor(el) {
    editProjectColor = el.dataset.color;
    document.querySelectorAll('#editColorPicker .color-option').forEach(option => {
        option.classList.toggle('selected', option === el);
    });
}

async function saveProject() {
    const name = document.getElementById('editProjectName').value.trim();
    if (!name) {
        alert('Please enter a project name');
        return;
    }

    const btn = document.getElementById('saveProjectBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
        const res = await fetch(`/api/projects/${projectId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                description: document.getElementById('editProjectDescription').value.trim(),
                custom_instructions: document.getElementById('editProjectInstructions').value.trim(),
                color: editProjectColor
            })
        });

        if (res.ok) {
            closeEditProjectModal();
            await loadProject();
            await loadProjects();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to save project');
        }
    } catch (e) {
        console.error('Failed to save project:', e);
        alert('Failed to save project');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Save changes';
    }
}

async function deleteProject() {
    if (!confirm('Are you sure you want to delete this project? This cannot be undone.')) {
        return;
    }

    try {
        const res = await fetch(`/api/projects/${projectId}`, {
            method: 'DELETE'
        });

        if (res.ok) {
            window.location.href = '/chat';
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to delete project');
        }
    } catch (e) {
        console.error('Failed to delete project:', e);
        alert('Failed to delete project');
    }
}

// Create project modal (for sidebar)
function showCreateProjectModal() {
    document.getElementById('createProjectModal').classList.add('active');
    document.getElementById('projectName').focus();
    document.getElementById('projectName').value = '';
    document.getElementById('projectDescription').value = '';
    document.getElementById('projectInstructions').value = '';
    selectedProjectColor = '#d97757';
    document.querySelectorAll('#colorPicker .color-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.color === '#d97757');
    });
}

function closeCreateProjectModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('createProjectModal').classList.remove('active');
}

function selectProjectColor(el) {
    selectedProjectColor = el.dataset.color;
    document.querySelectorAll('#colorPicker .color-option').forEach(option => {
        option.classList.toggle('selected', option === el);
    });
}

async function createNewProject() {
    const name = document.getElementById('projectName').value.trim();
    if (!name) {
        alert('Please enter a project name');
        return;
    }

    const btn = document.getElementById('createProjectBtn');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    try {
        const res = await fetch('/api/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                description: document.getElementById('projectDescription').value.trim(),
                custom_instructions: document.getElementById('projectInstructions').value.trim(),
                color: selectedProjectColor
            })
        });

        if (res.ok) {
            const project = await res.json();
            window.location.href = `/project/${project.id}`;
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to create project');
        }
    } catch (e) {
        console.error('Failed to create project:', e);
        alert('Failed to create project');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Create project';
    }
}

// Sidebar toggle
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('collapsed');
    localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
}

function toggleProjectsSection() {
    const headers = document.querySelectorAll('.sidebar-section-header');
    const header = headers[0];
    const section = document.getElementById('projectsSection');
    header.classList.toggle('expanded');
    section.classList.toggle('expanded');
    localStorage.setItem('projectsExpanded', section.classList.contains('expanded'));
}

function toggleLibrarySection() {
    const headers = document.querySelectorAll('.sidebar-section-header');
    const header = headers[1];
    const section = document.getElementById('librarySection');
    header.classList.toggle('expanded');
    section.classList.toggle('expanded');
    localStorage.setItem('libraryExpanded', section.classList.contains('expanded'));
}

// Utilities
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
}

// Restore sidebar state
document.addEventListener('DOMContentLoaded', function() {
    const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (sidebarCollapsed) {
        document.getElementById('sidebar').classList.add('collapsed');
    }

    const projectsExpanded = localStorage.getItem('projectsExpanded');
    if (projectsExpanded === 'false') {
        const headers = document.querySelectorAll('.sidebar-section-header');
        headers[0].classList.remove('expanded');
        document.getElementById('projectsSection').classList.remove('expanded');
    }

    const libraryExpanded = localStorage.getItem('libraryExpanded');
    if (libraryExpanded === 'false') {
        const headers = document.querySelectorAll('.sidebar-section-header');
        headers[1].classList.remove('expanded');
        document.getElementById('librarySection').classList.remove('expanded');
    }
});
</script>
</body>
</html>
