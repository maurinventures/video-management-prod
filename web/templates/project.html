{% extends 'base.html' %}

{% block title %}{{ project.name if project else 'Project' }} - MV Internal{% endblock %}

{% block head %}
<style>

    /* Project header */
    .project-header { padding: 2rem 2rem 1.5rem; border-bottom: 1px solid var(--color-border); background: var(--color-bg); }
    .project-header-top { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    .project-back { width: 32px; height: 32px; border: none; background: transparent; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-text-secondary); transition: all 0.15s; text-decoration: none; }
    .project-back:hover { background: var(--color-hover); color: var(--color-text); }
    .project-back svg { width: 20px; height: 20px; }
    .project-color-lg { width: 16px; height: 16px; border-radius: 50%; flex-shrink: 0; }
    .project-title { font-size: 1.5rem; font-weight: 600; color: var(--color-text); flex: 1; }
    .project-actions { display: flex; gap: 0.5rem; }
    .project-action-btn { width: 36px; height: 36px; border: 1px solid var(--color-border); background: var(--color-bg); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-text-secondary); transition: all 0.15s; }
    .project-action-btn:hover { background: var(--color-hover); color: var(--color-text); border-color: var(--color-border-active); }
    .project-action-btn svg { width: 18px; height: 18px; }
    .project-description { font-size: 0.875rem; color: var(--color-text-secondary); margin-top: 0.5rem; max-width: 600px; }

    /* Project body */
    .project-body { padding: 1.5rem 2rem; }
    .project-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .project-section-title { font-size: 0.875rem; font-weight: 600; color: var(--color-text); }

    /* Conversations list */
    .project-conversations { background: var(--color-bg); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow: hidden; }
    .project-conversation-item { display: flex; align-items: center; padding: 1rem 1.25rem; border-bottom: 1px solid var(--color-border); cursor: pointer; transition: background 0.15s; text-decoration: none; color: inherit; }
    .project-conversation-item:last-child { border-bottom: none; }
    .project-conversation-item:hover { background: var(--color-bg-secondary); }
    .project-conversation-icon { width: 36px; height: 36px; background: var(--color-hover); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0; }
    .project-conversation-icon svg { width: 18px; height: 18px; color: var(--color-text-secondary); }
    .project-conversation-info { flex: 1; min-width: 0; }
    .project-conversation-title { font-size: 0.875rem; font-weight: 500; color: var(--color-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .project-conversation-meta { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem; }
    .project-conversation-arrow { color: var(--color-text-muted); }
    .project-conversation-arrow svg { width: 16px; height: 16px; }

    /* New chat in project */
    .new-chat-in-project { display: flex; align-items: center; padding: 1rem 1.25rem; border-bottom: 1px solid var(--color-border); cursor: pointer; transition: background 0.15s; }
    .new-chat-in-project:hover { background: #fef8f6; }
    .new-chat-in-project-icon { width: 36px; height: 36px; background: #fef3f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 1rem; }
    .new-chat-in-project-icon svg { width: 18px; height: 18px; color: var(--color-accent); }
    .new-chat-in-project-text { font-size: 0.875rem; font-weight: 500; color: var(--color-accent); }

    /* Empty state */
    .empty-conversations { padding: 3rem 2rem; text-align: center; }
    .empty-conversations svg { width: 48px; height: 48px; color: var(--color-text-muted); margin-bottom: 1rem; }
    .empty-conversations h3 { font-size: 1rem; font-weight: 600; color: var(--color-text); margin-bottom: 0.5rem; }
    .empty-conversations p { font-size: 0.875rem; color: var(--color-text-secondary); }

    /* Modal and form styles */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--color-bg); border-radius: 16px; width: 100%; max-width: 480px; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 1.125rem; font-weight: 600; color: var(--color-text); }
    .modal-close { width: 32px; height: 32px; border: none; background: transparent; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--color-text-secondary); transition: all 0.15s; }
    .modal-close:hover { background: var(--color-hover); color: var(--color-text); }
    .modal-close svg { width: 20px; height: 20px; }
    .modal-body { padding: 1.5rem; overflow-y: auto; }
    .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--color-border); display: flex; justify-content: flex-end; gap: 0.75rem; }

    .form-group { margin-bottom: 1.25rem; }
    .form-label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--color-text); margin-bottom: 0.5rem; }
    .form-input { width: 100%; padding: 0.625rem 0.75rem; border: 1px solid var(--color-border); border-radius: 8px; font-size: 0.875rem; font-family: inherit; transition: border-color 0.15s; background: var(--color-bg); color: var(--color-text); }
    .form-input:focus { outline: none; border-color: var(--color-accent); }
    textarea.form-input { resize: vertical; min-height: 80px; }

    .color-picker { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .color-option { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.15s; }
    .color-option:hover { transform: scale(1.1); }
    .color-option.selected { border-color: var(--color-text); }

    .btn { padding: 0.625rem 1.25rem; border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.15s; border: none; }
    .btn-primary { background: var(--color-accent); color: white; }
    .btn-primary:hover { background: #c56647; }
    .btn-secondary { background: var(--color-hover); color: var(--color-text); }
    .btn-secondary:hover { background: var(--color-active); }
    .btn-danger { background: #fee2e2; color: #dc2626; }
    .btn-danger:hover { background: #fecaca; }

    /* Dropdown menu styles */
    .dropdown { position: relative; }
    .dropdown-menu { position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: var(--color-bg); border: 1px solid var(--color-border); border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.12); min-width: 180px; display: none; overflow: hidden; z-index: 100; }
    .dropdown-menu.active { display: block; }
    .dropdown-item { display: flex; align-items: center; gap: 0.75rem; width: 100%; padding: 0.75rem 1rem; border: none; background: none; font-size: 0.875rem; color: var(--color-text); cursor: pointer; text-align: left; font-family: inherit; transition: background 0.15s; }
    .dropdown-item:hover { background: var(--color-hover); }
    .dropdown-item svg { width: 16px; height: 16px; color: var(--color-text-secondary); }
    .dropdown-item.danger { color: #dc2626; }
    .dropdown-item.danger svg { color: #dc2626; }
</style>
{% endblock %}

{% block content %}
<div class="project-header">
    <div class="project-header-top">
        <a href="/projects" class="project-back" title="Back to projects">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </a>
        <div class="project-color-lg" id="projectColor"></div>
        <h1 class="project-title" id="projectTitle">Loading...</h1>
        <div class="project-actions">
            <button class="project-action-btn" data-action="open-edit-modal" title="Edit project">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </button>
            <div class="dropdown">
                <button class="project-action-btn" data-action="toggle-dropdown" data-target-id="dropdownMenu" title="More options">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                </button>
                <div class="dropdown-menu" id="dropdownMenu">
                    <button class="dropdown-item danger" data-action="delete-project">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        Delete project
                    </button>
                </div>
            </div>
        </div>
    </div>
    <p class="project-description" id="projectDescription"></p>
</div>

<div class="project-body">
    <div class="project-section-header">
        <h2 class="project-section-title">Chats</h2>
    </div>
    <div class="project-conversations" id="projectConversations">
        <!-- Conversations loaded via JavaScript -->
    </div>
</div>
{% endblock %}

{% include '_dropdown_menu.html' %}

<!-- Edit Project Modal -->
<div class="modal-overlay" id="editModal" data-action="close-edit-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Edit project</h2>
            <button class="modal-close" data-action="close-edit-modal">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-input" id="editProjectName">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input" id="editProjectDesc"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Custom Instructions (for AI)</label>
                <textarea class="form-input" id="editProjectInstructions" placeholder="Give the AI context about this project..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Color</label>
                <div class="color-picker" id="editColorPicker">
                    <div class="color-option" style="background: #d97757" data-color="#d97757"></div>
                    <div class="color-option" style="background: #e5a336" data-color="#e5a336"></div>
                    <div class="color-option" style="background: #7cb342" data-color="#7cb342"></div>
                    <div class="color-option" style="background: #26a69a" data-color="#26a69a"></div>
                    <div class="color-option" style="background: #42a5f5" data-color="#42a5f5"></div>
                    <div class="color-option" style="background: #5c6bc0" data-color="#5c6bc0"></div>
                    <div class="color-option" style="background: #ab47bc" data-color="#ab47bc"></div>
                    <div class="color-option" style="background: #ec407a" data-color="#ec407a"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-action="close-edit-modal">Cancel</button>
            <button class="btn btn-primary" data-action="save-project">Save changes</button>
        </div>
    </div>
</div>

const PROJECT_ID = '{{ project_id }}';
let project = null;
let editColor = '#d97757';

function toggleDropdown(event) {
    event.stopPropagation();
    document.getElementById('dropdownMenu').classList.toggle('active');
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown')) {
        document.getElementById('dropdownMenu')?.classList.remove('active');
    }
});

async function loadProject() {
    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}`);
        if (response.ok) {
            project = await response.json();
            renderProject();
        } else if (response.status === 404) {
            window.location.href = '/projects';
        }
    } catch (error) {
        console.error('Failed to load project:', error);
    }
}

function renderProject() {
    document.title = `${project.name} - MV Internal`;
    document.getElementById('projectTitle').textContent = project.name;
    document.getElementById('projectColor').style.background = project.color || '#d97757';
    document.getElementById('projectDescription').textContent = project.description || '';
    document.getElementById('projectDescription').style.display = project.description ? 'block' : 'none';

    renderConversations();
}

function renderConversations() {
    const container = document.getElementById('projectConversations');
    const conversations = project.conversations || [];

    let html = `
        <div class="new-chat-in-project" data-action="start-new-chat">
            <div class="new-chat-in-project-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
            </div>
            <span class="new-chat-in-project-text">Start new chat</span>
        </div>
    `;

    if (conversations.length === 0) {
        html += `
            <div class="empty-conversations">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                <h3>No chats yet</h3>
                <p>Start a new chat to begin working in this project</p>
            </div>
        `;
    } else {
        conversations.forEach(conv => {
            html += `
                <a href="/chat?conversation=${conv.id}" class="project-conversation-item">
                    <div class="project-conversation-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <div class="project-conversation-info">
                        <div class="project-conversation-title">${escapeHtml(conv.title)}</div>
                        <div class="project-conversation-meta">${conv.message_count} message${conv.message_count !== 1 ? 's' : ''}</div>
                    </div>
                    <div class="project-conversation-arrow">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                    </div>
                </a>
            `;
        });
    }

    container.innerHTML = html;
}

function startNewChat() {
    window.location.href = `/chat?project=${PROJECT_ID}`;
}

function openEditModal() {
    document.getElementById('editProjectName').value = project.name;
    document.getElementById('editProjectDesc').value = project.description || '';
    document.getElementById('editProjectInstructions').value = project.custom_instructions || '';
    editColor = project.color || '#d97757';

    document.querySelectorAll('#editColorPicker .color-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.color === editColor);
    });

    document.getElementById('editModal').classList.add('active');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('active');
}

document.getElementById('editColorPicker').addEventListener('click', function(e) {
    const option = e.target.closest('.color-option');
    if (option) {
        document.querySelectorAll('#editColorPicker .color-option').forEach(el => el.classList.remove('selected'));
        option.classList.add('selected');
        editColor = option.dataset.color;
    }
});

async function saveProject() {
    const name = document.getElementById('editProjectName').value.trim();
    const description = document.getElementById('editProjectDesc').value.trim();
    const custom_instructions = document.getElementById('editProjectInstructions').value.trim();

    if (!name) {
        document.getElementById('editProjectName').focus();
        return;
    }

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, description, custom_instructions, color: editColor })
        });

        if (response.ok) {
            project = { ...project, name, description, custom_instructions, color: editColor };
            renderProject();
            closeEditModal();
            showToast('Project updated', 'success');
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to update project');
        }
    } catch (error) {
        console.error('Failed to update project:', error);
        alert('Failed to update project');
    }
}

async function deleteProject() {
    if (!confirm('Are you sure you want to delete this project? Chats will be preserved but unassigned.')) {
        return;
    }

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}?permanent=true`, {
            method: 'DELETE'
        });

        if (response.ok) {
            window.location.href = '/projects';
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to delete project');
        }
    } catch (error) {
        console.error('Failed to delete project:', error);
        alert('Failed to delete project');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadProject();
});
</script>
{% endblock %}
