{% extends "base_new.html" %}

{% block title %}{{ video_title }} - Transcript{% endblock %}

{% block content %}
<style>
    .transcript-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 2rem;
        gap: 1rem;
    }

    .transcript-info h1 {
        margin-bottom: 0.5rem;
    }

    .transcript-meta {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .transcript-meta-item {
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .transcript-meta-item svg {
        width: 14px;
        height: 14px;
    }

    .transcript-actions {
        display: flex;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    /* Speaker Legend */
    .speaker-legend {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
    }

    .speaker-legend-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }

    .speaker-legend-title {
        font-size: 0.8125rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .speaker-list {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .speaker-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 9999px;
        font-size: 0.8125rem;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .speaker-chip:hover {
        border-color: #d1d5db;
    }

    .speaker-chip.editing {
        padding: 0.25rem 0.5rem;
    }

    .speaker-chip input {
        border: none;
        background: transparent;
        font-size: 0.8125rem;
        width: 100px;
        font-family: inherit;
        padding: 0.125rem 0.25rem;
        border-radius: 4px;
    }

    .speaker-chip input:focus {
        outline: none;
        background: white;
    }

    .speaker-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .speaker-count {
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    /* Speaker Colors */
    .speaker-1 { background: #3b82f6; }
    .speaker-2 { background: #10b981; }
    .speaker-3 { background: #f59e0b; }
    .speaker-4 { background: #8b5cf6; }
    .speaker-5 { background: #ef4444; }
    .speaker-6 { background: #06b6d4; }
    .speaker-7 { background: #ec4899; }
    .speaker-8 { background: #84cc16; }

    /* Transcript Container */
    .transcript-container {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }

    .transcript-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: var(--bg);
        border-bottom: 1px solid var(--border);
    }

    .transcript-search {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        max-width: 300px;
    }

    .transcript-search input {
        flex: 1;
    }

    .transcript-stats {
        display: flex;
        gap: 1rem;
        color: var(--text-secondary);
        font-size: 0.8125rem;
    }

    /* Segments */
    .segments-list {
        max-height: 70vh;
        overflow-y: auto;
    }

    .segment {
        display: flex;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-light);
        gap: 1rem;
        transition: background 0.15s ease;
    }

    .segment:hover {
        background: var(--bg);
    }

    .segment:last-child {
        border-bottom: none;
    }

    .segment-speaker {
        flex-shrink: 0;
        width: 120px;
    }

    .speaker-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.625rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .speaker-badge:hover {
        opacity: 0.9;
        transform: scale(1.02);
    }

    .speaker-badge.speaker-1 { background: #dbeafe; color: #1e40af; }
    .speaker-badge.speaker-2 { background: #d1fae5; color: #065f46; }
    .speaker-badge.speaker-3 { background: #fef3c7; color: #92400e; }
    .speaker-badge.speaker-4 { background: #ede9fe; color: #5b21b6; }
    .speaker-badge.speaker-5 { background: #fee2e2; color: #991b1b; }
    .speaker-badge.speaker-6 { background: #cffafe; color: #0e7490; }
    .speaker-badge.speaker-7 { background: #fce7f3; color: #9d174d; }
    .speaker-badge.speaker-8 { background: #ecfccb; color: #3f6212; }

    .speaker-badge .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
    }

    .segment-content {
        flex: 1;
        min-width: 0;
    }

    .segment-text {
        color: var(--text);
        line-height: 1.7;
        font-size: 0.9375rem;
    }

    .segment-time {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .segment-time a {
        color: var(--info);
        text-decoration: none;
    }

    .segment-time a:hover {
        text-decoration: underline;
    }

    /* Highlight search matches */
    .highlight {
        background: var(--accent-light);
        color: var(--text);
        padding: 0.125rem 0.25rem;
        border-radius: 2px;
    }

    /* Speaker Edit Dropdown */
    .speaker-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        min-width: 180px;
        z-index: 100;
        padding: 0.375rem;
        display: none;
    }

    .speaker-dropdown.show {
        display: block;
    }

    .speaker-dropdown-item {
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8125rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: background 0.1s ease;
    }

    .speaker-dropdown-item:hover {
        background: var(--border-light);
    }

    .speaker-dropdown-input {
        padding: 0.5rem 0.75rem;
        border-top: 1px solid var(--border-light);
        margin-top: 0.375rem;
        padding-top: 0.625rem;
    }

    .speaker-dropdown-input input {
        width: 100%;
        padding: 0.375rem 0.5rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.8125rem;
    }

    .speaker-dropdown-input input:focus {
        outline: none;
        border-color: var(--accent);
    }

    /* Relative positioning for dropdown */
    .segment-speaker {
        position: relative;
    }

    /* Loading state */
    .identifying-speakers {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        background: var(--info-light);
        color: #1e40af;
        font-size: 0.875rem;
    }

    /* Back link */
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        margin-bottom: 1rem;
        transition: color 0.15s ease;
    }

    .back-link:hover {
        color: var(--text);
    }

    .back-link svg {
        width: 16px;
        height: 16px;
    }
</style>

<a href="/transcripts" class="back-link">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
    Back to Transcripts
</a>

<div class="transcript-header">
    <div class="transcript-info">
        <h1>{{ video_title }}</h1>
        <div class="transcript-meta">
            <div class="transcript-meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/>
                    <line x1="7" y1="2" x2="7" y2="22"/>
                    <line x1="17" y1="2" x2="17" y2="22"/>
                    <line x1="2" y1="12" x2="22" y2="12"/>
                    <line x1="2" y1="7" x2="7" y2="7"/>
                    <line x1="2" y1="17" x2="7" y2="17"/>
                    <line x1="17" y1="7" x2="22" y2="7"/>
                    <line x1="17" y1="17" x2="22" y2="17"/>
                </svg>
                {{ segments|length }} segments
            </div>
            {% if known_speaker %}
            <div class="transcript-meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                {{ known_speaker }}
            </div>
            {% endif %}
            {% if duration %}
            <div class="transcript-meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                {{ duration }}
            </div>
            {% endif %}
        </div>
    </div>
    <div class="transcript-actions">
        <button class="btn btn-secondary btn-sm" onclick="copyTranscript()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </svg>
            Copy
        </button>
        <button class="btn btn-purple btn-sm" onclick="identifySpeakers()" id="identifyBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            Identify Speakers
        </button>
    </div>
</div>

<!-- Speaker Legend -->
<div class="speaker-legend" id="speakerLegend" style="display: none;">
    <div class="speaker-legend-header">
        <span class="speaker-legend-title">Speakers</span>
        <button class="btn btn-sm btn-secondary" onclick="saveSpeakers()">Save Changes</button>
    </div>
    <div class="speaker-list" id="speakerList">
        <!-- Populated by JavaScript -->
    </div>
</div>

<div class="transcript-container">
    <div class="transcript-toolbar">
        <div class="transcript-search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
            </svg>
            <input type="text" class="input" placeholder="Search transcript..." id="searchInput" onkeyup="filterSegments()">
        </div>
        <div class="transcript-stats">
            <span id="segmentCount">{{ segments|length }} segments</span>
            <span id="matchCount" style="display: none;"></span>
        </div>
    </div>

    <div id="loadingBanner" class="identifying-speakers" style="display: none;">
        <div class="spinner"></div>
        <span>Analyzing transcript to identify speakers...</span>
    </div>

    <div class="segments-list" id="segmentsList">
        {% for seg in segments %}
        <div class="segment" data-id="{{ seg.id }}" data-text="{{ seg.text|lower }}">
            <div class="segment-speaker">
                {% if seg.speaker %}
                <span class="speaker-badge speaker-{{ loop.index % 8 + 1 }}" onclick="editSpeaker(this, {{ seg.id }})">
                    <span class="dot"></span>
                    {{ seg.speaker }}
                </span>
                {% else %}
                <span class="speaker-badge badge-neutral" onclick="editSpeaker(this, {{ seg.id }})">
                    <span class="dot"></span>
                    Unknown
                </span>
                {% endif %}
            </div>
            <div class="segment-content">
                <div class="segment-text">{{ seg.text }}</div>
                <div class="segment-time">
                    <span>{{ "%.1f"|format(seg.start) }}s â€” {{ "%.1f"|format(seg.end) }}s</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Speaker Edit Modal -->
<div class="modal-backdrop" id="speakerModal">
    <div class="modal" style="max-width: 320px;">
        <div class="modal-header">
            <h3 class="modal-title">Edit Speaker</h3>
            <button class="modal-close" onclick="closeSpeakerModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <input type="text" class="input" id="speakerInput" placeholder="Enter speaker name..." onkeydown="handleSpeakerInput(event)">
            <div id="speakerSuggestions" style="margin-top: 0.75rem;">
                <!-- Known speakers will be listed here -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeSpeakerModal()">Cancel</button>
            <button class="btn" onclick="saveSpeakerEdit()">Save</button>
        </div>
    </div>
</div>

<script>
const transcriptId = {{ transcript_id }};
let currentSegmentId = null;
let knownSpeakers = new Set();
let speakerColors = {};
let colorIndex = 1;

// Initialize speakers from segments
document.querySelectorAll('.speaker-badge').forEach(badge => {
    const speaker = badge.textContent.trim();
    if (speaker && speaker !== 'Unknown') {
        if (!speakerColors[speaker]) {
            speakerColors[speaker] = colorIndex++;
            if (colorIndex > 8) colorIndex = 1;
        }
        knownSpeakers.add(speaker);
    }
});

// Show legend if we have speakers
if (knownSpeakers.size > 0) {
    updateSpeakerLegend();
}

function updateSpeakerLegend() {
    const legend = document.getElementById('speakerLegend');
    const list = document.getElementById('speakerList');

    if (knownSpeakers.size === 0) {
        legend.style.display = 'none';
        return;
    }

    legend.style.display = 'block';

    // Count segments per speaker
    const counts = {};
    document.querySelectorAll('.speaker-badge').forEach(badge => {
        const speaker = badge.textContent.trim();
        counts[speaker] = (counts[speaker] || 0) + 1;
    });

    list.innerHTML = Array.from(knownSpeakers).map(speaker => `
        <div class="speaker-chip" onclick="renameSpeaker('${speaker}')">
            <span class="speaker-dot speaker-${speakerColors[speaker] || 1}"></span>
            <span>${speaker}</span>
            <span class="speaker-count">${counts[speaker] || 0}</span>
        </div>
    `).join('');
}

async function identifySpeakers() {
    const btn = document.getElementById('identifyBtn');
    const banner = document.getElementById('loadingBanner');

    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Analyzing...';
    banner.style.display = 'flex';

    try {
        const response = await fetch(`/api/transcripts/${transcriptId}/identify-speakers`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ known_speakers: Array.from(knownSpeakers) })
        });

        const data = await response.json();

        if (data.success) {
            // Update speaker legend
            data.speakers.forEach(s => {
                knownSpeakers.add(s.name);
                if (!speakerColors[s.name]) {
                    speakerColors[s.name] = colorIndex++;
                    if (colorIndex > 8) colorIndex = 1;
                }
            });

            updateSpeakerLegend();
            showToast(`Identified ${data.speakers.length} speaker(s)`, 'success');

            // Show speaker info
            if (data.speakers.length > 0) {
                const info = data.speakers.map(s => `${s.name}: ${s.description || 'No description'}`).join('\n');
                console.log('Speaker analysis:', info);
            }
        } else {
            showToast('Could not identify speakers', 'error');
        }
    } catch (err) {
        showToast('Error analyzing transcript', 'error');
        console.error(err);
    } finally {
        btn.disabled = false;
        btn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            Identify Speakers
        `;
        banner.style.display = 'none';
    }
}

function editSpeaker(badge, segmentId) {
    currentSegmentId = segmentId;
    const currentSpeaker = badge.textContent.trim();

    document.getElementById('speakerInput').value = currentSpeaker === 'Unknown' ? '' : currentSpeaker;

    // Show suggestions
    const suggestions = document.getElementById('speakerSuggestions');
    suggestions.innerHTML = Array.from(knownSpeakers).map(speaker => `
        <div class="speaker-dropdown-item" onclick="selectSpeaker('${speaker}')">
            <span class="speaker-dot speaker-${speakerColors[speaker] || 1}"></span>
            ${speaker}
        </div>
    `).join('');

    document.getElementById('speakerModal').classList.add('show');
    document.getElementById('speakerInput').focus();
}

function closeSpeakerModal() {
    document.getElementById('speakerModal').classList.remove('show');
    currentSegmentId = null;
}

function selectSpeaker(speaker) {
    document.getElementById('speakerInput').value = speaker;
    saveSpeakerEdit();
}

function handleSpeakerInput(e) {
    if (e.key === 'Enter') {
        saveSpeakerEdit();
    } else if (e.key === 'Escape') {
        closeSpeakerModal();
    }
}

async function saveSpeakerEdit() {
    const speaker = document.getElementById('speakerInput').value.trim();

    if (!currentSegmentId) return;

    try {
        const response = await fetch(`/api/segments/${currentSegmentId}/speaker`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ speaker })
        });

        if (response.ok) {
            // Update the badge
            const segment = document.querySelector(`.segment[data-id="${currentSegmentId}"]`);
            const badge = segment.querySelector('.speaker-badge');

            if (speaker) {
                if (!speakerColors[speaker]) {
                    speakerColors[speaker] = colorIndex++;
                    if (colorIndex > 8) colorIndex = 1;
                }
                knownSpeakers.add(speaker);
                badge.className = `speaker-badge speaker-${speakerColors[speaker]}`;
                badge.innerHTML = `<span class="dot"></span>${speaker}`;
            } else {
                badge.className = 'speaker-badge badge-neutral';
                badge.innerHTML = '<span class="dot"></span>Unknown';
            }

            updateSpeakerLegend();
            closeSpeakerModal();
            showToast('Speaker updated', 'success');
        }
    } catch (err) {
        showToast('Error updating speaker', 'error');
        console.error(err);
    }
}

function renameSpeaker(oldName) {
    const newName = prompt(`Rename "${oldName}" to:`, oldName);
    if (!newName || newName === oldName) return;

    // Update all badges with this speaker
    document.querySelectorAll('.speaker-badge').forEach(badge => {
        if (badge.textContent.trim() === oldName) {
            const segmentId = badge.closest('.segment').dataset.id;
            fetch(`/api/segments/${segmentId}/speaker`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ speaker: newName })
            });
            badge.innerHTML = `<span class="dot"></span>${newName}`;
        }
    });

    // Update tracking
    knownSpeakers.delete(oldName);
    knownSpeakers.add(newName);
    speakerColors[newName] = speakerColors[oldName];
    delete speakerColors[oldName];

    updateSpeakerLegend();
    showToast(`Renamed "${oldName}" to "${newName}"`, 'success');
}

function filterSegments() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const segments = document.querySelectorAll('.segment');
    let matchCount = 0;

    segments.forEach(seg => {
        const text = seg.dataset.text;
        const textEl = seg.querySelector('.segment-text');

        if (!query) {
            seg.style.display = 'flex';
            textEl.innerHTML = textEl.textContent;
            return;
        }

        if (text.includes(query)) {
            seg.style.display = 'flex';
            matchCount++;

            // Highlight matches
            const originalText = textEl.textContent;
            const regex = new RegExp(`(${query})`, 'gi');
            textEl.innerHTML = originalText.replace(regex, '<span class="highlight">$1</span>');
        } else {
            seg.style.display = 'none';
        }
    });

    const matchEl = document.getElementById('matchCount');
    if (query) {
        matchEl.style.display = 'inline';
        matchEl.textContent = `${matchCount} match${matchCount !== 1 ? 'es' : ''}`;
    } else {
        matchEl.style.display = 'none';
    }
}

function copyTranscript() {
    const segments = document.querySelectorAll('.segment');
    let text = '';

    segments.forEach(seg => {
        const speaker = seg.querySelector('.speaker-badge').textContent.trim();
        const content = seg.querySelector('.segment-text').textContent;
        text += `${speaker}: ${content}\n\n`;
    });

    navigator.clipboard.writeText(text).then(() => {
        showToast('Transcript copied to clipboard', 'success');
    });
}

function saveSpeakers() {
    showToast('All changes are saved automatically', 'info');
}
</script>
{% endblock %}
