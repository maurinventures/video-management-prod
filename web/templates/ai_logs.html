{% extends "base.html" %}

{% block title %}AI Logs - MV Internal{% endblock %}

{% block content %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .page-header h1 {
        margin: 0;
    }

    .page-subtitle {
        color: #888;
        font-size: 0.875rem;
        margin-left: 1rem;
    }

    .stats-row {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        padding: 1rem 1.25rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .stat-item {
        display: flex;
        flex-direction: column;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a1a1a;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #888;
        text-transform: uppercase;
    }

    .filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        align-items: center;
    }

    .filter-select {
        padding: 0.5rem 0.75rem;
        border: 1px solid #e5e4df;
        border-radius: 6px;
        background: white;
        font-size: 0.875rem;
        min-width: 140px;
    }

    .filter-select:focus {
        outline: none;
        border-color: #d97757;
    }

    .table-container {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .table-scroll {
        max-height: 60vh;
        overflow-y: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8125rem;
    }

    .data-table th {
        background: #f8f8f6;
        padding: 0.75rem 1rem;
        text-align: left;
        font-weight: 600;
        color: #666;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        border-bottom: 2px solid #e5e4df;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .data-table td {
        padding: 0.625rem 1rem;
        border-bottom: 1px solid #e5e4df;
        vertical-align: middle;
    }

    .data-table tbody tr {
        transition: background 0.15s;
        cursor: pointer;
    }

    .data-table tbody tr:hover {
        background: #faf9f7;
    }

    .data-table tr:last-child td {
        border-bottom: none;
    }

    .col-time {
        font-size: 0.75rem;
        color: #888;
        white-space: nowrap;
    }

    .col-prompt, .col-response {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #666;
        font-size: 0.75rem;
    }

    .col-meta {
        color: #888;
        font-size: 0.75rem;
        text-align: center;
    }

    .type-badge {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        border-radius: 1rem;
        font-size: 0.6875rem;
        font-weight: 500;
    }

    .type-chat { background: #dbeafe; color: #1e40af; }
    .type-regenerate_clip { background: #ede9fe; color: #5b21b6; }
    .type-regenerate_record { background: #fef3c7; color: #92400e; }
    .type-default { background: #f3f4f6; color: #6b7280; }

    .model-badge {
        font-family: 'SF Mono', Monaco, monospace;
        font-size: 0.6875rem;
        color: #666;
    }

    .status-ok {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.125rem 0.5rem;
        background: #dcfce7;
        color: #166534;
        border-radius: 1rem;
        font-size: 0.6875rem;
        font-weight: 500;
    }

    .status-ok::before {
        content: '';
        width: 6px;
        height: 6px;
        background: #22c55e;
        border-radius: 50%;
    }

    .status-error {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.125rem 0.5rem;
        background: #fee2e2;
        color: #991b1b;
        border-radius: 1rem;
        font-size: 0.6875rem;
        font-weight: 500;
    }

    .status-error::before {
        content: '';
        width: 6px;
        height: 6px;
        background: #ef4444;
        border-radius: 50%;
    }

    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-top: 1px solid #e5e4df;
        font-size: 0.8125rem;
        color: #888;
    }

    .pagination-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .table-footer {
        margin-top: 1rem;
        font-size: 0.8125rem;
        color: #888;
    }
</style>

<div class="page-header">
    <div style="display: flex; align-items: center;">
        <h1>AI Logs</h1>
        <span class="page-subtitle">Quality monitoring</span>
    </div>
    <button class="btn btn-secondary btn-sm" onclick="loadLogs()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 4v6h6M23 20v-6h-6"/>
            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
        </svg>
        Refresh
    </button>
</div>

<div class="stats-row">
    <div class="stat-item">
        <span class="stat-value" id="totalCalls">-</span>
        <span class="stat-label">Total Calls</span>
    </div>
    <div class="stat-item">
        <span class="stat-value" id="successRate">-</span>
        <span class="stat-label">Success Rate</span>
    </div>
    <div class="stat-item">
        <span class="stat-value" id="avgLatency">-</span>
        <span class="stat-label">Avg Latency</span>
    </div>
    <div class="stat-item">
        <span class="stat-value" id="totalTokens">-</span>
        <span class="stat-label">Total Tokens</span>
    </div>
</div>

<div class="filters">
    <select class="filter-select" id="filterType" onchange="loadLogs()">
        <option value="">All Types</option>
        <option value="chat">Chat</option>
        <option value="regenerate_clip">Regenerate Clip</option>
        <option value="regenerate_record">Regenerate Record</option>
    </select>
    <select class="filter-select" id="filterModel" onchange="loadLogs()">
        <option value="">All Models</option>
        <option value="claude">Claude</option>
        <option value="gpt">GPT</option>
    </select>
    <select class="filter-select" id="filterSuccess" onchange="loadLogs()">
        <option value="">All Status</option>
        <option value="1">Success</option>
        <option value="0">Failed</option>
    </select>
</div>

<div class="table-container">
    <div class="table-scroll">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Model</th>
                    <th>Prompt</th>
                    <th>Response</th>
                    <th style="text-align: center;">Clips</th>
                    <th style="text-align: center;">Latency</th>
                    <th style="text-align: center;">Tokens</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="logsTable">
                <tr>
                    <td colspan="9" style="text-align: center; padding: 2rem; color: #888;">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="pagination">
        <span id="paginationInfo">Loading...</span>
        <div class="pagination-buttons">
            <button class="btn btn-secondary btn-sm" id="prevBtn" onclick="prevPage()" disabled>Previous</button>
            <button class="btn btn-secondary btn-sm" id="nextBtn" onclick="nextPage()" disabled>Next</button>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal-backdrop" id="detailModal">
    <div class="modal" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title">Log Details</h3>
            <button class="modal-close" onclick="closeDetailModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body" id="detailContent"></div>
    </div>
</div>

<script>
let currentOffset = 0;
const limit = 50;
let totalLogs = 0;

async function loadLogs() {
    const type = document.getElementById('filterType').value;
    const model = document.getElementById('filterModel').value;
    const success = document.getElementById('filterSuccess').value;

    const params = new URLSearchParams({ limit, offset: currentOffset });
    if (type) params.append('request_type', type);
    if (model) params.append('model', model);
    if (success !== '') params.append('success', success);

    try {
        const res = await fetch(`/api/ai-logs?${params}`);
        const data = await res.json();
        totalLogs = data.total;
        renderLogs(data.logs);
        updatePagination(data);
        updateStats(data.logs);
    } catch (e) {
        document.getElementById('logsTable').innerHTML = `
            <tr><td colspan="9" style="text-align: center; padding: 2rem; color: #888;">Failed to load logs</td></tr>
        `;
    }
}

function renderLogs(logs) {
    const tbody = document.getElementById('logsTable');

    if (!logs || logs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #888;">No logs found</td></tr>`;
        return;
    }

    tbody.innerHTML = logs.map(log => `
        <tr onclick="showDetail('${log.id}')">
            <td class="col-time">${formatTime(log.created_at)}</td>
            <td><span class="type-badge type-${log.request_type || 'default'}">${log.request_type}</span></td>
            <td><span class="model-badge">${log.model.split('-').slice(0, 2).join('-')}</span></td>
            <td class="col-prompt" title="${escapeAttr(log.prompt)}">${escapeHtml(log.prompt || '-')}</td>
            <td class="col-response" title="${escapeAttr(log.response)}">${escapeHtml(log.response || '-')}</td>
            <td class="col-meta">${log.clips_generated || 0}</td>
            <td class="col-meta">${log.latency_ms ? log.latency_ms + 'ms' : '-'}</td>
            <td class="col-meta">${formatTokens(log.input_tokens, log.output_tokens)}</td>
            <td>${log.success ? '<span class="status-ok">OK</span>' : '<span class="status-error">Error</span>'}</td>
        </tr>
    `).join('');
}

function updateStats(logs) {
    const total = totalLogs;
    const successful = logs.filter(l => l.success).length;
    const latencies = logs.filter(l => l.latency_ms);
    const avgLatency = latencies.length > 0 ? Math.round(latencies.reduce((s, l) => s + l.latency_ms, 0) / latencies.length) : 0;
    const totalTokensUsed = logs.reduce((s, l) => s + (l.input_tokens || 0) + (l.output_tokens || 0), 0);

    document.getElementById('totalCalls').textContent = total.toLocaleString();
    document.getElementById('successRate').textContent = logs.length > 0 ? Math.round(successful / logs.length * 100) + '%' : '-';
    document.getElementById('avgLatency').textContent = avgLatency ? avgLatency + 'ms' : '-';
    document.getElementById('totalTokens').textContent = totalTokensUsed.toLocaleString();
}

function updatePagination(data) {
    const start = data.offset + 1;
    const end = Math.min(data.offset + data.logs.length, data.total);
    document.getElementById('paginationInfo').textContent = `${start}-${end} of ${data.total}`;
    document.getElementById('prevBtn').disabled = currentOffset === 0;
    document.getElementById('nextBtn').disabled = currentOffset + limit >= data.total;
}

function prevPage() { if (currentOffset > 0) { currentOffset -= limit; loadLogs(); } }
function nextPage() { if (currentOffset + limit < totalLogs) { currentOffset += limit; loadLogs(); } }

async function showDetail(logId) {
    try {
        const res = await fetch(`/api/ai-logs/${logId}`);
        const log = await res.json();

        document.getElementById('detailContent').innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <div><div style="font-size: 0.75rem; color: #888;">Type</div><div style="font-weight: 500;">${log.request_type}</div></div>
                <div><div style="font-size: 0.75rem; color: #888;">Model</div><div style="font-weight: 500;">${log.model}</div></div>
                <div><div style="font-size: 0.75rem; color: #888;">Latency</div><div style="font-weight: 500;">${log.latency_ms ? log.latency_ms + 'ms' : '-'}</div></div>
                <div><div style="font-size: 0.75rem; color: #888;">Status</div><div style="font-weight: 500;">${log.success ? 'Success' : 'Failed'}</div></div>
                <div><div style="font-size: 0.75rem; color: #888;">Input Tokens</div><div style="font-weight: 500;">${log.input_tokens?.toLocaleString() || '-'}</div></div>
                <div><div style="font-size: 0.75rem; color: #888;">Output Tokens</div><div style="font-weight: 500;">${log.output_tokens?.toLocaleString() || '-'}</div></div>
                <div><div style="font-size: 0.75rem; color: #888;">Clips</div><div style="font-weight: 500;">${log.clips_generated || 0}</div></div>
                <div><div style="font-size: 0.75rem; color: #888;">Time</div><div style="font-weight: 500;">${formatTime(log.created_at)}</div></div>
            </div>
            ${log.error_message ? `<div style="margin-bottom: 1rem;"><div style="font-size: 0.75rem; color: #888; margin-bottom: 0.5rem;">Error</div><div style="background: #fee2e2; padding: 0.75rem; border-radius: 6px; font-size: 0.8125rem;">${escapeHtml(log.error_message)}</div></div>` : ''}
            <div style="margin-bottom: 1rem;"><div style="font-size: 0.75rem; color: #888; margin-bottom: 0.5rem;">Prompt</div><div style="background: #f8f8f6; padding: 0.75rem; border-radius: 6px; font-family: monospace; font-size: 0.75rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap;">${escapeHtml(log.prompt || '-')}</div></div>
            <div><div style="font-size: 0.75rem; color: #888; margin-bottom: 0.5rem;">Response</div><div style="background: #f8f8f6; padding: 0.75rem; border-radius: 6px; font-family: monospace; font-size: 0.75rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap;">${escapeHtml(log.response || '-')}</div></div>
        `;
        document.getElementById('detailModal').classList.add('show');
    } catch (e) {
        showToast('Failed to load details', 'error');
    }
}

function closeDetailModal() { document.getElementById('detailModal').classList.remove('show'); }
function formatTime(iso) { return iso ? new Date(iso).toLocaleString() : '-'; }
function formatTokens(i, o) { const t = (i || 0) + (o || 0); return t ? t.toLocaleString() : '-'; }
function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
function escapeAttr(t) { return (t || '').replace(/"/g, '&quot;'); }

document.getElementById('detailModal').addEventListener('click', e => { if (e.target.id === 'detailModal') closeDetailModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetailModal(); });

loadLogs();
</script>
{% endblock %}
